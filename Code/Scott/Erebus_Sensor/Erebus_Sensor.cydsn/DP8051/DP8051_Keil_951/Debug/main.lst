C51 COMPILER V9.51   MAIN                                                                  05/18/2014 17:32:57 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\DP8051\DP8051_Keil_951\Debug\main.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Cypress\PSoC Creator\3.0\PSoC Creator\import\keil\pk51\9.51\C51\BIN\c51.exe 
                    -.\main.c NOIV LARGE MODDP2 OMF2 VB(1) PR(.\DP8051\DP8051_Keil_951\Debug\main.lst) CD DB NOIP OT(0,SIZE) DF(DEBUG) INCDIR
                    -(.,.\Generated_Source\PSoC3) OJ(.\DP8051\DP8051_Keil_951\Debug\main.obj)

line level    source

   1          /* ========================================
   2           *
   3           * Copyright YOUR COMPANY, THE YEAR
   4           * All Rights Reserved
   5           * UNPUBLISHED, LICENSED SOFTWARE.
   6           *
   7           * CONFIDENTIAL AND PROPRIETARY INFORMATION
   8           * WHICH IS THE PROPERTY OF your company.
   9           *
  10           * ========================================
  11          */
  12          
  13          #include "main.h"
  14          
  15          /* Globals */
  16          
  17          // Flash
  18          const uint8 CYCODE sample_block[SAMPLE_BLOCK_SIZE]; 
  19          const uint16 CYCODE current_sample_indices[PTR_ROWS * FLASH_ROW_LENGTH];
  20          const uint16 CYCODE master_sample_indices[MASTER_PTR_COUNT];
  21          const uint8 CYCODE mem_full_flash_flag;
  22          
  23          volatile uint16 pointer_head_index;
  24          volatile uint16 pointer_tail_index;
  25          volatile uint16 sample_head_index;
  26          volatile uint16 sample_tail_index;
  27          
  28          // Flags
  29          uint8 low_power_flag = 0;
  30          uint8 USB_waiting = 0;
  31          uint8 DataStart_waiting = 0;
  32          uint8 DataStop_waiting = 0;
  33          uint8 Sample_waiting = 0;
  34          uint8 BatteryCheck_waiting = 0;
  35          uint8 LowPowerBlink_waiting = 0;
  36          uint8 mem_full_flag = 0;
  37          
  38          // RTC
  39          uint8 sample_interval = 0;
  40          uint8 sample_enable = 0;
  41          
  42          // Analog
  43          uint8 sample_int_count = 0;
  44          uint8 sample_unit = 0;
  45          uint8 battery_check_count = 0;
  46          uint8 low_batt_blink_count = 0;
  47          
  48          int main()
  49          {
  50   1      
  51   1          /* Initialization*/
  52   1          pointer_head_index = master_sample_indices[HEAD_INDEX];
  53   1          pointer_tail_index = master_sample_indices[TAIL_INDEX];
C51 COMPILER V9.51   MAIN                                                                  05/18/2014 17:32:57 PAGE 2   

  54   1          sample_head_index = current_sample_indices[pointer_head_index];
  55   1          sample_tail_index = current_sample_indices[pointer_tail_index];
  56   1          
  57   1          // Start Components
  58   1          EEPROM_R_Start();
  59   1          RTC_Start();
  60   1          rtc_setup();
  61   1          LED_PWM_Start();
  62   1          LED_PWM_Sleep();
  63   1          ADC_Start();
  64   1          ADC_Sleep();
  65   1          ADC_MUX_Start();
  66   1          ADC_MUX_Select(SAMPLE_PIN);
  67   1          
  68   1          // Enable global interrupts
  69   1          CyGlobalIntEnable;
  70   1          
  71   1          // Enable individual interrupts as necessary   
  72   1          Vbus_IRQ_Start();
  73   1          StartCollection_IRQ_Start();
  74   1          
  75   1          mem_full_flag = mem_full_flash_flag;
  76   1          if (mem_full_flag){
  77   2              memory_full();
  78   2          }
  79   1          
  80   1          for(;;){       
  81   2      
  82   2              if (Sample_waiting){
  83   3                  LED_on(BLUE);
  84   3                  take_sample();          
  85   3                  CyDelay(LED_DELAY);
  86   3                  LED_off();
  87   3                  Sample_waiting = 0;
  88   3              }
  89   2               
  90   2              if(DataStart_waiting){
  91   3                  LED_on(GREEN);
  92   3                  clear_buttons();            
  93   3                  StartCollection();
  94   3                  CyDelay(LED_DELAY);
  95   3                  LED_off();
  96   3              }
  97   2              
  98   2              if(DataStop_waiting){
  99   3                  LED_on(RED);            
 100   3                  clear_buttons();            
 101   3                  StopCollection();           
 102   3                  CyDelay(LED_DELAY);
 103   3                  LED_off();
 104   3              }
 105   2              
 106   2              if(USB_waiting){
 107   3                  LED_PWM_Wakeup();
 108   3                  LED_on(CYAN);
 109   3                  usb_prep();
 110   3                  Run_USB();
 111   3                  usb_exit();
 112   3                  clear_vbus();
 113   3                  LED_off();
 114   3              }        
 115   2              
C51 COMPILER V9.51   MAIN                                                                  05/18/2014 17:32:57 PAGE 3   

 116   2              if (BatteryCheck_waiting){
 117   3                  check_battery();
 118   3                  BatteryCheck_waiting = 0;
 119   3              }
 120   2              
 121   2              if(LowPowerBlink_waiting){
 122   3                  LED_PWM_Wakeup();
 123   3                  LED_on(YELLOW);
 124   3                  CyDelay(LOWBATT_BLINK_DELAY);
 125   3                  LED_off();
 126   3                  LowPowerBlink_waiting = 0;
 127   3              }
 128   2                      
 129   2              #ifdef SLEEP_EN 
 130   2              RTC_DisableInt();
 131   2              CyPmSaveClocks();        
 132   2            
 133   2              CyPmSleep(PM_SLEEP_TIME_NONE, (PM_SLEEP_SRC_ONE_PPS | PM_SLEEP_SRC_PICU));     
 134   2      
 135   2              CyPmRestoreClocks(); 
 136   2              RTC_EnableInt();
 137   2      
 138   2              #endif
 139   2             
 140   2          }
 141   1          
 142   1          return (0);
 143   1      }
 144          
 145          /* [] END OF FILE */
C51 COMPILER V9.51   MAIN                                                                  05/18/2014 17:32:57 PAGE 4   

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION main (BEGIN)
                                           ; SOURCE LINE # 48
                                           ; SOURCE LINE # 49
                                           ; SOURCE LINE # 52
0000 900000      R     MOV     DPTR,#master_sample_indices
0003 E4                CLR     A
0004 93                MOVC    A,@A+DPTR
0005 FE                MOV     R6,A
0006 7401              MOV     A,#01H
0008 93                MOVC    A,@A+DPTR
0009 FF                MOV     R7,A
000A 900000      R     MOV     DPTR,#pointer_head_index
000D EE                MOV     A,R6
000E F0                MOVX    @DPTR,A
000F A3                INC     DPTR
0010 EF                MOV     A,R7
0011 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 53
0012 900000      R     MOV     DPTR,#master_sample_indices+02H
0015 E4                CLR     A
0016 93                MOVC    A,@A+DPTR
0017 FE                MOV     R6,A
0018 7401              MOV     A,#01H
001A 93                MOVC    A,@A+DPTR
001B FF                MOV     R7,A
001C 900000      R     MOV     DPTR,#pointer_tail_index
001F EE                MOV     A,R6
0020 F0                MOVX    @DPTR,A
0021 A3                INC     DPTR
0022 EF                MOV     A,R7
0023 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 54
0024 900000      R     MOV     DPTR,#pointer_head_index
0027 E0                MOVX    A,@DPTR
0028 FE                MOV     R6,A
0029 A3                INC     DPTR
002A E0                MOVX    A,@DPTR
002B FF                MOV     R7,A
002C EF                MOV     A,R7
002D 25E0              ADD     A,ACC
002F FF                MOV     R7,A
0030 EE                MOV     A,R6
0031 33                RLC     A
0032 FE                MOV     R6,A
0033 7400        R     MOV     A,#LOW current_sample_indices
0035 2F                ADD     A,R7
0036 F582              MOV     DPL,A
0038 7400        R     MOV     A,#HIGH current_sample_indices
003A 3E                ADDC    A,R6
003B F583              MOV     DPH,A
003D E4                CLR     A
003E 93                MOVC    A,@A+DPTR
003F FE                MOV     R6,A
0040 7401              MOV     A,#01H
0042 93                MOVC    A,@A+DPTR
0043 FF                MOV     R7,A
0044 900000      R     MOV     DPTR,#sample_head_index
0047 EE                MOV     A,R6
0048 F0                MOVX    @DPTR,A
C51 COMPILER V9.51   MAIN                                                                  05/18/2014 17:32:57 PAGE 5   

0049 A3                INC     DPTR
004A EF                MOV     A,R7
004B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 55
004C 900000      R     MOV     DPTR,#pointer_tail_index
004F E0                MOVX    A,@DPTR
0050 FE                MOV     R6,A
0051 A3                INC     DPTR
0052 E0                MOVX    A,@DPTR
0053 FF                MOV     R7,A
0054 EF                MOV     A,R7
0055 25E0              ADD     A,ACC
0057 FF                MOV     R7,A
0058 EE                MOV     A,R6
0059 33                RLC     A
005A FE                MOV     R6,A
005B 7400        R     MOV     A,#LOW current_sample_indices
005D 2F                ADD     A,R7
005E F582              MOV     DPL,A
0060 7400        R     MOV     A,#HIGH current_sample_indices
0062 3E                ADDC    A,R6
0063 F583              MOV     DPH,A
0065 E4                CLR     A
0066 93                MOVC    A,@A+DPTR
0067 FE                MOV     R6,A
0068 7401              MOV     A,#01H
006A 93                MOVC    A,@A+DPTR
006B FF                MOV     R7,A
006C 900000      R     MOV     DPTR,#sample_tail_index
006F EE                MOV     A,R6
0070 F0                MOVX    @DPTR,A
0071 A3                INC     DPTR
0072 EF                MOV     A,R7
0073 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 58
0074 120000      E     LCALL   EEPROM_R_Start
                                           ; SOURCE LINE # 59
0077 120000      E     LCALL   RTC_Start
                                           ; SOURCE LINE # 60
007A 120000      E     LCALL   rtc_setup
                                           ; SOURCE LINE # 61
007D 120000      E     LCALL   LED_PWM_Start
                                           ; SOURCE LINE # 62
0080 120000      E     LCALL   LED_PWM_Sleep
                                           ; SOURCE LINE # 63
0083 120000      E     LCALL   ADC_Start
                                           ; SOURCE LINE # 64
0086 120000      E     LCALL   ADC_Sleep
                                           ; SOURCE LINE # 65
0089 120000      E     LCALL   ADC_MUX_Start
                                           ; SOURCE LINE # 66
008C 7F00              MOV     R7,#00H
008E 120000      E     LCALL   _ADC_MUX_FastSelect
                                           ; SOURCE LINE # 69
0091 D2AF              SETB    EA
0093 9044F4            MOV     DPTR,#044F4H
0096 74FD              MOV     A,#0FDH
0098 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 72
0099 120000      E     LCALL   Vbus_IRQ_Start
                                           ; SOURCE LINE # 73
009C 120000      E     LCALL   StartCollection_IRQ_Start
C51 COMPILER V9.51   MAIN                                                                  05/18/2014 17:32:57 PAGE 6   

                                           ; SOURCE LINE # 75
009F 900000      R     MOV     DPTR,#mem_full_flash_flag
00A2 E4                CLR     A
00A3 93                MOVC    A,@A+DPTR
00A4 FF                MOV     R7,A
00A5 900000      R     MOV     DPTR,#mem_full_flag
00A8 EF                MOV     A,R7
00A9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 76
00AA 900000      R     MOV     DPTR,#mem_full_flag
00AD E0                MOVX    A,@DPTR
00AE FF                MOV     R7,A
00AF EF                MOV     A,R7
00B0 6003              JZ      ?C0002
                                           ; SOURCE LINE # 77
00B2 120000      E     LCALL   memory_full
                                           ; SOURCE LINE # 78
00B5         ?C0001:
                                           ; SOURCE LINE # 80
00B5         ?C0002:
                                           ; SOURCE LINE # 82
00B5 900000      R     MOV     DPTR,#Sample_waiting
00B8 E0                MOVX    A,@DPTR
00B9 FF                MOV     R7,A
00BA EF                MOV     A,R7
00BB 601B              JZ      ?C0004
                                           ; SOURCE LINE # 83
00BD 7F02              MOV     R7,#02H
00BF 120000      E     LCALL   _LED_on
                                           ; SOURCE LINE # 84
00C2 120000      E     LCALL   take_sample
                                           ; SOURCE LINE # 85
00C5 7F19              MOV     R7,#019H
00C7 7E00              MOV     R6,#00H
00C9 7D00              MOV     R5,#00H
00CB 7C00              MOV     R4,#00H
00CD 120000      E     LCALL   _?CyDelay
                                           ; SOURCE LINE # 86
00D0 120000      E     LCALL   LED_off
                                           ; SOURCE LINE # 87
00D3 900000      R     MOV     DPTR,#Sample_waiting
00D6 E4                CLR     A
00D7 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 88
00D8         ?C0004:
                                           ; SOURCE LINE # 90
00D8 900000      R     MOV     DPTR,#DataStart_waiting
00DB E0                MOVX    A,@DPTR
00DC FF                MOV     R7,A
00DD EF                MOV     A,R7
00DE 6019              JZ      ?C0005
                                           ; SOURCE LINE # 91
00E0 7F04              MOV     R7,#04H
00E2 120000      E     LCALL   _LED_on
                                           ; SOURCE LINE # 92
00E5 120000      E     LCALL   clear_buttons
                                           ; SOURCE LINE # 93
00E8 120000      E     LCALL   StartCollection
                                           ; SOURCE LINE # 94
00EB 7F19              MOV     R7,#019H
00ED 7E00              MOV     R6,#00H
00EF 7D00              MOV     R5,#00H
C51 COMPILER V9.51   MAIN                                                                  05/18/2014 17:32:57 PAGE 7   

00F1 7C00              MOV     R4,#00H
00F3 120000      E     LCALL   _?CyDelay
                                           ; SOURCE LINE # 95
00F6 120000      E     LCALL   LED_off
                                           ; SOURCE LINE # 96
00F9         ?C0005:
                                           ; SOURCE LINE # 98
00F9 900000      R     MOV     DPTR,#DataStop_waiting
00FC E0                MOVX    A,@DPTR
00FD FF                MOV     R7,A
00FE EF                MOV     A,R7
00FF 6019              JZ      ?C0006
                                           ; SOURCE LINE # 99
0101 7F01              MOV     R7,#01H
0103 120000      E     LCALL   _LED_on
                                           ; SOURCE LINE # 100
0106 120000      E     LCALL   clear_buttons
                                           ; SOURCE LINE # 101
0109 120000      E     LCALL   StopCollection
                                           ; SOURCE LINE # 102
010C 7F19              MOV     R7,#019H
010E 7E00              MOV     R6,#00H
0110 7D00              MOV     R5,#00H
0112 7C00              MOV     R4,#00H
0114 120000      E     LCALL   _?CyDelay
                                           ; SOURCE LINE # 103
0117 120000      E     LCALL   LED_off
                                           ; SOURCE LINE # 104
011A         ?C0006:
                                           ; SOURCE LINE # 106
011A 900000      R     MOV     DPTR,#USB_waiting
011D E0                MOVX    A,@DPTR
011E FF                MOV     R7,A
011F EF                MOV     A,R7
0120 6017              JZ      ?C0007
                                           ; SOURCE LINE # 107
0122 120000      E     LCALL   LED_PWM_Wakeup
                                           ; SOURCE LINE # 108
0125 7F06              MOV     R7,#06H
0127 120000      E     LCALL   _LED_on
                                           ; SOURCE LINE # 109
012A 120000      E     LCALL   usb_prep
                                           ; SOURCE LINE # 110
012D 120000      E     LCALL   Run_USB
                                           ; SOURCE LINE # 111
0130 120000      E     LCALL   usb_exit
                                           ; SOURCE LINE # 112
0133 120000      E     LCALL   clear_vbus
                                           ; SOURCE LINE # 113
0136 120000      E     LCALL   LED_off
                                           ; SOURCE LINE # 114
0139         ?C0007:
                                           ; SOURCE LINE # 116
0139 900000      R     MOV     DPTR,#BatteryCheck_waiting
013C E0                MOVX    A,@DPTR
013D FF                MOV     R7,A
013E EF                MOV     A,R7
013F 6008              JZ      ?C0008
                                           ; SOURCE LINE # 117
0141 120000      E     LCALL   check_battery
                                           ; SOURCE LINE # 118
0144 900000      R     MOV     DPTR,#BatteryCheck_waiting
C51 COMPILER V9.51   MAIN                                                                  05/18/2014 17:32:57 PAGE 8   

0147 E4                CLR     A
0148 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 119
0149         ?C0008:
                                           ; SOURCE LINE # 121
0149 900000      R     MOV     DPTR,#LowPowerBlink_waiting
014C E0                MOVX    A,@DPTR
014D FF                MOV     R7,A
014E EF                MOV     A,R7
014F 601B              JZ      ?C0009
                                           ; SOURCE LINE # 122
0151 120000      E     LCALL   LED_PWM_Wakeup
                                           ; SOURCE LINE # 123
0154 7F05              MOV     R7,#05H
0156 120000      E     LCALL   _LED_on
                                           ; SOURCE LINE # 124
0159 7F64              MOV     R7,#064H
015B 7E00              MOV     R6,#00H
015D 7D00              MOV     R5,#00H
015F 7C00              MOV     R4,#00H
0161 120000      E     LCALL   _?CyDelay
                                           ; SOURCE LINE # 125
0164 120000      E     LCALL   LED_off
                                           ; SOURCE LINE # 126
0167 900000      R     MOV     DPTR,#LowPowerBlink_waiting
016A E4                CLR     A
016B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 127
016C         ?C0009:
                                           ; SOURCE LINE # 130
016C 120000      E     LCALL   RTC_DisableInt
                                           ; SOURCE LINE # 131
016F 120000      E     LCALL   CyPmSaveClocks
                                           ; SOURCE LINE # 133
0172 7D40              MOV     R5,#040H
0174 7C08              MOV     R4,#08H
0176 7F00              MOV     R7,#00H
0178 120000      E     LCALL   _CyPmSleep
                                           ; SOURCE LINE # 135
017B 120000      E     LCALL   CyPmRestoreClocks
                                           ; SOURCE LINE # 136
017E 120000      E     LCALL   RTC_EnableInt
                                           ; SOURCE LINE # 140
0181 020000      R     LJMP    ?C0002
0184         ?C0003:
                                           ; SOURCE LINE # 142
0184 E4                CLR     A
0185 7E00              MOV     R6,#00H
0187 7F00              MOV     R7,#00H
                                           ; SOURCE LINE # 143
0189         ?C0010:
0189 22                RET     
             ; FUNCTION main (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    394    ----
   CONSTANT SIZE    =   2629    ----
   XDATA SIZE       =     22    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
C51 COMPILER V9.51   MAIN                                                                  05/18/2014 17:32:57 PAGE 9   

   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
