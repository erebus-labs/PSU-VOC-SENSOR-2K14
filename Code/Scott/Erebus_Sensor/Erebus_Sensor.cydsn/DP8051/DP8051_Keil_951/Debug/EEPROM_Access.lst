C51 COMPILER V9.51   EEPROM_ACCESS                                                         03/27/2014 17:30:56 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE EEPROM_ACCESS
OBJECT MODULE PLACED IN .\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Cypress\PSoC Creator\3.0\PSoC Creator\import\keil\pk51\9.51\C51\BIN\c51.exe 
                    -.\EEPROM_Access.c NOIV LARGE MODDP2 OMF2 VB(1) PR(.\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.lst) CD DB NOIP OT(2,SIZE
                    -) DF(DEBUG) INCDIR(.,.\Generated_Source\PSoC3) OJ(.\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.obj)

line level    source

   1          /* ========================================
   2           *
   3           * Copyright YOUR COMPANY, THE YEAR
   4           * All Rights Reserved
   5           * UNPUBLISHED, LICENSED SOFTWARE.
   6           *
   7           * CONFIDENTIAL AND PROPRIETARY INFORMATION
   8           * WHICH IS THE PROPERTY OF your company.
   9           *
  10           * ========================================
  11          */
  12          
  13          #include "EEPROM_Access.h"
  14          
  15          void update_variable(uint16 index, uint16 value){
  16   1          uint8* buffer;
  17   1          float rows_used = 0;
  18   1          uint16 remainder = 0;
  19   1          uint8* src_ptr;
  20   1          uint8* dst_ptr;
  21   1          uint8 i = 0; // loop var
  22   1          cystatus status;
  23   1          
  24   1          float bytes_used = EEPROM_BYTES_USED;
  25   1          
  26   1          // Allocate array to hold EEPROM variables
  27   1          
  28   1          rows_used = ceil(bytes_used/16);
  29   1          buffer = malloc(((uint16) rows_used) * 16);
  30   1          dst_ptr = buffer;
  31   1          remainder = (rows_used * 16) - EEPROM_BYTES_USED;
  32   1          
  33   1          // Copy all variables into RAM
  34   1          for (i=0; i<EEPROM_BYTES_USED; ++i){
  35   2              *dst_ptr = CY_GET_REG8(CYDEV_EE_BASE + i);
  36   2              ++dst_ptr;
  37   2          }
  38   1          
  39   1          // Fill remainder of buffer with zeros
  40   1          while (i < remainder){
  41   2              *dst_ptr = 0;
  42   2              ++i;
  43   2          }
  44   1          
  45   1          // Modify variable in RAM
  46   1          buffer[index] = (uint8) value >> 0x8;
  47   1          buffer[index+1] = (uint8) value & 0xFF;
  48   1          
  49   1          // Erase EEPROM
  50   1          status = EEPROM_R_EraseSector(SECTOR_NUMBER);
  51   1          
  52   1          // Write back modified EEPROM Variables
  53   1          i = 0;
C51 COMPILER V9.51   EEPROM_ACCESS                                                         03/27/2014 17:30:56 PAGE 2   

  54   1          src_ptr = buffer;
  55   1          while ((i < rows_used) && (i < EEPROM_ROWS)){
  56   2              EEPROM_R_Write(src_ptr, i);
  57   2              src_ptr = src_ptr + CYDEV_EEPROM_ROW_SIZE;
  58   2              ++i;
  59   2          }
  60   1           
  61   1          // Free buffer memory
  62   1          free(buffer);
  63   1          
  64   1          return;   
  65   1      }
  66          
  67          uint16 get_variable(uint16 var_index){
  68   1          uint16 value = 10;
  69   1              
  70   1          value = ((uint16) CY_GET_REG8(CYDEV_EE_BASE + var_index)) << 8;
  71   1          value = value | CY_GET_REG8(CYDEV_EE_BASE + var_index + 1);
  72   1          
  73   1          return value;
  74   1      }
  75          
  76          
  77          /* [] END OF FILE */
C51 COMPILER V9.51   EEPROM_ACCESS                                                         03/27/2014 17:30:56 PAGE 3   

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION _update_variable (BEGIN)
                                           ; SOURCE LINE # 15
0000 900000      R     MOV     DPTR,#index
0003 EE                MOV     A,R6
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EF                MOV     A,R7
0007 F0                MOVX    @DPTR,A
0008 900000      R     MOV     DPTR,#value
000B EC                MOV     A,R4
000C F0                MOVX    @DPTR,A
000D A3                INC     DPTR
000E ED                MOV     A,R5
000F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 17
0010 7F00              MOV     R7,#00H
0012 7E00              MOV     R6,#00H
0014 7D00              MOV     R5,#00H
0016 7C00              MOV     R4,#00H
0018 900000      R     MOV     DPTR,#rows_used
001B 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 18
001E 900000      R     MOV     DPTR,#remainder
0021 E4                CLR     A
0022 F0                MOVX    @DPTR,A
0023 A3                INC     DPTR
0024 E4                CLR     A
0025 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 21
0026 900000      R     MOV     DPTR,#i
0029 E4                CLR     A
002A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 24
002B 7F00              MOV     R7,#00H
002D 7E00              MOV     R6,#00H
002F 7D00              MOV     R5,#00H
0031 7C40              MOV     R4,#040H
0033 900000      R     MOV     DPTR,#bytes_used
0036 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 28
0039 7B00              MOV     R3,#00H
003B 7A00              MOV     R2,#00H
003D 7980              MOV     R1,#080H
003F 7841              MOV     R0,#041H
0041 900000      R     MOV     DPTR,#bytes_used
0044 120000      E     LCALL   ?C?LLDXDATA
0047 120000      E     LCALL   ?C?FPDIV
004A 120000      E     LCALL   _ceil
004D 900000      R     MOV     DPTR,#rows_used
0050 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 29
0053 900000      R     MOV     DPTR,#rows_used
0056 120000      E     LCALL   ?C?LLDXDATA
0059 120000      E     LCALL   ?C?CASTF
005C EF                MOV     A,R7
005D C4                SWAP    A
005E F8                MOV     R0,A
005F 540F              ANL     A,#0FH
0061 C8                XCH     A,R0
C51 COMPILER V9.51   EEPROM_ACCESS                                                         03/27/2014 17:30:56 PAGE 4   

0062 68                XRL     A,R0
0063 FF                MOV     R7,A
0064 EE                MOV     A,R6
0065 C4                SWAP    A
0066 54F0              ANL     A,#0F0H
0068 48                ORL     A,R0
0069 FE                MOV     R6,A
006A 120000      E     LCALL   _malloc
006D AA06              MOV     R2,AR6
006F A907              MOV     R1,AR7
0071 7B01              MOV     R3,#01H
0073 900000      R     MOV     DPTR,#buffer
0076 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 30
0079 900000      R     MOV     DPTR,#buffer
007C 120000      E     LCALL   ?C?PLDXDATA
007F 900000      R     MOV     DPTR,#dst_ptr
0082 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 31
0085 7F00              MOV     R7,#00H
0087 7E00              MOV     R6,#00H
0089 7D80              MOV     R5,#080H
008B 7C41              MOV     R4,#041H
008D 900000      R     MOV     DPTR,#rows_used
0090 120000      E     LCALL   ?C?LLDXDATA0
0093 120000      E     LCALL   ?C?FPMUL
0096 7B00              MOV     R3,#00H
0098 7A00              MOV     R2,#00H
009A 7900              MOV     R1,#00H
009C 7840              MOV     R0,#040H
009E 120000      E     LCALL   ?C?FPADD
00A1 120000      E     LCALL   ?C?CASTF
00A4 900000      R     MOV     DPTR,#remainder
00A7 EE                MOV     A,R6
00A8 F0                MOVX    @DPTR,A
00A9 A3                INC     DPTR
00AA EF                MOV     A,R7
00AB F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 34
00AC 900000      R     MOV     DPTR,#i
00AF E4                CLR     A
00B0 F0                MOVX    @DPTR,A
00B1         ?C0001:
00B1 900000      R     MOV     DPTR,#i
00B4 E0                MOVX    A,@DPTR
00B5 FF                MOV     R7,A
00B6 EF                MOV     A,R7
00B7 C3                CLR     C
00B8 9402              SUBB    A,#02H
00BA 5031              JNC     ?C0004
                                           ; SOURCE LINE # 35
00BC 900000      R     MOV     DPTR,#i
00BF E0                MOVX    A,@DPTR
00C0 FF                MOV     R7,A
00C1 7E00              MOV     R6,#00H
00C3 EF                MOV     A,R7
00C4 2400              ADD     A,#00H
00C6 FF                MOV     R7,A
00C7 EE                MOV     A,R6
00C8 3480              ADDC    A,#080H
00CA FE                MOV     R6,A
00CB 8F82              MOV     DPL,R7
C51 COMPILER V9.51   EEPROM_ACCESS                                                         03/27/2014 17:30:56 PAGE 5   

00CD 8E83              MOV     DPH,R6
00CF E0                MOVX    A,@DPTR
00D0 FF                MOV     R7,A
00D1 900000      R     MOV     DPTR,#dst_ptr
00D4 120000      E     LCALL   ?C?PLDXDATA
00D7 EF                MOV     A,R7
00D8 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 36
00DB 900000      R     MOV     DPTR,#dst_ptr+01H
00DE E4                CLR     A
00DF 75F001            MOV     B,#01H
00E2 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 37
00E5 900000      R     MOV     DPTR,#i
00E8 E0                MOVX    A,@DPTR
00E9 04                INC     A
00EA F0                MOVX    @DPTR,A
00EB 80C4              SJMP    ?C0001
00ED         ?C0004:
                                           ; SOURCE LINE # 40
00ED 900000      R     MOV     DPTR,#i
00F0 E0                MOVX    A,@DPTR
00F1 FF                MOV     R7,A
00F2 7E00              MOV     R6,#00H
00F4 900000      R     MOV     DPTR,#remainder
00F7 E0                MOVX    A,@DPTR
00F8 FC                MOV     R4,A
00F9 A3                INC     DPTR
00FA E0                MOVX    A,@DPTR
00FB FD                MOV     R5,A
00FC C3                CLR     C
00FD EF                MOV     A,R7
00FE 9D                SUBB    A,R5
00FF EE                MOV     A,R6
0100 9C                SUBB    A,R4
0101 5012              JNC     ?C0005
                                           ; SOURCE LINE # 41
0103 900000      R     MOV     DPTR,#dst_ptr
0106 120000      E     LCALL   ?C?PLDXDATA
0109 E4                CLR     A
010A 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 42
010D 900000      R     MOV     DPTR,#i
0110 E0                MOVX    A,@DPTR
0111 04                INC     A
0112 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 43
0113 80D8              SJMP    ?C0004
0115         ?C0005:
                                           ; SOURCE LINE # 46
0115 900000      R     MOV     DPTR,#value
0118 E0                MOVX    A,@DPTR
0119 FE                MOV     R6,A
011A A3                INC     DPTR
011B E0                MOVX    A,@DPTR
011C FF                MOV     R7,A
011D 7F00              MOV     R7,#00H
011F 900000      R     MOV     DPTR,#buffer
0122 120000      E     LCALL   ?C?PLDXDATA
0125 900000      R     MOV     DPTR,#index
0128 E0                MOVX    A,@DPTR
0129 FC                MOV     R4,A
C51 COMPILER V9.51   EEPROM_ACCESS                                                         03/27/2014 17:30:56 PAGE 6   

012A A3                INC     DPTR
012B E0                MOVX    A,@DPTR
012C FD                MOV     R5,A
012D E9                MOV     A,R1
012E 2D                ADD     A,R5
012F F9                MOV     R1,A
0130 EA                MOV     A,R2
0131 3C                ADDC    A,R4
0132 FA                MOV     R2,A
0133 EF                MOV     A,R7
0134 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 47
0137 900000      R     MOV     DPTR,#value
013A E0                MOVX    A,@DPTR
013B FE                MOV     R6,A
013C A3                INC     DPTR
013D E0                MOVX    A,@DPTR
013E FF                MOV     R7,A
013F EF                MOV     A,R7
0140 54FF              ANL     A,#0FFH
0142 FF                MOV     R7,A
0143 900000      R     MOV     DPTR,#buffer
0146 120000      E     LCALL   ?C?PLDXDATA
0149 900000      R     MOV     DPTR,#index
014C E0                MOVX    A,@DPTR
014D FC                MOV     R4,A
014E A3                INC     DPTR
014F E0                MOVX    A,@DPTR
0150 FD                MOV     R5,A
0151 ED                MOV     A,R5
0152 2401              ADD     A,#01H
0154 FD                MOV     R5,A
0155 EC                MOV     A,R4
0156 3400              ADDC    A,#00H
0158 FC                MOV     R4,A
0159 E9                MOV     A,R1
015A 2D                ADD     A,R5
015B F9                MOV     R1,A
015C EA                MOV     A,R2
015D 3C                ADDC    A,R4
015E FA                MOV     R2,A
015F EF                MOV     A,R7
0160 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 50
0163 7F00              MOV     R7,#00H
0165 120000      E     LCALL   _EEPROM_R_EraseSector
0168 900000      R     MOV     DPTR,#status
016B EF                MOV     A,R7
016C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 53
016D 900000      R     MOV     DPTR,#i
0170 E4                CLR     A
0171 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 54
0172 900000      R     MOV     DPTR,#buffer
0175 120000      E     LCALL   ?C?PLDXDATA
0178 900000      R     MOV     DPTR,#src_ptr
017B 120000      E     LCALL   ?C?PSTXDATA
017E         ?C0006:
                                           ; SOURCE LINE # 55
017E 900000      R     MOV     DPTR,#i
0181 E0                MOVX    A,@DPTR
C51 COMPILER V9.51   EEPROM_ACCESS                                                         03/27/2014 17:30:56 PAGE 7   

0182 FC                MOV     R4,A
0183 E4                CLR     A
0184 120000      E     LCALL   ?C?FCASTC
0187 900000      R     MOV     DPTR,#rows_used
018A 120000      E     LCALL   ?C?LLDXDATA0
018D 120000      E     LCALL   ?C?FPCMP3
0190 602D              JZ      ?C0007
0192 402B              JC      ?C0007
0194 900000      R     MOV     DPTR,#i
0197 E0                MOVX    A,@DPTR
0198 FF                MOV     R7,A
0199 EF                MOV     A,R7
019A C3                CLR     C
019B 9480              SUBB    A,#080H
019D 5020              JNC     ?C0007
                                           ; SOURCE LINE # 56
019F 900000      R     MOV     DPTR,#src_ptr
01A2 120000      E     LCALL   ?C?PLDXDATA
01A5 900000      R     MOV     DPTR,#i
01A8 E0                MOVX    A,@DPTR
01A9 FD                MOV     R5,A
01AA 120000      E     LCALL   _EEPROM_R_Write
                                           ; SOURCE LINE # 57
01AD 900000      R     MOV     DPTR,#src_ptr+01H
01B0 E4                CLR     A
01B1 75F010            MOV     B,#010H
01B4 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 58
01B7 900000      R     MOV     DPTR,#i
01BA E0                MOVX    A,@DPTR
01BB 04                INC     A
01BC F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 59
01BD 80BF              SJMP    ?C0006
01BF         ?C0007:
                                           ; SOURCE LINE # 62
01BF 900000      R     MOV     DPTR,#buffer
01C2 120000      E     LCALL   ?C?PLDXDATA
01C5 AE02              MOV     R6,AR2
01C7 AF01              MOV     R7,AR1
01C9 120000      E     LCALL   _free
                                           ; SOURCE LINE # 65
01CC         ?C0008:
01CC 22                RET     
             ; FUNCTION _update_variable (END)

             ; FUNCTION _get_variable (BEGIN)
                                           ; SOURCE LINE # 67
0000 900000      R     MOV     DPTR,#var_index
0003 EE                MOV     A,R6
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EF                MOV     A,R7
0007 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 68
0008 900000      R     MOV     DPTR,#value
000B E4                CLR     A
000C F0                MOVX    @DPTR,A
000D A3                INC     DPTR
000E 740A              MOV     A,#0AH
0010 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 70
C51 COMPILER V9.51   EEPROM_ACCESS                                                         03/27/2014 17:30:56 PAGE 8   

0011 900000      R     MOV     DPTR,#var_index
0014 E0                MOVX    A,@DPTR
0015 FE                MOV     R6,A
0016 A3                INC     DPTR
0017 E0                MOVX    A,@DPTR
0018 FF                MOV     R7,A
0019 EF                MOV     A,R7
001A 2400              ADD     A,#00H
001C FF                MOV     R7,A
001D EE                MOV     A,R6
001E 3480              ADDC    A,#080H
0020 FE                MOV     R6,A
0021 8F82              MOV     DPL,R7
0023 8E83              MOV     DPH,R6
0025 E0                MOVX    A,@DPTR
0026 FF                MOV     R7,A
0027 7E00              MOV     R6,#00H
0029 EF                MOV     A,R7
002A 7F00              MOV     R7,#00H
002C FE                MOV     R6,A
002D 900000      R     MOV     DPTR,#value
0030 EE                MOV     A,R6
0031 F0                MOVX    @DPTR,A
0032 A3                INC     DPTR
0033 EF                MOV     A,R7
0034 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 71
0035 900000      R     MOV     DPTR,#var_index
0038 E0                MOVX    A,@DPTR
0039 FE                MOV     R6,A
003A A3                INC     DPTR
003B E0                MOVX    A,@DPTR
003C FF                MOV     R7,A
003D EF                MOV     A,R7
003E 2401              ADD     A,#01H
0040 FF                MOV     R7,A
0041 EE                MOV     A,R6
0042 3480              ADDC    A,#080H
0044 FE                MOV     R6,A
0045 8F82              MOV     DPL,R7
0047 8E83              MOV     DPH,R6
0049 E0                MOVX    A,@DPTR
004A FF                MOV     R7,A
004B 7E00              MOV     R6,#00H
004D 900000      R     MOV     DPTR,#value
0050 E0                MOVX    A,@DPTR
0051 FC                MOV     R4,A
0052 A3                INC     DPTR
0053 E0                MOVX    A,@DPTR
0054 FD                MOV     R5,A
0055 EE                MOV     A,R6
0056 4C                ORL     A,R4
0057 FE                MOV     R6,A
0058 EF                MOV     A,R7
0059 4D                ORL     A,R5
005A FF                MOV     R7,A
005B 900000      R     MOV     DPTR,#value
005E EE                MOV     A,R6
005F F0                MOVX    @DPTR,A
0060 A3                INC     DPTR
0061 EF                MOV     A,R7
0062 F0                MOVX    @DPTR,A
C51 COMPILER V9.51   EEPROM_ACCESS                                                         03/27/2014 17:30:56 PAGE 9   

                                           ; SOURCE LINE # 73
0063 900000      R     MOV     DPTR,#value
0066 E0                MOVX    A,@DPTR
0067 FE                MOV     R6,A
0068 A3                INC     DPTR
0069 E0                MOVX    A,@DPTR
006A FF                MOV     R7,A
                                           ; SOURCE LINE # 74
006B         ?C0009:
006B 22                RET     
             ; FUNCTION _get_variable (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    569    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      29
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
