C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/07/2014 01:13:18 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE EEPROM_ACCESS
OBJECT MODULE PLACED IN .\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Cypress\PSoC Creator\3.0\PSoC Creator\import\keil\pk51\9.51\C51\BIN\c51.exe 
                    -.\EEPROM_Access.c NOIV LARGE MODDP2 OMF2 VB(1) PR(.\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.lst) CD DB NOIP OT(0,SIZE
                    -) DF(DEBUG) INCDIR(.,.\Generated_Source\PSoC3) OJ(.\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.obj)

line level    source

   1          /* ========================================
   2           *
   3           * Copyright YOUR COMPANY, THE YEAR
   4           * All Rights Reserved
   5           * UNPUBLISHED, LICENSED SOFTWARE.
   6           *
   7           * CONFIDENTIAL AND PROPRIETARY INFORMATION
   8           * WHICH IS THE PROPERTY OF your company.
   9           *
  10           * ========================================
  11          */
  12          
  13          #include "EEPROM_Access.h"
  14          
  15          uint8 update_settings(settings_group new_settings){
  16   1          
  17   1          uint8* buffer;
  18   1          float rows_used = 0;
  19   1          uint16 remainder = 0;
  20   1          uint8* src_ptr;
  21   1          uint8* dst_ptr;
  22   1          uint8 i = 0; // loop var
  23   1          float bytes_used = EEPROM_BYTES_USED;
  24   1          uint8 result = SUCCESS;
  25   1          cystatus status;
  26   1          
  27   1          LED_on(MEM);
  28   1          
  29   1          // Allocate array to hold EEPROM variables
  30   1          
  31   1          rows_used = ceil(bytes_used/CYDEV_EEPROM_ROW_SIZE);
  32   1          buffer = malloc(((uint16) rows_used) * CYDEV_EEPROM_ROW_SIZE);
  33   1          
  34   1          dst_ptr = buffer;
  35   1          remainder = (rows_used * 16) - EEPROM_BYTES_USED;
  36   1          
  37   1          // Copy all variables into RAM
  38   1          for (i=0; i<EEPROM_BYTES_USED; ++i){
  39   2              *dst_ptr = CY_GET_REG8(CYDEV_EE_BASE + i);
  40   2              ++dst_ptr;      
  41   2          }
  42   1          
  43   1          // Fill remainder of buffer with zeros
  44   1          while (i < remainder){
  45   2              *dst_ptr = 0;
  46   2              ++i;
  47   2          }
  48   1          
  49   1          // Modify variables in RAM
  50   1          buffer[0] = new_settings.sensor;
  51   1          buffer[1] = new_settings.sample_unit;
  52   1          buffer[2] = new_settings.sample_interval;
  53   1          
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/07/2014 01:13:18 PAGE 2   

  54   1          // Erase EEPROM
  55   1          status = EEPROM_R_EraseSector(SECTOR_NUMBER);
  56   1          if (status != CYRET_SUCCESS){
  57   2              result = FAIL;
  58   2              goto exit;
  59   2          }
  60   1          
  61   1          // Write back modified EEPROM Variables
  62   1          i = 0;
  63   1          src_ptr = buffer;
  64   1          while ((i < rows_used) && (i < EEPROM_ROWS)){
  65   2              status = EEPROM_R_Write(src_ptr, i);
  66   2              if (status != CYRET_SUCCESS){
  67   3                 result = FAIL;
  68   3              goto exit;
  69   3          }
  70   2              src_ptr = src_ptr + CYDEV_EEPROM_ROW_SIZE;
  71   2              ++i;
  72   2          }
  73   1           
  74   1          // Free buffer memory
  75   1          free(buffer);
  76   1          
  77   1          LED_off(MEM);
  78   1          
  79   1      exit:   
  80   1          return result;   
  81   1      }
  82          
  83          uint8 get_variable(uint16 var_index){
  84   1          uint8 value = 10;
  85   1          
  86   1          LED_on(MEM);
  87   1          
  88   1          value = CY_GET_REG8(CYDEV_EE_BASE + var_index);
  89   1          
  90   1          LED_off(MEM);
  91   1          
  92   1          return value;
  93   1      }
  94          
  95          
  96          /* [] END OF FILE */
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/07/2014 01:13:18 PAGE 3   

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION update_settings (BEGIN)
                                           ; SOURCE LINE # 15
                                           ; SOURCE LINE # 18
0000 7F00              MOV     R7,#00H
0002 7E00              MOV     R6,#00H
0004 7D00              MOV     R5,#00H
0006 7C00              MOV     R4,#00H
0008 900000      R     MOV     DPTR,#rows_used
000B 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 19
000E 900000      R     MOV     DPTR,#remainder
0011 E4                CLR     A
0012 F0                MOVX    @DPTR,A
0013 A3                INC     DPTR
0014 E4                CLR     A
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 22
0016 900000      R     MOV     DPTR,#i
0019 E4                CLR     A
001A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 23
001B 7F00              MOV     R7,#00H
001D 7E00              MOV     R6,#00H
001F 7D40              MOV     R5,#040H
0021 7C40              MOV     R4,#040H
0023 900000      R     MOV     DPTR,#bytes_used
0026 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 24
0029 900000      R     MOV     DPTR,#result
002C 7402              MOV     A,#02H
002E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 27
002F 7F02              MOV     R7,#02H
0031 120000      E     LCALL   _LED_on
                                           ; SOURCE LINE # 31
0034 7B00              MOV     R3,#00H
0036 7A00              MOV     R2,#00H
0038 7980              MOV     R1,#080H
003A 7841              MOV     R0,#041H
003C 900000      R     MOV     DPTR,#bytes_used
003F 120000      E     LCALL   ?C?LLDXDATA
0042 120000      E     LCALL   ?C?FPDIV
0045 120000      E     LCALL   _ceil
0048 900000      R     MOV     DPTR,#rows_used
004B 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 32
004E 900000      R     MOV     DPTR,#rows_used
0051 120000      E     LCALL   ?C?LLDXDATA
0054 120000      E     LCALL   ?C?CASTF
0057 EF                MOV     A,R7
0058 C4                SWAP    A
0059 F8                MOV     R0,A
005A 540F              ANL     A,#0FH
005C C8                XCH     A,R0
005D 68                XRL     A,R0
005E FF                MOV     R7,A
005F EE                MOV     A,R6
0060 C4                SWAP    A
0061 54F0              ANL     A,#0F0H
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/07/2014 01:13:18 PAGE 4   

0063 48                ORL     A,R0
0064 FE                MOV     R6,A
0065 120000      E     LCALL   _malloc
0068 AA06              MOV     R2,AR6
006A A907              MOV     R1,AR7
006C 7B01              MOV     R3,#01H
006E 900000      R     MOV     DPTR,#buffer
0071 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 34
0074 900000      R     MOV     DPTR,#buffer
0077 120000      E     LCALL   ?C?PLDXDATA
007A 900000      R     MOV     DPTR,#dst_ptr
007D 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 35
0080 7F00              MOV     R7,#00H
0082 7E00              MOV     R6,#00H
0084 7D80              MOV     R5,#080H
0086 7C41              MOV     R4,#041H
0088 900000      R     MOV     DPTR,#rows_used
008B 120000      E     LCALL   ?C?LLDXDATA0
008E 120000      E     LCALL   ?C?FPMUL
0091 7B00              MOV     R3,#00H
0093 7A00              MOV     R2,#00H
0095 7940              MOV     R1,#040H
0097 78C0              MOV     R0,#0C0H
0099 120000      E     LCALL   ?C?FPADD
009C 120000      E     LCALL   ?C?CASTF
009F 900000      R     MOV     DPTR,#remainder
00A2 EE                MOV     A,R6
00A3 F0                MOVX    @DPTR,A
00A4 A3                INC     DPTR
00A5 EF                MOV     A,R7
00A6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 38
00A7 900000      R     MOV     DPTR,#i
00AA E4                CLR     A
00AB F0                MOVX    @DPTR,A
00AC         ?C0001:
00AC 900000      R     MOV     DPTR,#i
00AF E0                MOVX    A,@DPTR
00B0 FF                MOV     R7,A
00B1 EF                MOV     A,R7
00B2 C3                CLR     C
00B3 9403              SUBB    A,#03H
00B5 5031              JNC     ?C0004
                                           ; SOURCE LINE # 39
00B7 900000      R     MOV     DPTR,#i
00BA E0                MOVX    A,@DPTR
00BB FF                MOV     R7,A
00BC 7E00              MOV     R6,#00H
00BE EF                MOV     A,R7
00BF 2400              ADD     A,#00H
00C1 FF                MOV     R7,A
00C2 EE                MOV     A,R6
00C3 3480              ADDC    A,#080H
00C5 FE                MOV     R6,A
00C6 8F82              MOV     DPL,R7
00C8 8E83              MOV     DPH,R6
00CA E0                MOVX    A,@DPTR
00CB FF                MOV     R7,A
00CC 900000      R     MOV     DPTR,#dst_ptr
00CF 120000      E     LCALL   ?C?PLDXDATA
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/07/2014 01:13:18 PAGE 5   

00D2 EF                MOV     A,R7
00D3 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 40
00D6 900000      R     MOV     DPTR,#dst_ptr+01H
00D9 E4                CLR     A
00DA 75F001            MOV     B,#01H
00DD 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 41
00E0         ?C0003:
00E0 900000      R     MOV     DPTR,#i
00E3 E0                MOVX    A,@DPTR
00E4 04                INC     A
00E5 F0                MOVX    @DPTR,A
00E6 80C4              SJMP    ?C0001
00E8         ?C0002:
00E8         ?C0004:
                                           ; SOURCE LINE # 44
00E8 900000      R     MOV     DPTR,#i
00EB E0                MOVX    A,@DPTR
00EC FF                MOV     R7,A
00ED 7E00              MOV     R6,#00H
00EF 900000      R     MOV     DPTR,#remainder
00F2 E0                MOVX    A,@DPTR
00F3 FC                MOV     R4,A
00F4 A3                INC     DPTR
00F5 E0                MOVX    A,@DPTR
00F6 FD                MOV     R5,A
00F7 C3                CLR     C
00F8 EF                MOV     A,R7
00F9 9D                SUBB    A,R5
00FA EE                MOV     A,R6
00FB 9C                SUBB    A,R4
00FC 5012              JNC     ?C0005
                                           ; SOURCE LINE # 45
00FE 900000      R     MOV     DPTR,#dst_ptr
0101 120000      E     LCALL   ?C?PLDXDATA
0104 E4                CLR     A
0105 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 46
0108 900000      R     MOV     DPTR,#i
010B E0                MOVX    A,@DPTR
010C 04                INC     A
010D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 47
010E 80D8              SJMP    ?C0004
0110         ?C0005:
                                           ; SOURCE LINE # 50
0110 900000      R     MOV     DPTR,#new_settings
0113 E0                MOVX    A,@DPTR
0114 FF                MOV     R7,A
0115 900000      R     MOV     DPTR,#buffer
0118 120000      E     LCALL   ?C?PLDXDATA
011B EF                MOV     A,R7
011C 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 51
011F 900000      R     MOV     DPTR,#new_settings+01H
0122 E0                MOVX    A,@DPTR
0123 FF                MOV     R7,A
0124 900000      R     MOV     DPTR,#buffer
0127 120000      E     LCALL   ?C?PLDXDATA
012A E9                MOV     A,R1
012B 2401              ADD     A,#01H
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/07/2014 01:13:18 PAGE 6   

012D F9                MOV     R1,A
012E EA                MOV     A,R2
012F 3400              ADDC    A,#00H
0131 FA                MOV     R2,A
0132 EF                MOV     A,R7
0133 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 52
0136 900000      R     MOV     DPTR,#new_settings+02H
0139 E0                MOVX    A,@DPTR
013A FF                MOV     R7,A
013B 900000      R     MOV     DPTR,#buffer
013E 120000      E     LCALL   ?C?PLDXDATA
0141 E9                MOV     A,R1
0142 2402              ADD     A,#02H
0144 F9                MOV     R1,A
0145 EA                MOV     A,R2
0146 3400              ADDC    A,#00H
0148 FA                MOV     R2,A
0149 EF                MOV     A,R7
014A 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 55
014D 7F00              MOV     R7,#00H
014F 120000      E     LCALL   _EEPROM_R_EraseSector
0152 900000      R     MOV     DPTR,#status
0155 EF                MOV     A,R7
0156 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 56
0157 900000      R     MOV     DPTR,#status
015A E0                MOVX    A,@DPTR
015B FF                MOV     R7,A
015C EF                MOV     A,R7
015D 6008              JZ      ?C0006
                                           ; SOURCE LINE # 57
015F 900000      R     MOV     DPTR,#result
0162 7403              MOV     A,#03H
0164 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 58
0165 8079              SJMP    exit
                                           ; SOURCE LINE # 59
0167         ?C0006:
                                           ; SOURCE LINE # 62
0167 900000      R     MOV     DPTR,#i
016A E4                CLR     A
016B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 63
016C 900000      R     MOV     DPTR,#buffer
016F 120000      E     LCALL   ?C?PLDXDATA
0172 900000      R     MOV     DPTR,#src_ptr
0175 120000      E     LCALL   ?C?PSTXDATA
0178         ?C0008:
                                           ; SOURCE LINE # 64
0178 900000      R     MOV     DPTR,#i
017B E0                MOVX    A,@DPTR
017C FC                MOV     R4,A
017D E4                CLR     A
017E 120000      E     LCALL   ?C?FCASTC
0181 900000      R     MOV     DPTR,#rows_used
0184 120000      E     LCALL   ?C?LLDXDATA0
0187 120000      E     LCALL   ?C?FPCMP3
018A 6042              JZ      ?C0009
018C 4040              JC      ?C0009
018E 900000      R     MOV     DPTR,#i
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/07/2014 01:13:18 PAGE 7   

0191 E0                MOVX    A,@DPTR
0192 FF                MOV     R7,A
0193 EF                MOV     A,R7
0194 C3                CLR     C
0195 9480              SUBB    A,#080H
0197 5035              JNC     ?C0009
                                           ; SOURCE LINE # 65
0199 900000      R     MOV     DPTR,#src_ptr
019C 120000      E     LCALL   ?C?PLDXDATA
019F 900000      R     MOV     DPTR,#i
01A2 E0                MOVX    A,@DPTR
01A3 FD                MOV     R5,A
01A4 120000      E     LCALL   _EEPROM_R_Write
01A7 900000      R     MOV     DPTR,#status
01AA EF                MOV     A,R7
01AB F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 66
01AC 900000      R     MOV     DPTR,#status
01AF E0                MOVX    A,@DPTR
01B0 FF                MOV     R7,A
01B1 EF                MOV     A,R7
01B2 6008              JZ      ?C0010
                                           ; SOURCE LINE # 67
01B4 900000      R     MOV     DPTR,#result
01B7 7403              MOV     A,#03H
01B9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 68
01BA 8024              SJMP    exit
                                           ; SOURCE LINE # 69
01BC         ?C0010:
                                           ; SOURCE LINE # 70
01BC 900000      R     MOV     DPTR,#src_ptr+01H
01BF E4                CLR     A
01C0 75F010            MOV     B,#010H
01C3 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 71
01C6 900000      R     MOV     DPTR,#i
01C9 E0                MOVX    A,@DPTR
01CA 04                INC     A
01CB F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 72
01CC 80AA              SJMP    ?C0008
01CE         ?C0009:
                                           ; SOURCE LINE # 75
01CE 900000      R     MOV     DPTR,#buffer
01D1 120000      E     LCALL   ?C?PLDXDATA
01D4 AE02              MOV     R6,AR2
01D6 AF01              MOV     R7,AR1
01D8 120000      E     LCALL   _free
                                           ; SOURCE LINE # 77
01DB 7F02              MOV     R7,#02H
01DD 120000      E     LCALL   _LED_off
                                           ; SOURCE LINE # 79
01E0         exit:
                                           ; SOURCE LINE # 80
01E0 900000      R     MOV     DPTR,#result
01E3 E0                MOVX    A,@DPTR
01E4 FF                MOV     R7,A
                                           ; SOURCE LINE # 81
01E5         ?C0011:
01E5 22                RET     
             ; FUNCTION update_settings (END)
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/07/2014 01:13:18 PAGE 8   


             ; FUNCTION _get_variable (BEGIN)
                                           ; SOURCE LINE # 83
0000 900000      R     MOV     DPTR,#var_index
0003 EE                MOV     A,R6
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EF                MOV     A,R7
0007 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 84
0008 900000      R     MOV     DPTR,#value
000B 740A              MOV     A,#0AH
000D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 86
000E 7F02              MOV     R7,#02H
0010 120000      E     LCALL   _LED_on
                                           ; SOURCE LINE # 88
0013 900000      R     MOV     DPTR,#var_index
0016 E0                MOVX    A,@DPTR
0017 FE                MOV     R6,A
0018 A3                INC     DPTR
0019 E0                MOVX    A,@DPTR
001A FF                MOV     R7,A
001B EF                MOV     A,R7
001C 2400              ADD     A,#00H
001E FF                MOV     R7,A
001F EE                MOV     A,R6
0020 3480              ADDC    A,#080H
0022 FE                MOV     R6,A
0023 8F82              MOV     DPL,R7
0025 8E83              MOV     DPH,R6
0027 E0                MOVX    A,@DPTR
0028 FF                MOV     R7,A
0029 900000      R     MOV     DPTR,#value
002C EF                MOV     A,R7
002D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 90
002E 7F02              MOV     R7,#02H
0030 120000      E     LCALL   _LED_off
                                           ; SOURCE LINE # 92
0033 900000      R     MOV     DPTR,#value
0036 E0                MOVX    A,@DPTR
0037 FF                MOV     R7,A
                                           ; SOURCE LINE # 93
0038         ?C0012:
0038 22                RET     
             ; FUNCTION _get_variable (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    543    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     28    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/07/2014 01:13:18 PAGE 9   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
