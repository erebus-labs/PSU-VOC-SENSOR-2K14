C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/01/2014 23:42:19 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE EEPROM_ACCESS
OBJECT MODULE PLACED IN .\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Cypress\PSoC Creator\3.0\PSoC Creator\import\keil\pk51\9.51\C51\BIN\c51.exe 
                    -.\EEPROM_Access.c NOIV LARGE MODDP2 OMF2 VB(1) PR(.\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.lst) CD DB NOIP OT(0,SIZE
                    -) DF(DEBUG) INCDIR(.,.\Generated_Source\PSoC3) OJ(.\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.obj)

line level    source

   1          /* ========================================
   2           *
   3           * Copyright YOUR COMPANY, THE YEAR
   4           * All Rights Reserved
   5           * UNPUBLISHED, LICENSED SOFTWARE.
   6           *
   7           * CONFIDENTIAL AND PROPRIETARY INFORMATION
   8           * WHICH IS THE PROPERTY OF your company.
   9           *
  10           * ========================================
  11          */
  12          
  13          #include "EEPROM_Access.h"
  14          
  15          uint8 update_settings(settings_group new_settings){
  16   1          
  17   1          uint8* buffer;
  18   1          float rows_used = 0;
  19   1          uint16 remainder = 0;
  20   1          uint8* src_ptr;
  21   1          uint8* dst_ptr;
  22   1          uint8 i = 0; // loop var
  23   1          float bytes_used = EEPROM_BYTES_USED;
  24   1          uint8 result = SUCCESS;
  25   1          cystatus status;
  26   1          
  27   1          int test;
  28   1          
  29   1          EEPROM_LED_on();
  30   1          
  31   1          // Allocate array to hold EEPROM variables
  32   1          
  33   1          rows_used = ceil(bytes_used/CYDEV_EEPROM_ROW_SIZE);
  34   1          buffer = malloc(((uint16) rows_used) * CYDEV_EEPROM_ROW_SIZE);
  35   1          
  36   1          test = sizeof(buffer);
  37   1          
  38   1          dst_ptr = buffer;
  39   1          remainder = (rows_used * 16) - EEPROM_BYTES_USED;
  40   1          
  41   1          // Copy all variables into RAM
  42   1          for (i=0; i<EEPROM_BYTES_USED; ++i){
  43   2              *dst_ptr = CY_GET_REG8(CYDEV_EE_BASE + i);
  44   2              ++dst_ptr;      
  45   2          }
  46   1          
  47   1          // Fill remainder of buffer with zeros
  48   1          while (i < remainder){
  49   2              *dst_ptr = 0;
  50   2              ++i;
  51   2          }
  52   1          
  53   1          // Modify variables in RAM
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/01/2014 23:42:19 PAGE 2   

  54   1          buffer[0] = new_settings.sensor;
  55   1          buffer[1] = new_settings.sample_unit;
  56   1          buffer[2] = new_settings.sample_interval;
  57   1          
  58   1          // Erase EEPROM
  59   1          status = EEPROM_R_EraseSector(SECTOR_NUMBER);
  60   1          if (status != CYRET_SUCCESS){
  61   2              result = FAIL;
  62   2              goto exit;
  63   2          }
  64   1          
  65   1          // Write back modified EEPROM Variables
  66   1          i = 0;
  67   1          src_ptr = buffer;
  68   1          while ((i < rows_used) && (i < EEPROM_ROWS)){
  69   2              status = EEPROM_R_Write(src_ptr, i);
  70   2              if (status != CYRET_SUCCESS){
  71   3                 result = FAIL;
  72   3              goto exit;
  73   3          }
  74   2              src_ptr = src_ptr + CYDEV_EEPROM_ROW_SIZE;
  75   2              ++i;
  76   2          }
  77   1           
  78   1          // Free buffer memory
  79   1          free(buffer);
  80   1          
  81   1          EEPROM_LED_off();
  82   1          
  83   1      exit:   
  84   1          return result;   
  85   1      }
  86          
  87          uint8 get_variable(uint16 var_index){
  88   1          uint8 value = 10;
  89   1          
  90   1          EEPROM_LED_on();
  91   1          
  92   1          value = CY_GET_REG8(CYDEV_EE_BASE + var_index);
  93   1          
  94   1          EEPROM_LED_off();
  95   1          
  96   1          return value;
  97   1      }
  98          
  99          
 100          /* [] END OF FILE */
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/01/2014 23:42:19 PAGE 3   

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION update_settings (BEGIN)
                                           ; SOURCE LINE # 15
                                           ; SOURCE LINE # 18
0000 7F00              MOV     R7,#00H
0002 7E00              MOV     R6,#00H
0004 7D00              MOV     R5,#00H
0006 7C00              MOV     R4,#00H
0008 900000      R     MOV     DPTR,#rows_used
000B 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 19
000E 900000      R     MOV     DPTR,#remainder
0011 E4                CLR     A
0012 F0                MOVX    @DPTR,A
0013 A3                INC     DPTR
0014 E4                CLR     A
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 22
0016 900000      R     MOV     DPTR,#i
0019 E4                CLR     A
001A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 23
001B 7F00              MOV     R7,#00H
001D 7E00              MOV     R6,#00H
001F 7D40              MOV     R5,#040H
0021 7C40              MOV     R4,#040H
0023 900000      R     MOV     DPTR,#bytes_used
0026 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 24
0029 900000      R     MOV     DPTR,#result
002C 7402              MOV     A,#02H
002E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 29
002F 120000      E     LCALL   EEPROM_LED_on
                                           ; SOURCE LINE # 33
0032 7B00              MOV     R3,#00H
0034 7A00              MOV     R2,#00H
0036 7980              MOV     R1,#080H
0038 7841              MOV     R0,#041H
003A 900000      R     MOV     DPTR,#bytes_used
003D 120000      E     LCALL   ?C?LLDXDATA
0040 120000      E     LCALL   ?C?FPDIV
0043 120000      E     LCALL   _ceil
0046 900000      R     MOV     DPTR,#rows_used
0049 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 34
004C 900000      R     MOV     DPTR,#rows_used
004F 120000      E     LCALL   ?C?LLDXDATA
0052 120000      E     LCALL   ?C?CASTF
0055 EF                MOV     A,R7
0056 C4                SWAP    A
0057 F8                MOV     R0,A
0058 540F              ANL     A,#0FH
005A C8                XCH     A,R0
005B 68                XRL     A,R0
005C FF                MOV     R7,A
005D EE                MOV     A,R6
005E C4                SWAP    A
005F 54F0              ANL     A,#0F0H
0061 48                ORL     A,R0
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/01/2014 23:42:19 PAGE 4   

0062 FE                MOV     R6,A
0063 120000      E     LCALL   _malloc
0066 AA06              MOV     R2,AR6
0068 A907              MOV     R1,AR7
006A 7B01              MOV     R3,#01H
006C 900000      R     MOV     DPTR,#buffer
006F 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 36
0072 900000      R     MOV     DPTR,#test
0075 E4                CLR     A
0076 F0                MOVX    @DPTR,A
0077 A3                INC     DPTR
0078 7403              MOV     A,#03H
007A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 38
007B 900000      R     MOV     DPTR,#buffer
007E 120000      E     LCALL   ?C?PLDXDATA
0081 900000      R     MOV     DPTR,#dst_ptr
0084 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 39
0087 7F00              MOV     R7,#00H
0089 7E00              MOV     R6,#00H
008B 7D80              MOV     R5,#080H
008D 7C41              MOV     R4,#041H
008F 900000      R     MOV     DPTR,#rows_used
0092 120000      E     LCALL   ?C?LLDXDATA0
0095 120000      E     LCALL   ?C?FPMUL
0098 7B00              MOV     R3,#00H
009A 7A00              MOV     R2,#00H
009C 7940              MOV     R1,#040H
009E 78C0              MOV     R0,#0C0H
00A0 120000      E     LCALL   ?C?FPADD
00A3 120000      E     LCALL   ?C?CASTF
00A6 900000      R     MOV     DPTR,#remainder
00A9 EE                MOV     A,R6
00AA F0                MOVX    @DPTR,A
00AB A3                INC     DPTR
00AC EF                MOV     A,R7
00AD F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 42
00AE 900000      R     MOV     DPTR,#i
00B1 E4                CLR     A
00B2 F0                MOVX    @DPTR,A
00B3         ?C0001:
00B3 900000      R     MOV     DPTR,#i
00B6 E0                MOVX    A,@DPTR
00B7 FF                MOV     R7,A
00B8 EF                MOV     A,R7
00B9 C3                CLR     C
00BA 9403              SUBB    A,#03H
00BC 5031              JNC     ?C0004
                                           ; SOURCE LINE # 43
00BE 900000      R     MOV     DPTR,#i
00C1 E0                MOVX    A,@DPTR
00C2 FF                MOV     R7,A
00C3 7E00              MOV     R6,#00H
00C5 EF                MOV     A,R7
00C6 2400              ADD     A,#00H
00C8 FF                MOV     R7,A
00C9 EE                MOV     A,R6
00CA 3480              ADDC    A,#080H
00CC FE                MOV     R6,A
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/01/2014 23:42:19 PAGE 5   

00CD 8F82              MOV     DPL,R7
00CF 8E83              MOV     DPH,R6
00D1 E0                MOVX    A,@DPTR
00D2 FF                MOV     R7,A
00D3 900000      R     MOV     DPTR,#dst_ptr
00D6 120000      E     LCALL   ?C?PLDXDATA
00D9 EF                MOV     A,R7
00DA 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 44
00DD 900000      R     MOV     DPTR,#dst_ptr+01H
00E0 E4                CLR     A
00E1 75F001            MOV     B,#01H
00E4 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 45
00E7         ?C0003:
00E7 900000      R     MOV     DPTR,#i
00EA E0                MOVX    A,@DPTR
00EB 04                INC     A
00EC F0                MOVX    @DPTR,A
00ED 80C4              SJMP    ?C0001
00EF         ?C0002:
00EF         ?C0004:
                                           ; SOURCE LINE # 48
00EF 900000      R     MOV     DPTR,#i
00F2 E0                MOVX    A,@DPTR
00F3 FF                MOV     R7,A
00F4 7E00              MOV     R6,#00H
00F6 900000      R     MOV     DPTR,#remainder
00F9 E0                MOVX    A,@DPTR
00FA FC                MOV     R4,A
00FB A3                INC     DPTR
00FC E0                MOVX    A,@DPTR
00FD FD                MOV     R5,A
00FE C3                CLR     C
00FF EF                MOV     A,R7
0100 9D                SUBB    A,R5
0101 EE                MOV     A,R6
0102 9C                SUBB    A,R4
0103 5012              JNC     ?C0005
                                           ; SOURCE LINE # 49
0105 900000      R     MOV     DPTR,#dst_ptr
0108 120000      E     LCALL   ?C?PLDXDATA
010B E4                CLR     A
010C 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 50
010F 900000      R     MOV     DPTR,#i
0112 E0                MOVX    A,@DPTR
0113 04                INC     A
0114 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 51
0115 80D8              SJMP    ?C0004
0117         ?C0005:
                                           ; SOURCE LINE # 54
0117 900000      R     MOV     DPTR,#new_settings
011A E0                MOVX    A,@DPTR
011B FF                MOV     R7,A
011C 900000      R     MOV     DPTR,#buffer
011F 120000      E     LCALL   ?C?PLDXDATA
0122 EF                MOV     A,R7
0123 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 55
0126 900000      R     MOV     DPTR,#new_settings+01H
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/01/2014 23:42:19 PAGE 6   

0129 E0                MOVX    A,@DPTR
012A FF                MOV     R7,A
012B 900000      R     MOV     DPTR,#buffer
012E 120000      E     LCALL   ?C?PLDXDATA
0131 E9                MOV     A,R1
0132 2401              ADD     A,#01H
0134 F9                MOV     R1,A
0135 EA                MOV     A,R2
0136 3400              ADDC    A,#00H
0138 FA                MOV     R2,A
0139 EF                MOV     A,R7
013A 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 56
013D 900000      R     MOV     DPTR,#new_settings+02H
0140 E0                MOVX    A,@DPTR
0141 FF                MOV     R7,A
0142 900000      R     MOV     DPTR,#buffer
0145 120000      E     LCALL   ?C?PLDXDATA
0148 E9                MOV     A,R1
0149 2402              ADD     A,#02H
014B F9                MOV     R1,A
014C EA                MOV     A,R2
014D 3400              ADDC    A,#00H
014F FA                MOV     R2,A
0150 EF                MOV     A,R7
0151 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 59
0154 7F00              MOV     R7,#00H
0156 120000      E     LCALL   _EEPROM_R_EraseSector
0159 900000      R     MOV     DPTR,#status
015C EF                MOV     A,R7
015D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 60
015E 900000      R     MOV     DPTR,#status
0161 E0                MOVX    A,@DPTR
0162 FF                MOV     R7,A
0163 EF                MOV     A,R7
0164 6008              JZ      ?C0006
                                           ; SOURCE LINE # 61
0166 900000      R     MOV     DPTR,#result
0169 7403              MOV     A,#03H
016B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 62
016C 8077              SJMP    exit
                                           ; SOURCE LINE # 63
016E         ?C0006:
                                           ; SOURCE LINE # 66
016E 900000      R     MOV     DPTR,#i
0171 E4                CLR     A
0172 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 67
0173 900000      R     MOV     DPTR,#buffer
0176 120000      E     LCALL   ?C?PLDXDATA
0179 900000      R     MOV     DPTR,#src_ptr
017C 120000      E     LCALL   ?C?PSTXDATA
017F         ?C0008:
                                           ; SOURCE LINE # 68
017F 900000      R     MOV     DPTR,#i
0182 E0                MOVX    A,@DPTR
0183 FC                MOV     R4,A
0184 E4                CLR     A
0185 120000      E     LCALL   ?C?FCASTC
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/01/2014 23:42:19 PAGE 7   

0188 900000      R     MOV     DPTR,#rows_used
018B 120000      E     LCALL   ?C?LLDXDATA0
018E 120000      E     LCALL   ?C?FPCMP3
0191 6042              JZ      ?C0009
0193 4040              JC      ?C0009
0195 900000      R     MOV     DPTR,#i
0198 E0                MOVX    A,@DPTR
0199 FF                MOV     R7,A
019A EF                MOV     A,R7
019B C3                CLR     C
019C 9480              SUBB    A,#080H
019E 5035              JNC     ?C0009
                                           ; SOURCE LINE # 69
01A0 900000      R     MOV     DPTR,#src_ptr
01A3 120000      E     LCALL   ?C?PLDXDATA
01A6 900000      R     MOV     DPTR,#i
01A9 E0                MOVX    A,@DPTR
01AA FD                MOV     R5,A
01AB 120000      E     LCALL   _EEPROM_R_Write
01AE 900000      R     MOV     DPTR,#status
01B1 EF                MOV     A,R7
01B2 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 70
01B3 900000      R     MOV     DPTR,#status
01B6 E0                MOVX    A,@DPTR
01B7 FF                MOV     R7,A
01B8 EF                MOV     A,R7
01B9 6008              JZ      ?C0010
                                           ; SOURCE LINE # 71
01BB 900000      R     MOV     DPTR,#result
01BE 7403              MOV     A,#03H
01C0 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 72
01C1 8022              SJMP    exit
                                           ; SOURCE LINE # 73
01C3         ?C0010:
                                           ; SOURCE LINE # 74
01C3 900000      R     MOV     DPTR,#src_ptr+01H
01C6 E4                CLR     A
01C7 75F010            MOV     B,#010H
01CA 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 75
01CD 900000      R     MOV     DPTR,#i
01D0 E0                MOVX    A,@DPTR
01D1 04                INC     A
01D2 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 76
01D3 80AA              SJMP    ?C0008
01D5         ?C0009:
                                           ; SOURCE LINE # 79
01D5 900000      R     MOV     DPTR,#buffer
01D8 120000      E     LCALL   ?C?PLDXDATA
01DB AE02              MOV     R6,AR2
01DD AF01              MOV     R7,AR1
01DF 120000      E     LCALL   _free
                                           ; SOURCE LINE # 81
01E2 120000      E     LCALL   EEPROM_LED_off
                                           ; SOURCE LINE # 83
01E5         exit:
                                           ; SOURCE LINE # 84
01E5 900000      R     MOV     DPTR,#result
01E8 E0                MOVX    A,@DPTR
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/01/2014 23:42:19 PAGE 8   

01E9 FF                MOV     R7,A
                                           ; SOURCE LINE # 85
01EA         ?C0011:
01EA 22                RET     
             ; FUNCTION update_settings (END)

             ; FUNCTION _get_variable (BEGIN)
                                           ; SOURCE LINE # 87
0000 900000      R     MOV     DPTR,#var_index
0003 EE                MOV     A,R6
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EF                MOV     A,R7
0007 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 88
0008 900000      R     MOV     DPTR,#value
000B 740A              MOV     A,#0AH
000D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 90
000E 120000      E     LCALL   EEPROM_LED_on
                                           ; SOURCE LINE # 92
0011 900000      R     MOV     DPTR,#var_index
0014 E0                MOVX    A,@DPTR
0015 FE                MOV     R6,A
0016 A3                INC     DPTR
0017 E0                MOVX    A,@DPTR
0018 FF                MOV     R7,A
0019 EF                MOV     A,R7
001A 2400              ADD     A,#00H
001C FF                MOV     R7,A
001D EE                MOV     A,R6
001E 3480              ADDC    A,#080H
0020 FE                MOV     R6,A
0021 8F82              MOV     DPL,R7
0023 8E83              MOV     DPH,R6
0025 E0                MOVX    A,@DPTR
0026 FF                MOV     R7,A
0027 900000      R     MOV     DPTR,#value
002A EF                MOV     A,R7
002B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 94
002C 120000      E     LCALL   EEPROM_LED_off
                                           ; SOURCE LINE # 96
002F 900000      R     MOV     DPTR,#value
0032 E0                MOVX    A,@DPTR
0033 FF                MOV     R7,A
                                           ; SOURCE LINE # 97
0034         ?C0012:
0034 22                RET     
             ; FUNCTION _get_variable (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    544    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     30    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
C51 COMPILER V9.51   EEPROM_ACCESS                                                         05/01/2014 23:42:19 PAGE 9   

   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
