C51 COMPILER V9.51   EEPROM_ACCESS                                                         04/25/2014 21:40:47 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE EEPROM_ACCESS
OBJECT MODULE PLACED IN .\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Cypress\PSoC Creator\3.0\PSoC Creator\import\keil\pk51\9.51\C51\BIN\c51.exe 
                    -.\EEPROM_Access.c NOIV LARGE MODDP2 OMF2 VB(1) PR(.\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.lst) CD DB NOIP OT(0,SIZE
                    -) DF(DEBUG) INCDIR(.,.\Generated_Source\PSoC3) OJ(.\DP8051\DP8051_Keil_951\Debug\EEPROM_Access.obj)

line level    source

   1          /* ========================================
   2           *
   3           * Copyright YOUR COMPANY, THE YEAR
   4           * All Rights Reserved
   5           * UNPUBLISHED, LICENSED SOFTWARE.
   6           *
   7           * CONFIDENTIAL AND PROPRIETARY INFORMATION
   8           * WHICH IS THE PROPERTY OF your company.
   9           *
  10           * ========================================
  11          */
  12          
  13          #include "EEPROM_Access.h"
  14          
  15          void update_variable(uint16 index, uint16 value){
  16   1          
  17   1          uint8* buffer;
  18   1          float rows_used = 0;
  19   1          uint16 remainder = 0;
  20   1          uint8* src_ptr;
  21   1          uint8* dst_ptr;
  22   1          uint8 i = 0; // loop var
  23   1          float bytes_used = EEPROM_BYTES_USED;
  24   1          cystatus status;
  25   1          
  26   1          EEPROM_LED_on();
  27   1          
  28   1          // Allocate array to hold EEPROM variables
  29   1          
  30   1          rows_used = ceil(bytes_used/16);
  31   1          buffer = malloc(((uint16) rows_used) * 16);
  32   1          dst_ptr = buffer;
  33   1          remainder = (rows_used * 16) - EEPROM_BYTES_USED;
  34   1          
  35   1          // Copy all variables into RAM
  36   1          for (i=0; i<EEPROM_BYTES_USED; ++i){
  37   2              *dst_ptr = CY_GET_REG8(CYDEV_EE_BASE + i);
  38   2              ++dst_ptr;      
  39   2          }
  40   1          
  41   1          // Fill remainder of buffer with zeros
  42   1          while (i < remainder){
  43   2              *dst_ptr = 0;
  44   2              ++i;
  45   2          }
  46   1          
  47   1          // Modify variable in RAM
  48   1          buffer[index] = (uint8) (value >> 0x8);
  49   1          buffer[index+1] = (uint8) value & 0xFF;
  50   1          
  51   1          // Erase EEPROM
  52   1          status = EEPROM_R_EraseSector(SECTOR_NUMBER);
  53   1          
C51 COMPILER V9.51   EEPROM_ACCESS                                                         04/25/2014 21:40:47 PAGE 2   

  54   1          // Write back modified EEPROM Variables
  55   1          i = 0;
  56   1          src_ptr = buffer;
  57   1          while ((i < rows_used) && (i < EEPROM_ROWS)){
  58   2              EEPROM_R_Write(src_ptr, i);
  59   2              src_ptr = src_ptr + CYDEV_EEPROM_ROW_SIZE;
  60   2              ++i;
  61   2          }
  62   1           
  63   1          // Free buffer memory
  64   1          free(buffer);
  65   1          
  66   1         EEPROM_LED_off();
  67   1          
  68   1          return;   
  69   1      }
  70          
  71          uint16 get_variable(uint16 var_index){
  72   1          uint16 value = 10;
  73   1          
  74   1         EEPROM_LED_on();
  75   1          
  76   1          value = ((uint16) CY_GET_REG8(CYDEV_EE_BASE + var_index)) << 8;
  77   1          value = value | CY_GET_REG8(CYDEV_EE_BASE + var_index + 1);
  78   1          
  79   1         EEPROM_LED_off();
  80   1          
  81   1          return value;
  82   1      }
  83          
  84          
  85          /* [] END OF FILE */
C51 COMPILER V9.51   EEPROM_ACCESS                                                         04/25/2014 21:40:47 PAGE 3   

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION _update_variable (BEGIN)
                                           ; SOURCE LINE # 15
0000 900000      R     MOV     DPTR,#index
0003 EE                MOV     A,R6
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EF                MOV     A,R7
0007 F0                MOVX    @DPTR,A
0008 900000      R     MOV     DPTR,#value
000B EC                MOV     A,R4
000C F0                MOVX    @DPTR,A
000D A3                INC     DPTR
000E ED                MOV     A,R5
000F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 18
0010 7F00              MOV     R7,#00H
0012 7E00              MOV     R6,#00H
0014 7D00              MOV     R5,#00H
0016 7C00              MOV     R4,#00H
0018 900000      R     MOV     DPTR,#rows_used
001B 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 19
001E 900000      R     MOV     DPTR,#remainder
0021 E4                CLR     A
0022 F0                MOVX    @DPTR,A
0023 A3                INC     DPTR
0024 E4                CLR     A
0025 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 22
0026 900000      R     MOV     DPTR,#i
0029 E4                CLR     A
002A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 23
002B 7F00              MOV     R7,#00H
002D 7E00              MOV     R6,#00H
002F 7DC0              MOV     R5,#0C0H
0031 7C40              MOV     R4,#040H
0033 900000      R     MOV     DPTR,#bytes_used
0036 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 26
0039 120000      E     LCALL   EEPROM_LED_on
                                           ; SOURCE LINE # 30
003C 7B00              MOV     R3,#00H
003E 7A00              MOV     R2,#00H
0040 7980              MOV     R1,#080H
0042 7841              MOV     R0,#041H
0044 900000      R     MOV     DPTR,#bytes_used
0047 120000      E     LCALL   ?C?LLDXDATA
004A 120000      E     LCALL   ?C?FPDIV
004D 120000      E     LCALL   _ceil
0050 900000      R     MOV     DPTR,#rows_used
0053 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 31
0056 900000      R     MOV     DPTR,#rows_used
0059 120000      E     LCALL   ?C?LLDXDATA
005C 120000      E     LCALL   ?C?CASTF
005F EF                MOV     A,R7
0060 C4                SWAP    A
0061 F8                MOV     R0,A
C51 COMPILER V9.51   EEPROM_ACCESS                                                         04/25/2014 21:40:47 PAGE 4   

0062 540F              ANL     A,#0FH
0064 C8                XCH     A,R0
0065 68                XRL     A,R0
0066 FF                MOV     R7,A
0067 EE                MOV     A,R6
0068 C4                SWAP    A
0069 54F0              ANL     A,#0F0H
006B 48                ORL     A,R0
006C FE                MOV     R6,A
006D 120000      E     LCALL   _malloc
0070 AA06              MOV     R2,AR6
0072 A907              MOV     R1,AR7
0074 7B01              MOV     R3,#01H
0076 900000      R     MOV     DPTR,#buffer
0079 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 32
007C 900000      R     MOV     DPTR,#buffer
007F 120000      E     LCALL   ?C?PLDXDATA
0082 900000      R     MOV     DPTR,#dst_ptr
0085 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 33
0088 7F00              MOV     R7,#00H
008A 7E00              MOV     R6,#00H
008C 7D80              MOV     R5,#080H
008E 7C41              MOV     R4,#041H
0090 900000      R     MOV     DPTR,#rows_used
0093 120000      E     LCALL   ?C?LLDXDATA0
0096 120000      E     LCALL   ?C?FPMUL
0099 7B00              MOV     R3,#00H
009B 7A00              MOV     R2,#00H
009D 79C0              MOV     R1,#0C0H
009F 7840              MOV     R0,#040H
00A1 120000      E     LCALL   ?C?FPADD
00A4 120000      E     LCALL   ?C?CASTF
00A7 900000      R     MOV     DPTR,#remainder
00AA EE                MOV     A,R6
00AB F0                MOVX    @DPTR,A
00AC A3                INC     DPTR
00AD EF                MOV     A,R7
00AE F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 36
00AF 900000      R     MOV     DPTR,#i
00B2 E4                CLR     A
00B3 F0                MOVX    @DPTR,A
00B4         ?C0001:
00B4 900000      R     MOV     DPTR,#i
00B7 E0                MOVX    A,@DPTR
00B8 FF                MOV     R7,A
00B9 EF                MOV     A,R7
00BA C3                CLR     C
00BB 9406              SUBB    A,#06H
00BD 5031              JNC     ?C0004
                                           ; SOURCE LINE # 37
00BF 900000      R     MOV     DPTR,#i
00C2 E0                MOVX    A,@DPTR
00C3 FF                MOV     R7,A
00C4 7E00              MOV     R6,#00H
00C6 EF                MOV     A,R7
00C7 2400              ADD     A,#00H
00C9 FF                MOV     R7,A
00CA EE                MOV     A,R6
00CB 3480              ADDC    A,#080H
C51 COMPILER V9.51   EEPROM_ACCESS                                                         04/25/2014 21:40:47 PAGE 5   

00CD FE                MOV     R6,A
00CE 8F82              MOV     DPL,R7
00D0 8E83              MOV     DPH,R6
00D2 E0                MOVX    A,@DPTR
00D3 FF                MOV     R7,A
00D4 900000      R     MOV     DPTR,#dst_ptr
00D7 120000      E     LCALL   ?C?PLDXDATA
00DA EF                MOV     A,R7
00DB 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 38
00DE 900000      R     MOV     DPTR,#dst_ptr+01H
00E1 E4                CLR     A
00E2 75F001            MOV     B,#01H
00E5 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 39
00E8         ?C0003:
00E8 900000      R     MOV     DPTR,#i
00EB E0                MOVX    A,@DPTR
00EC 04                INC     A
00ED F0                MOVX    @DPTR,A
00EE 80C4              SJMP    ?C0001
00F0         ?C0002:
00F0         ?C0004:
                                           ; SOURCE LINE # 42
00F0 900000      R     MOV     DPTR,#i
00F3 E0                MOVX    A,@DPTR
00F4 FF                MOV     R7,A
00F5 7E00              MOV     R6,#00H
00F7 900000      R     MOV     DPTR,#remainder
00FA E0                MOVX    A,@DPTR
00FB FC                MOV     R4,A
00FC A3                INC     DPTR
00FD E0                MOVX    A,@DPTR
00FE FD                MOV     R5,A
00FF C3                CLR     C
0100 EF                MOV     A,R7
0101 9D                SUBB    A,R5
0102 EE                MOV     A,R6
0103 9C                SUBB    A,R4
0104 5012              JNC     ?C0005
                                           ; SOURCE LINE # 43
0106 900000      R     MOV     DPTR,#dst_ptr
0109 120000      E     LCALL   ?C?PLDXDATA
010C E4                CLR     A
010D 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 44
0110 900000      R     MOV     DPTR,#i
0113 E0                MOVX    A,@DPTR
0114 04                INC     A
0115 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 45
0116 80D8              SJMP    ?C0004
0118         ?C0005:
                                           ; SOURCE LINE # 48
0118 900000      R     MOV     DPTR,#value
011B E0                MOVX    A,@DPTR
011C FE                MOV     R6,A
011D A3                INC     DPTR
011E E0                MOVX    A,@DPTR
011F FF                MOV     R7,A
0120 EE                MOV     A,R6
0121 FF                MOV     R7,A
C51 COMPILER V9.51   EEPROM_ACCESS                                                         04/25/2014 21:40:47 PAGE 6   

0122 7E00              MOV     R6,#00H
0124 900000      R     MOV     DPTR,#buffer
0127 120000      E     LCALL   ?C?PLDXDATA
012A 900000      R     MOV     DPTR,#index
012D E0                MOVX    A,@DPTR
012E FC                MOV     R4,A
012F A3                INC     DPTR
0130 E0                MOVX    A,@DPTR
0131 FD                MOV     R5,A
0132 E9                MOV     A,R1
0133 2D                ADD     A,R5
0134 F9                MOV     R1,A
0135 EA                MOV     A,R2
0136 3C                ADDC    A,R4
0137 FA                MOV     R2,A
0138 EF                MOV     A,R7
0139 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 49
013C 900000      R     MOV     DPTR,#value
013F E0                MOVX    A,@DPTR
0140 FE                MOV     R6,A
0141 A3                INC     DPTR
0142 E0                MOVX    A,@DPTR
0143 FF                MOV     R7,A
0144 EF                MOV     A,R7
0145 54FF              ANL     A,#0FFH
0147 FF                MOV     R7,A
0148 900000      R     MOV     DPTR,#buffer
014B 120000      E     LCALL   ?C?PLDXDATA
014E 900000      R     MOV     DPTR,#index
0151 E0                MOVX    A,@DPTR
0152 FC                MOV     R4,A
0153 A3                INC     DPTR
0154 E0                MOVX    A,@DPTR
0155 FD                MOV     R5,A
0156 ED                MOV     A,R5
0157 2401              ADD     A,#01H
0159 FD                MOV     R5,A
015A EC                MOV     A,R4
015B 3400              ADDC    A,#00H
015D FC                MOV     R4,A
015E E9                MOV     A,R1
015F 2D                ADD     A,R5
0160 F9                MOV     R1,A
0161 EA                MOV     A,R2
0162 3C                ADDC    A,R4
0163 FA                MOV     R2,A
0164 EF                MOV     A,R7
0165 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 52
0168 7F00              MOV     R7,#00H
016A 120000      E     LCALL   _EEPROM_R_EraseSector
016D 900000      R     MOV     DPTR,#status
0170 EF                MOV     A,R7
0171 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 55
0172 900000      R     MOV     DPTR,#i
0175 E4                CLR     A
0176 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 56
0177 900000      R     MOV     DPTR,#buffer
017A 120000      E     LCALL   ?C?PLDXDATA
C51 COMPILER V9.51   EEPROM_ACCESS                                                         04/25/2014 21:40:47 PAGE 7   

017D 900000      R     MOV     DPTR,#src_ptr
0180 120000      E     LCALL   ?C?PSTXDATA
0183         ?C0006:
                                           ; SOURCE LINE # 57
0183 900000      R     MOV     DPTR,#i
0186 E0                MOVX    A,@DPTR
0187 FC                MOV     R4,A
0188 E4                CLR     A
0189 120000      E     LCALL   ?C?FCASTC
018C 900000      R     MOV     DPTR,#rows_used
018F 120000      E     LCALL   ?C?LLDXDATA0
0192 120000      E     LCALL   ?C?FPCMP3
0195 602D              JZ      ?C0007
0197 402B              JC      ?C0007
0199 900000      R     MOV     DPTR,#i
019C E0                MOVX    A,@DPTR
019D FF                MOV     R7,A
019E EF                MOV     A,R7
019F C3                CLR     C
01A0 9480              SUBB    A,#080H
01A2 5020              JNC     ?C0007
                                           ; SOURCE LINE # 58
01A4 900000      R     MOV     DPTR,#src_ptr
01A7 120000      E     LCALL   ?C?PLDXDATA
01AA 900000      R     MOV     DPTR,#i
01AD E0                MOVX    A,@DPTR
01AE FD                MOV     R5,A
01AF 120000      E     LCALL   _EEPROM_R_Write
                                           ; SOURCE LINE # 59
01B2 900000      R     MOV     DPTR,#src_ptr+01H
01B5 E4                CLR     A
01B6 75F010            MOV     B,#010H
01B9 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 60
01BC 900000      R     MOV     DPTR,#i
01BF E0                MOVX    A,@DPTR
01C0 04                INC     A
01C1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 61
01C2 80BF              SJMP    ?C0006
01C4         ?C0007:
                                           ; SOURCE LINE # 64
01C4 900000      R     MOV     DPTR,#buffer
01C7 120000      E     LCALL   ?C?PLDXDATA
01CA AE02              MOV     R6,AR2
01CC AF01              MOV     R7,AR1
01CE 120000      E     LCALL   _free
                                           ; SOURCE LINE # 66
01D1 120000      E     LCALL   EEPROM_LED_off
                                           ; SOURCE LINE # 69
01D4         ?C0008:
01D4 22                RET     
             ; FUNCTION _update_variable (END)

             ; FUNCTION _get_variable (BEGIN)
                                           ; SOURCE LINE # 71
0000 900000      R     MOV     DPTR,#var_index
0003 EE                MOV     A,R6
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 EF                MOV     A,R7
0007 F0                MOVX    @DPTR,A
C51 COMPILER V9.51   EEPROM_ACCESS                                                         04/25/2014 21:40:47 PAGE 8   

                                           ; SOURCE LINE # 72
0008 900000      R     MOV     DPTR,#value
000B E4                CLR     A
000C F0                MOVX    @DPTR,A
000D A3                INC     DPTR
000E 740A              MOV     A,#0AH
0010 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 74
0011 120000      E     LCALL   EEPROM_LED_on
                                           ; SOURCE LINE # 76
0014 900000      R     MOV     DPTR,#var_index
0017 E0                MOVX    A,@DPTR
0018 FE                MOV     R6,A
0019 A3                INC     DPTR
001A E0                MOVX    A,@DPTR
001B FF                MOV     R7,A
001C EF                MOV     A,R7
001D 2400              ADD     A,#00H
001F FF                MOV     R7,A
0020 EE                MOV     A,R6
0021 3480              ADDC    A,#080H
0023 FE                MOV     R6,A
0024 8F82              MOV     DPL,R7
0026 8E83              MOV     DPH,R6
0028 E0                MOVX    A,@DPTR
0029 FF                MOV     R7,A
002A 7E00              MOV     R6,#00H
002C EF                MOV     A,R7
002D 7F00              MOV     R7,#00H
002F FE                MOV     R6,A
0030 900000      R     MOV     DPTR,#value
0033 EE                MOV     A,R6
0034 F0                MOVX    @DPTR,A
0035 A3                INC     DPTR
0036 EF                MOV     A,R7
0037 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 77
0038 900000      R     MOV     DPTR,#var_index
003B E0                MOVX    A,@DPTR
003C FE                MOV     R6,A
003D A3                INC     DPTR
003E E0                MOVX    A,@DPTR
003F FF                MOV     R7,A
0040 EF                MOV     A,R7
0041 2401              ADD     A,#01H
0043 FF                MOV     R7,A
0044 EE                MOV     A,R6
0045 3480              ADDC    A,#080H
0047 FE                MOV     R6,A
0048 8F82              MOV     DPL,R7
004A 8E83              MOV     DPH,R6
004C E0                MOVX    A,@DPTR
004D FF                MOV     R7,A
004E 7E00              MOV     R6,#00H
0050 900000      R     MOV     DPTR,#value
0053 E0                MOVX    A,@DPTR
0054 FC                MOV     R4,A
0055 A3                INC     DPTR
0056 E0                MOVX    A,@DPTR
0057 FD                MOV     R5,A
0058 EE                MOV     A,R6
0059 4C                ORL     A,R4
C51 COMPILER V9.51   EEPROM_ACCESS                                                         04/25/2014 21:40:47 PAGE 9   

005A FE                MOV     R6,A
005B EF                MOV     A,R7
005C 4D                ORL     A,R5
005D FF                MOV     R7,A
005E 900000      R     MOV     DPTR,#value
0061 EE                MOV     A,R6
0062 F0                MOVX    @DPTR,A
0063 A3                INC     DPTR
0064 EF                MOV     A,R7
0065 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 79
0066 120000      E     LCALL   EEPROM_LED_off
                                           ; SOURCE LINE # 81
0069 900000      R     MOV     DPTR,#value
006C E0                MOVX    A,@DPTR
006D FE                MOV     R6,A
006E A3                INC     DPTR
006F E0                MOVX    A,@DPTR
0070 FF                MOV     R7,A
                                           ; SOURCE LINE # 82
0071         ?C0009:
0071 22                RET     
             ; FUNCTION _get_variable (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    583    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     29    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
