C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE USB_ACCESS
OBJECT MODULE PLACED IN .\DP8051\DP8051_Keil_951\Debug\USB_Access.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Cypress\PSoC Creator\3.0\PSoC Creator\import\keil\pk51\9.51\C51\BIN\c51.exe 
                    -.\USB_Access.c NOIV LARGE MODDP2 OMF2 VB(1) PR(.\DP8051\DP8051_Keil_951\Debug\USB_Access.lst) CD DB NOIP OT(0,SIZE) DF(D
                    -EBUG) INCDIR(.,.\Generated_Source\PSoC3) OJ(.\DP8051\DP8051_Keil_951\Debug\USB_Access.obj)

line level    source

   1          /* ========================================
   2           *
   3           * Copyright YOUR COMPANY, THE YEAR
   4           * All Rights Reserved
   5           * UNPUBLISHED, LICENSED SOFTWARE.
   6           *
   7           * CONFIDENTIAL AND PROPRIETARY INFORMATION
   8           * WHICH IS THE PROPERTY OF your company.
   9           *
  10           * ========================================
  11          */
  12          #include "USB_Access.h"
  13          #include "EmEEPROM_Access.h" // Location of sampled data in flash
  14          /* This file provides function definitions for USB interactions */
  15          
  16          void USB_ISR(){
  17   1          
  18   1          // Power has just been applied to the Vbus pin, so we enter USB communication mode
  19   1      
  20   1          uint8 result = 0;
  21   1          uint8 command = 0;
  22   1          USB_LED_on();
  23   1                 
  24   1          /* Start USBFS Operation with 5V operation */
  25   1          USBUART_Start(0u, USBUART_5V_OPERATION);
  26   1          
  27   1          /* Wait for Device to enumerate */
  28   1          while(!USBUART_GetConfiguration() && Vbus_Read());
  29   1      
  30   1          /* Enumeration is done, enable OUT endpoint for receive data from Host */
  31   1          USBUART_CDC_Init();
  32   1            
  33   1          while(Vbus_Read())
  34   1          {  
  35   2              if(USBUART_DataIsReady() != 0u){   /* Check for input data from PC */
  36   3                  result = retrieve(&command, COMMAND_LENGTH);
  37   3                  
  38   3                  // Discard null bytes
  39   3                  if (command == NULL_BYTE){
  40   4                      continue;
  41   4                  }
  42   3              
  43   3                  if (result == SUCCESS){
  44   4                      
  45   4                      switch (command){
  46   5                      
  47   5                          case IDENTIFY:
  48   5                              send_reply(IDENTIFIER);
  49   5                              break;
  50   5                          
  51   5                          case DUMP_DATA:
  52   5                              dump_data();
  53   5                              confirm_dump();
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 2   

  54   5                              break;
  55   5                              
  56   5                          case GET_SETTINGS:
  57   5                              send_settings();
  58   5                              break;
  59   5                              
  60   5                          case CHANGE_SETTING:
  61   5                              send_reply(SUCCESS);
  62   5                              if (apply_settings() == SUCCESS){
  63   6                                  send_reply(SUCCESS);
  64   6                              }
  65   5                              else{
  66   6                                  send_reply(FAIL);
  67   6                              }                  
  68   5                              break;
  69   5                           
  70   5                          case HARD_RESET:
  71   5                              hard_reset();
  72   5                              send_reply(SUCCESS);
  73   5                              break;
  74   5                              
  75   5                          default:
  76   5                              send_reply(FAIL);
  77   5                      }
  78   4                  }   
  79   3                  else{
  80   4                      send_reply(FAIL);
  81   4                  }
  82   3              }
  83   2          }
  84   1          
  85   1          USB_Close();
  86   1          USB_LED_off();
  87   1          
  88   1          return;
  89   1      }
  90          
  91          uint8 retrieve(uint8* buffer, uint8 num_bytes){
  92   1          uint16 count = 0;
  93   1          uint8 attempts = 0;
  94   1          uint8 result = SUCCESS;
  95   1          
  96   1          count = USBUART_GetCount(); 
  97   1          
  98   1          // If data in buffer is the right amount for a command,
  99   1          // retrieve it
 100   1          if(count == num_bytes){
 101   2              USBUART_GetData(buffer, num_bytes);
 102   2          }
 103   1          // Otherwise, flush the USB buffer and report fail
 104   1          else{
 105   2              USBUART_GetChar();
 106   2              result = FAIL;
 107   2          }
 108   1          
 109   1          return result;
 110   1      }
 111          
 112          uint8 apply_settings(){
 113   1          uint8 result = FAIL;
 114   1          uint8 settings_buffer[NUM_SETTINGS] = {0};
 115   1          settings_group new_settings;
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 3   

 116   1          
 117   1          while (!USBUART_DataIsReady() && Vbus_Read());
 118   1          
 119   1          if (Vbus_Read()){
 120   2              if (retrieve(settings_buffer, NUM_SETTINGS) == SUCCESS){
 121   3                  new_settings.sensor = settings_buffer[0];
 122   3                  new_settings.sample_unit = settings_buffer[1];
 123   3                  new_settings.sample_interval = settings_buffer[2];
 124   3                  
 125   3                  result = update_settings(new_settings);   
 126   3              }
 127   2          }
 128   1          
 129   1          
 130   1          return result;
 131   1      }
 132          
 133          void send_settings(){
 134   1          
 135   1          uint8 settings[NUM_SETTINGS];
 136   1          
 137   1          settings[0] = get_variable(EE_SENSOR);
 138   1          settings[1] = get_variable(EE_SAMPLE_UNIT);
 139   1          settings[2] = get_variable(EE_SAMPLE_INTERVAL);
 140   1          
 141   1          while(!USBUART_CDCIsReady() && Vbus_Read());
 142   1          
 143   1          if(Vbus_Read()){
 144   2              USBUART_PutData((uint8*) &settings, sizeof(settings));
 145   2          }
 146   1          
 147   1          return;   
 148   1      }
 149          
 150          void dump_data(){
 151   1          uint8  ExportBuffer[BUFFER_LEN]; // 64 Bytes per USB data packet.
 152   1          uint8* ExportPtr =(uint8*) MemoryLocation; 
 153   1          uint16 DataCnt = 0;
 154   1          uint8  i = 0;
 155   1          
 156   1          flash_LED_on();
 157   1          while (ExportPtr < TailPtr)
 158   1          {   
 159   2              while (i < BUFFER_LEN)
 160   2              {
 161   3                  if (ExportPtr < TailPtr)
 162   3                  {
 163   4                      ExportBuffer[i] = *ExportPtr; // Copy sampled data from flash at *ExportPtr to buffer for 
             -send over usb com 
 164   4                      ++i;
 165   4                      ++ExportPtr;
 166   4                      ++DataCnt;
 167   4                  }
 168   3                  else
 169   3                  {
 170   4                      ExportBuffer[i] = PADBYTE;
 171   4                      ++i;
 172   4                  }           
 173   3              }
 174   2              
 175   2              while(!USBUART_CDCIsReady() && Vbus_Read());
 176   2              USBUART_PutData(ExportBuffer, BUFFER_LEN); // Send 64 byte packet of data from memory
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 4   

 177   2              i = 0;
 178   2          }
 179   1          
 180   1          // Add the size trailer packet to get total transmission size
 181   1          DataCnt = DataCnt + 4;
 182   1          
 183   1          /* Trailer Packet to Identify End of Sampled Data in Memory */
 184   1          ExportBuffer[0] = 0x80;               // End of Data Identifier
 185   1          ExportBuffer[1] = 0x00;
 186   1          
 187   1          //2 byte Count split into two 1 byte packages to be arrayed.
 188   1          ExportBuffer[2] = (uint8)(DataCnt >> 8);;          // Count of Total Bytes Sent
 189   1          ExportBuffer[3] = (uint8)0x00FF & DataCnt;
 190   1          
 191   1          // Wait for UART to be ready
 192   1          while(!USBUART_CDCIsReady() && Vbus_Read());
 193   1          USBUART_PutData(ExportBuffer, 64u);
 194   1          
 195   1          flash_LED_off();
 196   1          
 197   1          return;
 198   1      }
 199          
 200          void send_reply(uint8 message){
 201   1         
 202   1          while(!USBUART_CDCIsReady() && Vbus_Read());
 203   1          
 204   1          if(Vbus_Read()){
 205   2              USBUART_PutData(&message, REPLY_LEN);
 206   2          }
 207   1          
 208   1          return;
 209   1      }
 210          
 211          void confirm_dump(){
 212   1          uint8 result = 0;
 213   1          uint8 command = 0;
 214   1          
 215   1          while(1){
 216   2              while(!USBUART_DataIsReady() && Vbus_Read());
 217   2              
 218   2              result = retrieve(&command, COMMAND_LENGTH);
 219   2              
 220   2              if(result == SUCCESS){
 221   3                  if (command == SUCCESS){
 222   4                      TailPtr = (uint8*) MemoryLocation;
 223   4                  }
 224   3                  break;
 225   3              }
 226   2          }
 227   1          
 228   1          return;
 229   1      }
 230          
 231          void CMD_hard_reset(){
 232   1      
 233   1          uint8 reset_flag = 0xFF;
 234   1          
 235   1          flash_LED_on();
 236   1          Em_EEPROM_Write(&reset_flag, &hard_reset_flag, 1u);
 237   1          flash_LED_off();
 238   1          
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 5   

 239   1          return;
 240   1      }
 241          
 242          void USB_Close(){
 243   1          
 244   1          EEPROM_R_Stop();
 245   1          USBUART_Stop();
 246   1          CySoftwareReset();
 247   1          
 248   1          return;
 249   1      }
 250          
 251          
 252          
 253          
 254          /* [] END OF FILE */
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 6   

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION USB_ISR (BEGIN)
                                           ; SOURCE LINE # 16
                                           ; SOURCE LINE # 20
0000 900000      R     MOV     DPTR,#result
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 21
0005 900000      R     MOV     DPTR,#command
0008 E4                CLR     A
0009 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 22
000A 120000      E     LCALL   USB_LED_on
                                           ; SOURCE LINE # 25
000D 7D01              MOV     R5,#01H
000F 7F00              MOV     R7,#00H
0011 120000      E     LCALL   _USBUART_Start
0014         ?C0001:
                                           ; SOURCE LINE # 28
0014 120000      E     LCALL   USBUART_GetConfiguration
0017 EF                MOV     A,R7
0018 7006              JNZ     ?C0002
001A 120000      E     LCALL   Vbus_Read
001D EF                MOV     A,R7
001E 70F4              JNZ     ?C0001
0020         ?C0002:
                                           ; SOURCE LINE # 31
0020 120000      E     LCALL   USBUART_CDC_Init
0023         ?C0003:
                                           ; SOURCE LINE # 33
0023 120000      E     LCALL   Vbus_Read
0026 EF                MOV     A,R7
0027 7003              JNZ     $ + 5H
0029 020000      R     LJMP    ?C0004
                                           ; SOURCE LINE # 34
                                           ; SOURCE LINE # 35
002C 120000      E     LCALL   USBUART_DataIsReady
002F EF                MOV     A,R7
0030 60F1              JZ      ?C0003
                                           ; SOURCE LINE # 36
0032 7B01              MOV     R3,#01H
0034 7A00        R     MOV     R2,#HIGH command
0036 7900        R     MOV     R1,#LOW command
0038 7D01              MOV     R5,#01H
003A 120000      R     LCALL   _retrieve
003D 900000      R     MOV     DPTR,#result
0040 EF                MOV     A,R7
0041 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 39
0042 900000      R     MOV     DPTR,#command
0045 E0                MOVX    A,@DPTR
0046 FF                MOV     R7,A
0047 EF                MOV     A,R7
0048 60D9              JZ      ?C0003
                                           ; SOURCE LINE # 40
                                           ; SOURCE LINE # 41
004A         ?C0006:
                                           ; SOURCE LINE # 43
004A 900000      R     MOV     DPTR,#result
004D E0                MOVX    A,@DPTR
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 7   

004E FF                MOV     R7,A
004F EF                MOV     A,R7
0050 6402              XRL     A,#02H
0052 705D              JNZ     ?C0007
                                           ; SOURCE LINE # 45
0054 900000      R     MOV     DPTR,#command
0057 E0                MOVX    A,@DPTR
0058 FF                MOV     R7,A
0059 EF                MOV     A,R7
005A 120000      E     LCALL   ?C?CCASE
005D 0000        R     DW      ?C0009
005F 01                DB      01H
0060 0000        R     DW      ?C0010
0062 02                DB      02H
0063 0000        R     DW      ?C0011
0065 03                DB      03H
0066 0000        R     DW      ?C0012
0068 04                DB      04H
0069 0000        R     DW      ?C0015
006B 05                DB      05H
006C 0000              DW      00H
006E 0000        R     DW      ?C0016
                                           ; SOURCE LINE # 47
0070         ?C0009:
                                           ; SOURCE LINE # 48
0070 7F01              MOV     R7,#01H
0072 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 49
0075 80AC              SJMP    ?C0003
                                           ; SOURCE LINE # 51
0077         ?C0010:
                                           ; SOURCE LINE # 52
0077 120000      R     LCALL   dump_data
                                           ; SOURCE LINE # 53
007A 120000      R     LCALL   confirm_dump
                                           ; SOURCE LINE # 54
007D 80A4              SJMP    ?C0003
                                           ; SOURCE LINE # 56
007F         ?C0011:
                                           ; SOURCE LINE # 57
007F 120000      R     LCALL   send_settings
                                           ; SOURCE LINE # 58
0082 809F              SJMP    ?C0003
                                           ; SOURCE LINE # 60
0084         ?C0012:
                                           ; SOURCE LINE # 61
0084 7F02              MOV     R7,#02H
0086 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 62
0089 120000      R     LCALL   apply_settings
008C EF                MOV     A,R7
008D B40207            CJNE    A,#02H,?C0013
                                           ; SOURCE LINE # 63
0090 7F02              MOV     R7,#02H
0092 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 64
0095 808C              SJMP    ?C0003
0097         ?C0013:
                                           ; SOURCE LINE # 65
                                           ; SOURCE LINE # 66
0097 7F03              MOV     R7,#03H
0099 120000      R     LCALL   _send_reply
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 8   

                                           ; SOURCE LINE # 67
009C         ?C0014:
                                           ; SOURCE LINE # 68
009C 8085              SJMP    ?C0003
                                           ; SOURCE LINE # 70
009E         ?C0015:
                                           ; SOURCE LINE # 71
009E 120000      E     LCALL   hard_reset
                                           ; SOURCE LINE # 72
00A1 7F02              MOV     R7,#02H
00A3 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 73
00A6 020000      R     LJMP    ?C0003
                                           ; SOURCE LINE # 75
00A9         ?C0016:
                                           ; SOURCE LINE # 76
00A9 7F03              MOV     R7,#03H
00AB 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 77
00AE         ?C0008:
                                           ; SOURCE LINE # 78
00AE 020000      R     LJMP    ?C0003
00B1         ?C0007:
                                           ; SOURCE LINE # 79
                                           ; SOURCE LINE # 80
00B1 7F03              MOV     R7,#03H
00B3 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 81
00B6         ?C0017:
                                           ; SOURCE LINE # 82
00B6         ?C0005:
                                           ; SOURCE LINE # 83
00B6 020000      R     LJMP    ?C0003
00B9         ?C0004:
                                           ; SOURCE LINE # 85
00B9 120000      R     LCALL   USB_Close
                                           ; SOURCE LINE # 86
00BC 120000      E     LCALL   USB_LED_off
                                           ; SOURCE LINE # 89
00BF         ?C0018:
00BF 22                RET     
             ; FUNCTION USB_ISR (END)

             ; FUNCTION _retrieve (BEGIN)
                                           ; SOURCE LINE # 91
0000 900000      R     MOV     DPTR,#buffer
0003 120000      E     LCALL   ?C?PSTXDATA
0006 900000      R     MOV     DPTR,#num_bytes
0009 ED                MOV     A,R5
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 92
000B 900000      R     MOV     DPTR,#count
000E E4                CLR     A
000F F0                MOVX    @DPTR,A
0010 A3                INC     DPTR
0011 E4                CLR     A
0012 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 93
0013 900000      R     MOV     DPTR,#attempts
0016 E4                CLR     A
0017 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 94
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 9   

0018 900000      R     MOV     DPTR,#result
001B 7402              MOV     A,#02H
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 96
001E 120000      E     LCALL   USBUART_GetCount
0021 900000      R     MOV     DPTR,#count
0024 EE                MOV     A,R6
0025 F0                MOVX    @DPTR,A
0026 A3                INC     DPTR
0027 EF                MOV     A,R7
0028 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 100
0029 900000      R     MOV     DPTR,#num_bytes
002C E0                MOVX    A,@DPTR
002D FF                MOV     R7,A
002E 7E00              MOV     R6,#00H
0030 900000      R     MOV     DPTR,#count
0033 E0                MOVX    A,@DPTR
0034 FC                MOV     R4,A
0035 A3                INC     DPTR
0036 E0                MOVX    A,@DPTR
0037 FD                MOV     R5,A
0038 EF                MOV     A,R7
0039 B50518            CJNE    A,AR5,?C0019
003C EE                MOV     A,R6
003D B50414            CJNE    A,AR4,?C0019
                                           ; SOURCE LINE # 101
0040 900000      R     MOV     DPTR,#buffer
0043 120000      E     LCALL   ?C?PLDXDATA
0046 900000      R     MOV     DPTR,#num_bytes
0049 E0                MOVX    A,@DPTR
004A FF                MOV     R7,A
004B EF                MOV     A,R7
004C FD                MOV     R5,A
004D 7C00              MOV     R4,#00H
004F 120000      E     LCALL   _USBUART_GetData
                                           ; SOURCE LINE # 102
0052 8009              SJMP    ?C0020
0054         ?C0019:
                                           ; SOURCE LINE # 104
                                           ; SOURCE LINE # 105
0054 120000      E     LCALL   USBUART_GetChar
                                           ; SOURCE LINE # 106
0057 900000      R     MOV     DPTR,#result
005A 7403              MOV     A,#03H
005C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 107
005D         ?C0020:
                                           ; SOURCE LINE # 109
005D 900000      R     MOV     DPTR,#result
0060 E0                MOVX    A,@DPTR
0061 FF                MOV     R7,A
                                           ; SOURCE LINE # 110
0062         ?C0021:
0062 22                RET     
             ; FUNCTION _retrieve (END)

             ; FUNCTION apply_settings (BEGIN)
                                           ; SOURCE LINE # 112
                                           ; SOURCE LINE # 113
0000 900000      R     MOV     DPTR,#result
0003 7403              MOV     A,#03H
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 10  

0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 114
0006 7BFF              MOV     R3,#0FFH
0008 7A00        R     MOV     R2,#HIGH _?ix1000
000A 7900        R     MOV     R1,#LOW _?ix1000
000C C003              PUSH    AR3
000E C002              PUSH    AR2
0010 C001              PUSH    AR1
0012 7B01              MOV     R3,#01H
0014 7A00        R     MOV     R2,#HIGH settings_buffer
0016 7900        R     MOV     R1,#LOW settings_buffer
0018 A801              MOV     R0,AR1
001A AC02              MOV     R4,AR2
001C AD03              MOV     R5,AR3
001E D001              POP     AR1
0020 D002              POP     AR2
0022 D003              POP     AR3
0024 7E00              MOV     R6,#00H
0026 7F03              MOV     R7,#03H
0028 120000      E     LCALL   ?C?COPYAMD
002B         ?C0022:
                                           ; SOURCE LINE # 117
002B 120000      E     LCALL   USBUART_DataIsReady
002E EF                MOV     A,R7
002F 7006              JNZ     ?C0023
0031 120000      E     LCALL   Vbus_Read
0034 EF                MOV     A,R7
0035 70F4              JNZ     ?C0022
0037         ?C0023:
                                           ; SOURCE LINE # 119
0037 120000      E     LCALL   Vbus_Read
003A EF                MOV     A,R7
003B 605B              JZ      ?C0024
                                           ; SOURCE LINE # 120
003D 7B01              MOV     R3,#01H
003F 7A00        R     MOV     R2,#HIGH settings_buffer
0041 7900        R     MOV     R1,#LOW settings_buffer
0043 7D03              MOV     R5,#03H
0045 120000      R     LCALL   _retrieve
0048 EF                MOV     A,R7
0049 6402              XRL     A,#02H
004B 704B              JNZ     ?C0024
                                           ; SOURCE LINE # 121
004D 900000      R     MOV     DPTR,#settings_buffer
0050 E0                MOVX    A,@DPTR
0051 FF                MOV     R7,A
0052 900000      R     MOV     DPTR,#new_settings
0055 EF                MOV     A,R7
0056 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 122
0057 900000      R     MOV     DPTR,#settings_buffer+01H
005A E0                MOVX    A,@DPTR
005B FF                MOV     R7,A
005C 900000      R     MOV     DPTR,#new_settings+01H
005F EF                MOV     A,R7
0060 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 123
0061 900000      R     MOV     DPTR,#settings_buffer+02H
0064 E0                MOVX    A,@DPTR
0065 FF                MOV     R7,A
0066 900000      R     MOV     DPTR,#new_settings+02H
0069 EF                MOV     A,R7
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 11  

006A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 125
006B 7B01              MOV     R3,#01H
006D 7A00        R     MOV     R2,#HIGH new_settings
006F 7900        R     MOV     R1,#LOW new_settings
0071 C003              PUSH    AR3
0073 C002              PUSH    AR2
0075 C001              PUSH    AR1
0077 7B01              MOV     R3,#01H
0079 7A00        E     MOV     R2,#HIGH ?update_settings?BYTE
007B 7900        E     MOV     R1,#LOW ?update_settings?BYTE
007D A801              MOV     R0,AR1
007F AC02              MOV     R4,AR2
0081 AD03              MOV     R5,AR3
0083 D001              POP     AR1
0085 D002              POP     AR2
0087 D003              POP     AR3
0089 7E00              MOV     R6,#00H
008B 7F03              MOV     R7,#03H
008D 120000      E     LCALL   ?C?COPYAMD
0090 120000      E     LCALL   update_settings
0093 900000      R     MOV     DPTR,#result
0096 EF                MOV     A,R7
0097 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 126
0098         ?C0025:
                                           ; SOURCE LINE # 127
0098         ?C0024:
                                           ; SOURCE LINE # 130
0098 900000      R     MOV     DPTR,#result
009B E0                MOVX    A,@DPTR
009C FF                MOV     R7,A
                                           ; SOURCE LINE # 131
009D         ?C0026:
009D 22                RET     
             ; FUNCTION apply_settings (END)

             ; FUNCTION send_settings (BEGIN)
                                           ; SOURCE LINE # 133
                                           ; SOURCE LINE # 137
0000 7F00              MOV     R7,#00H
0002 7E00              MOV     R6,#00H
0004 120000      E     LCALL   _get_variable
0007 900000      R     MOV     DPTR,#settings
000A EF                MOV     A,R7
000B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 138
000C 7F01              MOV     R7,#01H
000E 7E00              MOV     R6,#00H
0010 120000      E     LCALL   _get_variable
0013 900000      R     MOV     DPTR,#settings+01H
0016 EF                MOV     A,R7
0017 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 139
0018 7F02              MOV     R7,#02H
001A 7E00              MOV     R6,#00H
001C 120000      E     LCALL   _get_variable
001F 900000      R     MOV     DPTR,#settings+02H
0022 EF                MOV     A,R7
0023 F0                MOVX    @DPTR,A
0024         ?C0027:
                                           ; SOURCE LINE # 141
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 12  

0024 120000      E     LCALL   USBUART_CDCIsReady
0027 EF                MOV     A,R7
0028 7006              JNZ     ?C0028
002A 120000      E     LCALL   Vbus_Read
002D EF                MOV     A,R7
002E 70F4              JNZ     ?C0027
0030         ?C0028:
                                           ; SOURCE LINE # 143
0030 120000      E     LCALL   Vbus_Read
0033 EF                MOV     A,R7
0034 600D              JZ      ?C0030
                                           ; SOURCE LINE # 144
0036 7B01              MOV     R3,#01H
0038 7A00        R     MOV     R2,#HIGH settings
003A 7900        R     MOV     R1,#LOW settings
003C 7D03              MOV     R5,#03H
003E 7C00              MOV     R4,#00H
0040 120000      E     LCALL   _USBUART_PutData
                                           ; SOURCE LINE # 145
0043         ?C0029:
                                           ; SOURCE LINE # 148
0043         ?C0030:
0043 22                RET     
             ; FUNCTION send_settings (END)

             ; FUNCTION dump_data (BEGIN)
                                           ; SOURCE LINE # 150
                                           ; SOURCE LINE # 152
0000 7BFF              MOV     R3,#0FFH
0002 7A00        E     MOV     R2,#HIGH MemoryLocation
0004 7900        E     MOV     R1,#LOW MemoryLocation
0006 900000      R     MOV     DPTR,#ExportPtr
0009 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 153
000C 900000      R     MOV     DPTR,#DataCnt
000F E4                CLR     A
0010 F0                MOVX    @DPTR,A
0011 A3                INC     DPTR
0012 E4                CLR     A
0013 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 154
0014 900000      R     MOV     DPTR,#i
0017 E4                CLR     A
0018 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 156
0019 120000      E     LCALL   flash_LED_on
001C         ?C0031:
                                           ; SOURCE LINE # 157
001C 900000      E     MOV     DPTR,#TailPtr
001F 120000      E     LCALL   ?C?PLDXDATA
0022 C003              PUSH    AR3
0024 C002              PUSH    AR2
0026 C001              PUSH    AR1
0028 900000      R     MOV     DPTR,#ExportPtr
002B 120000      E     LCALL   ?C?PLDXDATA
002E C3                CLR     C
002F D082              POP     DPL
0031 D083              POP     DPH
0033 D0E0              POP     ACC
0035 E9                MOV     A,R1
0036 9582              SUBB    A,DPL
0038 EA                MOV     A,R2
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 13  

0039 9583              SUBB    A,DPH
003B         ?C0056:
003B 4003              JC      $ + 5H
003D 020000      R     LJMP    ?C0032
                                           ; SOURCE LINE # 158
0040         ?C0033:
                                           ; SOURCE LINE # 159
0040 900000      R     MOV     DPTR,#i
0043 E0                MOVX    A,@DPTR
0044 FF                MOV     R7,A
0045 EF                MOV     A,R7
0046 C3                CLR     C
0047 9440              SUBB    A,#040H
0049 5072              JNC     ?C0037
                                           ; SOURCE LINE # 160
                                           ; SOURCE LINE # 161
004B 900000      E     MOV     DPTR,#TailPtr
004E 120000      E     LCALL   ?C?PLDXDATA
0051 C003              PUSH    AR3
0053 C002              PUSH    AR2
0055 C001              PUSH    AR1
0057 900000      R     MOV     DPTR,#ExportPtr
005A 120000      E     LCALL   ?C?PLDXDATA
005D C3                CLR     C
005E D082              POP     DPL
0060 D083              POP     DPH
0062 D0E0              POP     ACC
0064 E9                MOV     A,R1
0065 9582              SUBB    A,DPL
0067 EA                MOV     A,R2
0068 9583              SUBB    A,DPH
006A         ?C0057:
006A 5037              JNC     ?C0035
                                           ; SOURCE LINE # 162
                                           ; SOURCE LINE # 163
006C 900000      R     MOV     DPTR,#ExportPtr
006F 120000      E     LCALL   ?C?PLDXDATA
0072 120000      E     LCALL   ?C?CLDPTR
0075 FF                MOV     R7,A
0076 900000      R     MOV     DPTR,#i
0079 E0                MOVX    A,@DPTR
007A FE                MOV     R6,A
007B 7400        R     MOV     A,#LOW ExportBuffer
007D 2E                ADD     A,R6
007E F582              MOV     DPL,A
0080 E4                CLR     A
0081 3400        R     ADDC    A,#HIGH ExportBuffer
0083 F583              MOV     DPH,A
0085 EF                MOV     A,R7
0086 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 164
0087 900000      R     MOV     DPTR,#i
008A E0                MOVX    A,@DPTR
008B 04                INC     A
008C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 165
008D 900000      R     MOV     DPTR,#ExportPtr+01H
0090 E4                CLR     A
0091 75F001            MOV     B,#01H
0094 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 166
0097 900000      R     MOV     DPTR,#DataCnt
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 14  

009A E4                CLR     A
009B 75F001            MOV     B,#01H
009E 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 167
00A1 809D              SJMP    ?C0033
00A3         ?C0035:
                                           ; SOURCE LINE # 169
                                           ; SOURCE LINE # 170
00A3 900000      R     MOV     DPTR,#i
00A6 E0                MOVX    A,@DPTR
00A7 FF                MOV     R7,A
00A8 7400        R     MOV     A,#LOW ExportBuffer
00AA 2F                ADD     A,R7
00AB F582              MOV     DPL,A
00AD E4                CLR     A
00AE 3400        R     ADDC    A,#HIGH ExportBuffer
00B0 F583              MOV     DPH,A
00B2 7440              MOV     A,#040H
00B4 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 171
00B5 900000      R     MOV     DPTR,#i
00B8 E0                MOVX    A,@DPTR
00B9 04                INC     A
00BA F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 172
00BB         ?C0036:
                                           ; SOURCE LINE # 173
00BB 8083              SJMP    ?C0033
00BD         ?C0034:
00BD         ?C0037:
                                           ; SOURCE LINE # 175
00BD 120000      E     LCALL   USBUART_CDCIsReady
00C0 EF                MOV     A,R7
00C1 7006              JNZ     ?C0038
00C3 120000      E     LCALL   Vbus_Read
00C6 EF                MOV     A,R7
00C7 70F4              JNZ     ?C0037
00C9         ?C0038:
                                           ; SOURCE LINE # 176
00C9 7B01              MOV     R3,#01H
00CB 7A00        R     MOV     R2,#HIGH ExportBuffer
00CD 7900        R     MOV     R1,#LOW ExportBuffer
00CF 7D40              MOV     R5,#040H
00D1 7C00              MOV     R4,#00H
00D3 120000      E     LCALL   _USBUART_PutData
                                           ; SOURCE LINE # 177
00D6 900000      R     MOV     DPTR,#i
00D9 E4                CLR     A
00DA F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 178
00DB 020000      R     LJMP    ?C0031
00DE         ?C0032:
                                           ; SOURCE LINE # 181
00DE 900000      R     MOV     DPTR,#DataCnt
00E1 E4                CLR     A
00E2 75F004            MOV     B,#04H
00E5 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 184
00E8 900000      R     MOV     DPTR,#ExportBuffer
00EB 7480              MOV     A,#080H
00ED F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 185
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 15  

00EE 900000      R     MOV     DPTR,#ExportBuffer+01H
00F1 E4                CLR     A
00F2 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 188
00F3 900000      R     MOV     DPTR,#DataCnt
00F6 E0                MOVX    A,@DPTR
00F7 FE                MOV     R6,A
00F8 A3                INC     DPTR
00F9 E0                MOVX    A,@DPTR
00FA FF                MOV     R7,A
00FB EE                MOV     A,R6
00FC FF                MOV     R7,A
00FD 7E00              MOV     R6,#00H
00FF 900000      R     MOV     DPTR,#ExportBuffer+02H
0102 EF                MOV     A,R7
0103 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 189
0104 900000      R     MOV     DPTR,#DataCnt
0107 E0                MOVX    A,@DPTR
0108 FE                MOV     R6,A
0109 A3                INC     DPTR
010A E0                MOVX    A,@DPTR
010B FF                MOV     R7,A
010C EF                MOV     A,R7
010D 54FF              ANL     A,#0FFH
010F FF                MOV     R7,A
0110 900000      R     MOV     DPTR,#ExportBuffer+03H
0113 EF                MOV     A,R7
0114 F0                MOVX    @DPTR,A
0115         ?C0039:
                                           ; SOURCE LINE # 192
0115 120000      E     LCALL   USBUART_CDCIsReady
0118 EF                MOV     A,R7
0119 7006              JNZ     ?C0040
011B 120000      E     LCALL   Vbus_Read
011E EF                MOV     A,R7
011F 70F4              JNZ     ?C0039
0121         ?C0040:
                                           ; SOURCE LINE # 193
0121 7B01              MOV     R3,#01H
0123 7A00        R     MOV     R2,#HIGH ExportBuffer
0125 7900        R     MOV     R1,#LOW ExportBuffer
0127 7D40              MOV     R5,#040H
0129 7C00              MOV     R4,#00H
012B 120000      E     LCALL   _USBUART_PutData
                                           ; SOURCE LINE # 195
012E 120000      E     LCALL   flash_LED_off
                                           ; SOURCE LINE # 198
0131         ?C0041:
0131 22                RET     
             ; FUNCTION dump_data (END)

             ; FUNCTION _send_reply (BEGIN)
                                           ; SOURCE LINE # 200
0000 900000      R     MOV     DPTR,#message
0003 EF                MOV     A,R7
0004 F0                MOVX    @DPTR,A
0005         ?C0042:
                                           ; SOURCE LINE # 202
0005 120000      E     LCALL   USBUART_CDCIsReady
0008 EF                MOV     A,R7
0009 7006              JNZ     ?C0043
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 16  

000B 120000      E     LCALL   Vbus_Read
000E EF                MOV     A,R7
000F 70F4              JNZ     ?C0042
0011         ?C0043:
                                           ; SOURCE LINE # 204
0011 120000      E     LCALL   Vbus_Read
0014 EF                MOV     A,R7
0015 600D              JZ      ?C0045
                                           ; SOURCE LINE # 205
0017 7B01              MOV     R3,#01H
0019 7A00        R     MOV     R2,#HIGH message
001B 7900        R     MOV     R1,#LOW message
001D 7D01              MOV     R5,#01H
001F 7C00              MOV     R4,#00H
0021 120000      E     LCALL   _USBUART_PutData
                                           ; SOURCE LINE # 206
0024         ?C0044:
                                           ; SOURCE LINE # 209
0024         ?C0045:
0024 22                RET     
             ; FUNCTION _send_reply (END)

             ; FUNCTION confirm_dump (BEGIN)
                                           ; SOURCE LINE # 211
                                           ; SOURCE LINE # 212
0000 900000      R     MOV     DPTR,#result
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 213
0005 900000      R     MOV     DPTR,#command
0008 E4                CLR     A
0009 F0                MOVX    @DPTR,A
000A         ?C0046:
                                           ; SOURCE LINE # 215
000A         ?C0048:
                                           ; SOURCE LINE # 216
000A 120000      E     LCALL   USBUART_DataIsReady
000D EF                MOV     A,R7
000E 7006              JNZ     ?C0049
0010 120000      E     LCALL   Vbus_Read
0013 EF                MOV     A,R7
0014 70F4              JNZ     ?C0048
0016         ?C0049:
                                           ; SOURCE LINE # 218
0016 7B01              MOV     R3,#01H
0018 7A00        R     MOV     R2,#HIGH command
001A 7900        R     MOV     R1,#LOW command
001C 7D01              MOV     R5,#01H
001E 120000      R     LCALL   _retrieve
0021 900000      R     MOV     DPTR,#result
0024 EF                MOV     A,R7
0025 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 220
0026 900000      R     MOV     DPTR,#result
0029 E0                MOVX    A,@DPTR
002A FF                MOV     R7,A
002B EF                MOV     A,R7
002C B402DB            CJNE    A,#02H,?C0048
                                           ; SOURCE LINE # 221
002F 900000      R     MOV     DPTR,#command
0032 E0                MOVX    A,@DPTR
0033 FF                MOV     R7,A
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 17  

0034 EF                MOV     A,R7
0035 B4020F            CJNE    A,#02H,?C0052
                                           ; SOURCE LINE # 222
0038 7BFF              MOV     R3,#0FFH
003A 7A00        E     MOV     R2,#HIGH MemoryLocation
003C 7900        E     MOV     R1,#LOW MemoryLocation
003E 900000      E     MOV     DPTR,#TailPtr
0041 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 223
0044         ?C0051:
                                           ; SOURCE LINE # 224
0044 22                RET     
                                           ; SOURCE LINE # 225
0045         ?C0050:
                                           ; SOURCE LINE # 226
0045 80C3              SJMP    ?C0048
0047         ?C0047:
                                           ; SOURCE LINE # 229
0047         ?C0052:
0047 22                RET     
             ; FUNCTION confirm_dump (END)

             ; FUNCTION CMD_hard_reset (BEGIN)
                                           ; SOURCE LINE # 231
                                           ; SOURCE LINE # 233
0000 900000      R     MOV     DPTR,#reset_flag
0003 74FF              MOV     A,#0FFH
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 235
0006 120000      E     LCALL   flash_LED_on
                                           ; SOURCE LINE # 236
0009 7B01              MOV     R3,#01H
000B 7A00        R     MOV     R2,#HIGH reset_flag
000D 7900        R     MOV     R1,#LOW reset_flag
000F C003              PUSH    AR3
0011 C002              PUSH    AR2
0013 C001              PUSH    AR1
0015 7BFF              MOV     R3,#0FFH
0017 7A00        E     MOV     R2,#HIGH hard_reset_flag
0019 7900        E     MOV     R1,#LOW hard_reset_flag
001B 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
001E 120000      E     LCALL   ?C?PSTXDATA
0021 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
0024 E4                CLR     A
0025 F0                MOVX    @DPTR,A
0026 A3                INC     DPTR
0027 7401              MOV     A,#01H
0029 F0                MOVX    @DPTR,A
002A D001              POP     AR1
002C D002              POP     AR2
002E D003              POP     AR3
0030 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 237
0033 120000      E     LCALL   flash_LED_off
                                           ; SOURCE LINE # 240
0036         ?C0053:
0036 22                RET     
             ; FUNCTION CMD_hard_reset (END)

             ; FUNCTION USB_Close (BEGIN)
                                           ; SOURCE LINE # 242
                                           ; SOURCE LINE # 244
C51 COMPILER V9.51   USB_ACCESS                                                            04/27/2014 21:53:24 PAGE 18  

0000 120000      E     LCALL   EEPROM_R_Stop
                                           ; SOURCE LINE # 245
0003 120000      E     LCALL   USBUART_Stop
                                           ; SOURCE LINE # 246
0006 120000      E     LCALL   CySoftwareReset
                                           ; SOURCE LINE # 249
0009         ?C0054:
0009 22                RET     
             ; FUNCTION USB_Close (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    997    ----
   CONSTANT SIZE    =      3    ----
   XDATA SIZE       =     94    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
