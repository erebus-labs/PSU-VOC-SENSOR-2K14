C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE SAMPLE_HANDLER
OBJECT MODULE PLACED IN .\DP8051\DP8051_Keil_951\Debug\sample_handler.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Cypress\PSoC Creator\3.0\PSoC Creator\import\keil\pk51\9.51\C51\BIN\c51.exe 
                    -.\sample_handler.c NOIV LARGE MODDP2 OMF2 VB(1) PR(.\DP8051\DP8051_Keil_951\Debug\sample_handler.lst) CD DB NOIP OT(0,SI
                    -ZE) DF(DEBUG) INCDIR(.,.\Generated_Source\PSoC3) OJ(.\DP8051\DP8051_Keil_951\Debug\sample_handler.obj)

line level    source

   1          /* ========================================
   2           *
   3           * (c) Erebus Labs Ltd. 2014
   4           *
   5           * Project: Erebus Labs Sensor
   6           * File:    sample_handler.c
   7           *
   8           * Handles sampling and manages the sample block pointers
   9           *
  10           * ========================================
  11          */
  12          
  13          #include "sample_handler.h"
  14          
  15          void sampling_setup(){
  16   1      /*
  17   1       * Retrieves sample unit and interval settings from EEPROM and sets RTC interrupt masks
  18   1       * accordingly. The Second and Minute interrupts from the RTC are always enabled 
  19   1       * low battery blinking and battery level checking, respectively. 
  20   1      */
  21   1      
  22   1          uint8 RTC_int_mask = MINUTE_MASK | SECOND_MASK;  
  23   1          sample_unit = get_EEPROM_variable(EE_SAMPLE_UNIT);
  24   1          sample_interval = get_EEPROM_variable(EE_SAMPLE_INTERVAL);
  25   1          
  26   1          switch (sample_unit)
  27   1          {
  28   2              case SAMPLE_HOUR: 
  29   2                  RTC_int_mask = RTC_int_mask | HOUR_MASK;
  30   2                  break;
  31   2              case SAMPLE_DAY: 
  32   2                  RTC_int_mask = RTC_int_mask | DAY_MASK;
  33   2                  break;
  34   2          }
  35   1          
  36   1          RTC_WriteIntervalMask(RTC_int_mask);
  37   1          RTC_EnableInt();
  38   1          
  39   1          return;
  40   1       }
  41          
  42          void start_collection(){
  43   1      /*
  44   1       * Triggered when sampling is not currently active and the user pushes the Start 
  45   1       * Sampling button. Stores a timestamp, the sensor being used, the sample interval, and
  46   1       * the interval unit in Flash as a header to the samples.
  47   1      */
  48   1          
  49   1          struct header_package header;
  50   1          RTC_TIME_DATE* datetime = RTC_ReadTime();
  51   1          
  52   1           /* Construct Header */
  53   1          header.start_block = STARTBLOCK;
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 2   

  54   1          header.sample_sensor = get_EEPROM_variable(EE_SENSOR);
  55   1          header.sample_unit = get_EEPROM_variable(EE_SAMPLE_UNIT);
  56   1          header.sample_interval = get_EEPROM_variable(EE_SAMPLE_INTERVAL);
  57   1          header.second = datetime -> Sec;
  58   1          header.minute = datetime -> Min;
  59   1          header.hour = datetime -> Hour;
  60   1          header.day = datetime -> DayOfMonth;
  61   1          header.month = datetime -> Month;
  62   1          header.year = datetime -> Year;
  63   1          
  64   1          if (store_in_flash((uint8*) &header, sizeof(struct header_package))){
  65   2              memory_full();
  66   2              stop_collection();
  67   2              goto exit;
  68   2          }
  69   1          
  70   1          StopCollection_IRQ_Start();
  71   1          StartCollection_IRQ_Stop();
  72   1      
  73   1          sample_enable_flag = 1;
  74   1          sample_interrupt_count = 0;
  75   1      
  76   1      exit:
  77   1          return;   
  78   1      }
  79          
  80          void take_sample() {
  81   1      /*
  82   1       * Triggered when the sample interrupt counter reaches the sample interval. Wakes up 
  83   1       * the ADC, takes a 16-bit sample, scales it to 12 bits, and stores the result in 
  84   1       * Flash. 
  85   1      */
  86   1      
  87   1          uint16 sample = 0;
  88   1          ADC_Wakeup();
  89   1          
  90   1          sample = ADC_Read16(); 
  91   1          sample = (sample >> SAMPLE_SHIFT) & SAMPLE_MASK;
  92   1          
  93   1          if (store_in_flash((uint8*) &sample, sizeof(uint16))){
  94   2              memory_full();
  95   2              stop_collection();
  96   2          }
  97   1          
  98   1          ADC_Sleep();
  99   1          return;    
 100   1      }
 101          
 102          void stop_collection(){
 103   1      /*
 104   1       * Triggered when sampling is currently active and the user pushes the Stop
 105   1       * Sampling button. Stores a timestamp, the sensor being used, the sample interval, and
 106   1       * the interval unit in Flash as a header to the samples.
 107   1      */
 108   1          
 109   1          StartCollection_IRQ_Start();
 110   1          StopCollection_IRQ_Stop();
 111   1          sample_enable_flag = 0;
 112   1          
 113   1          return;   
 114   1      }
 115          
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 3   

 116          uint8 store_in_flash(uint8* buffer, uint8 num_bytes){  
 117   1      /* 
 118   1       * Is a helper function to store data in the sample array. Before storing the buffer
 119   1       * in Flash, it first confirms that there is enough from for it. It also tracks the 
 120   1       * sample tail index's position in the array so it can be moved to element 0 if the
 121   1       * end of the array is reached.
 122   1      */
 123   1      
 124   1          int byte_diff = 0;
 125   1          int remaining_bytes = 0;
 126   1          uint8 result = 0;
 127   1            
 128   1          /* Calculate number of bytes remaining in the sample block */ 
 129   1          remaining_bytes = sample_head_index - sample_tail_index;
 130   1          if (remaining_bytes < 0){
 131   2              remaining_bytes = SAMPLE_BLOCK_SIZE + remaining_bytes;
 132   2          }
 133   1      
 134   1          /* Confirm there is enough space left */
 135   1          /* Ignore case where head and tail are the same location - that is allowed
 136   1           * when there are currently no samples or headers stored */
 137   1          if (remaining_bytes < num_bytes && (sample_head_index != sample_tail_index)){
 138   2              result = 1;
 139   2              goto exit;
 140   2          }
 141   1          
 142   1          /* Check to see if the whole buffer can fit before the end of the array
 143   1           * This will usually be the case */
 144   1          if ((sample_tail_index + num_bytes) <= SAMPLE_BLOCK_SIZE){
 145   2      
 146   2              Em_EEPROM_Write(buffer, (uint8*) &(sample_block[sample_tail_index]), num_bytes);
 147   2              sample_tail_index = sample_tail_index + num_bytes;
 148   2              
 149   2              if (sample_tail_index == SAMPLE_BLOCK_SIZE){
 150   3                  sample_tail_index = 0;
 151   3              }
 152   2          }
 153   1          else{
 154   2              /* It didn't fit, so now we have to do extra work to split the buffer 
 155   2               * Start by writing whatever will fit before the end of the array */
 156   2              remaining_bytes = SAMPLE_BLOCK_SIZE - sample_tail_index;
 157   2              Em_EEPROM_Write(buffer, 
 158   2                              (uint8*) &(sample_block[sample_tail_index]), 
 159   2                              remaining_bytes);
 160   2              
 161   2              /* Write remaining bytes at the top of the array */
 162   2              Em_EEPROM_Write((buffer + remaining_bytes), 
 163   2                              sample_block, 
 164   2                              num_bytes - remaining_bytes);
 165   2      
 166   2              sample_tail_index = num_bytes - remaining_bytes;
 167   2          }
 168   1          
 169   1          /* Store new tail pointer in Flash */
 170   1          Em_EEPROM_Write((uint8*) &sample_tail_index, 
 171   1                          (uint8*) &(current_sample_indices[pointer_tail_index]), 
 172   1                          sizeof(uint16));
 173   1          
 174   1          /* If we head is now equal to tail, we have filled our buffer */
 175   1          if (sample_tail_index == sample_head_index){
 176   2              result = 1;
 177   2          }
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 4   

 178   1              
 179   1      exit:
 180   1          return (result);
 181   1      }
 182          
 183          void clear_samples(){
 184   1      /* 
 185   1       * Called after data has been dumped through the GUI. Moves the current head index
 186   1       * up to the same location as the current tail. If this means the head pointer is
 187   1       * advanced past the end of the array and wrapped around, then it is time to increment
 188   1       * the master sample indices and store the sample head/tail indices in a new location in
 189   1       * their array for wear levelling.
 190   1      */
 191   1      
 192   1          /* If we just wrapped our sampling around the end of the array, it's time to 
 193   1           * bump the sample pointers to the next Flash row for wear-levelling */
 194   1          if (sample_head_index > sample_tail_index){
 195   2              pointer_head_index += FLASH_ROW_LENGTH;
 196   2              
 197   2              if (pointer_head_index >= FLASH_ROW_LENGTH * MASTER_ROWS){
 198   3                  pointer_head_index = HEAD_INDEX;
 199   3              }
 200   2              
 201   2              pointer_tail_index = pointer_head_index + TAIL_INDEX;
 202   2              
 203   2              /* Save the new indexes of the head and tail pointers */
 204   2              Em_EEPROM_Write((uint8*) &pointer_head_index, 
 205   2                              (uint8*) &(master_sample_indices[HEAD_INDEX]), 
 206   2                              sizeof(uint16));
 207   2      
 208   2              Em_EEPROM_Write((uint8*) &pointer_tail_index, 
 209   2                              (uint8*) &(master_sample_indices[TAIL_INDEX]), 
 210   2                              sizeof(uint16));
 211   2              
 212   2              /* Copy current tail to its new location */
 213   2              Em_EEPROM_Write((uint8*) &sample_tail_index, 
 214   2                              (uint8*) &(current_sample_indices[pointer_tail_index]), 
 215   2                              sizeof(uint16));
 216   2          }
 217   1          
 218   1          /* Update bring head up to current tail position */
 219   1          sample_head_index = sample_tail_index; 
 220   1          Em_EEPROM_Write((uint8*) &sample_tail_index, 
 221   1                          (uint8*) &(current_sample_indices[pointer_head_index]), 
 222   1                          sizeof(uint16));
 223   1          
 224   1          /* If memory full flag was set, clear it */
 225   1          if (mem_full_flag){
 226   2              mem_full_flag = 0;
 227   2              Em_EEPROM_Write(&mem_full_flag, &mem_full_flash_flag, sizeof(uint8));
 228   2          }
 229   1                  
 230   1          return;
 231   1      }
 232          
 233          void reset_pointers(){
 234   1      /* 
 235   1       * Only invoked by the user through the GUI. Initializes the sample indexes to the tops
 236   1       * of both the sample and sample indices arrays. This must be run once after programming
 237   1       * before attempting to store any samples.
 238   1      */
 239   1          
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 5   

 240   1          pointer_head_index = HEAD_INDEX;
 241   1          pointer_tail_index = TAIL_INDEX;
 242   1          sample_head_index = 0x0;
 243   1          sample_tail_index = 0x0;
 244   1              
 245   1          /* reset master pointers */
 246   1          Em_EEPROM_Write((uint8*) &pointer_head_index, 
 247   1                          (uint8*) &(master_sample_indices[HEAD_INDEX]), 
 248   1                          sizeof(uint16));
 249   1      
 250   1          Em_EEPROM_Write((uint8*) &pointer_tail_index, 
 251   1                          (uint8*) &(master_sample_indices[TAIL_INDEX]), 
 252   1                          sizeof(uint16));
 253   1          
 254   1          /* reset sample pointers to the top of the sample block */
 255   1          Em_EEPROM_Write((uint8*) &sample_head_index, 
 256   1                          (uint8*) &(current_sample_indices[HEAD_INDEX]), 
 257   1                          sizeof(uint16));
 258   1      
 259   1          Em_EEPROM_Write((uint8*) &sample_tail_index, 
 260   1                          (uint8*) &(current_sample_indices[TAIL_INDEX]), 
 261   1                          sizeof(uint16));
 262   1          
 263   1          return;
 264   1      }
 265             
 266          /* [] END OF FILE */
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 6   

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION sampling_setup (BEGIN)
                                           ; SOURCE LINE # 15
                                           ; SOURCE LINE # 22
0000 900000      R     MOV     DPTR,#RTC_int_mask
0003 7403              MOV     A,#03H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 23
0006 7F01              MOV     R7,#01H
0008 7E00              MOV     R6,#00H
000A 120000      E     LCALL   _get_EEPROM_variable
000D 900000      E     MOV     DPTR,#sample_unit
0010 EF                MOV     A,R7
0011 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 24
0012 7F02              MOV     R7,#02H
0014 7E00              MOV     R6,#00H
0016 120000      E     LCALL   _get_EEPROM_variable
0019 900000      E     MOV     DPTR,#sample_interval
001C EF                MOV     A,R7
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 26
001E 900000      E     MOV     DPTR,#sample_unit
0021 E0                MOVX    A,@DPTR
0022 FF                MOV     R7,A
0023 EF                MOV     A,R7
0024 120000      E     LCALL   ?C?CCASE
0027 0000        R     DW      ?C0002
0029 02                DB      02H
002A 0000        R     DW      ?C0003
002C 03                DB      03H
002D 0000              DW      00H
002F 0000        R     DW      ?C0001
                                           ; SOURCE LINE # 27
                                           ; SOURCE LINE # 28
0031         ?C0002:
                                           ; SOURCE LINE # 29
0031 900000      R     MOV     DPTR,#RTC_int_mask
0034 E0                MOVX    A,@DPTR
0035 FF                MOV     R7,A
0036 EF                MOV     A,R7
0037 4404              ORL     A,#04H
0039 FF                MOV     R7,A
003A 900000      R     MOV     DPTR,#RTC_int_mask
003D EF                MOV     A,R7
003E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 30
003F 800E              SJMP    ?C0001
                                           ; SOURCE LINE # 31
0041         ?C0003:
                                           ; SOURCE LINE # 32
0041 900000      R     MOV     DPTR,#RTC_int_mask
0044 E0                MOVX    A,@DPTR
0045 FF                MOV     R7,A
0046 EF                MOV     A,R7
0047 4408              ORL     A,#08H
0049 FF                MOV     R7,A
004A 900000      R     MOV     DPTR,#RTC_int_mask
004D EF                MOV     A,R7
004E F0                MOVX    @DPTR,A
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 7   

                                           ; SOURCE LINE # 33
                                           ; SOURCE LINE # 34
004F         ?C0001:
                                           ; SOURCE LINE # 36
004F 900000      R     MOV     DPTR,#RTC_int_mask
0052 E0                MOVX    A,@DPTR
0053 FF                MOV     R7,A
0054 120000      E     LCALL   _RTC_WriteIntervalMask
                                           ; SOURCE LINE # 37
0057 120000      E     LCALL   RTC_EnableInt
                                           ; SOURCE LINE # 40
005A         ?C0004:
005A 22                RET     
             ; FUNCTION sampling_setup (END)

             ; FUNCTION start_collection (BEGIN)
                                           ; SOURCE LINE # 42
                                           ; SOURCE LINE # 50
0000 120000      E     LCALL   RTC_ReadTime
0003 900000      R     MOV     DPTR,#datetime
0006 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 53
0009 900000      R     MOV     DPTR,#header
000C 7420              MOV     A,#020H
000E F0                MOVX    @DPTR,A
000F A3                INC     DPTR
0010 E4                CLR     A
0011 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 54
0012 7F00              MOV     R7,#00H
0014 7E00              MOV     R6,#00H
0016 120000      E     LCALL   _get_EEPROM_variable
0019 900000      R     MOV     DPTR,#header+04H
001C EF                MOV     A,R7
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 55
001E 7F01              MOV     R7,#01H
0020 7E00              MOV     R6,#00H
0022 120000      E     LCALL   _get_EEPROM_variable
0025 900000      R     MOV     DPTR,#header+05H
0028 EF                MOV     A,R7
0029 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 56
002A 7F02              MOV     R7,#02H
002C 7E00              MOV     R6,#00H
002E 120000      E     LCALL   _get_EEPROM_variable
0031 900000      R     MOV     DPTR,#header+06H
0034 EF                MOV     A,R7
0035 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 57
0036 900000      R     MOV     DPTR,#datetime
0039 120000      E     LCALL   ?C?PLDXDATA
003C 120000      E     LCALL   ?C?CLDPTR
003F FF                MOV     R7,A
0040 900000      R     MOV     DPTR,#header+07H
0043 EF                MOV     A,R7
0044 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 58
0045 900000      R     MOV     DPTR,#datetime
0048 120000      E     LCALL   ?C?PLDXDATA
004B E9                MOV     A,R1
004C 2401              ADD     A,#01H
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 8   

004E F9                MOV     R1,A
004F EA                MOV     A,R2
0050 3400              ADDC    A,#00H
0052 FA                MOV     R2,A
0053 120000      E     LCALL   ?C?CLDPTR
0056 FF                MOV     R7,A
0057 900000      R     MOV     DPTR,#header+08H
005A EF                MOV     A,R7
005B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 59
005C 900000      R     MOV     DPTR,#datetime
005F 120000      E     LCALL   ?C?PLDXDATA
0062 E9                MOV     A,R1
0063 2402              ADD     A,#02H
0065 F9                MOV     R1,A
0066 EA                MOV     A,R2
0067 3400              ADDC    A,#00H
0069 FA                MOV     R2,A
006A 120000      E     LCALL   ?C?CLDPTR
006D FF                MOV     R7,A
006E 900000      R     MOV     DPTR,#header+09H
0071 EF                MOV     A,R7
0072 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 60
0073 900000      R     MOV     DPTR,#datetime
0076 120000      E     LCALL   ?C?PLDXDATA
0079 E9                MOV     A,R1
007A 2404              ADD     A,#04H
007C F9                MOV     R1,A
007D EA                MOV     A,R2
007E 3400              ADDC    A,#00H
0080 FA                MOV     R2,A
0081 120000      E     LCALL   ?C?CLDPTR
0084 FF                MOV     R7,A
0085 900000      R     MOV     DPTR,#header+0AH
0088 EF                MOV     A,R7
0089 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 61
008A 900000      R     MOV     DPTR,#datetime
008D 120000      E     LCALL   ?C?PLDXDATA
0090 E9                MOV     A,R1
0091 2407              ADD     A,#07H
0093 F9                MOV     R1,A
0094 EA                MOV     A,R2
0095 3400              ADDC    A,#00H
0097 FA                MOV     R2,A
0098 120000      E     LCALL   ?C?CLDPTR
009B FF                MOV     R7,A
009C 900000      R     MOV     DPTR,#header+0BH
009F EF                MOV     A,R7
00A0 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 62
00A1 900000      R     MOV     DPTR,#datetime
00A4 120000      E     LCALL   ?C?PLDXDATA
00A7 E9                MOV     A,R1
00A8 2408              ADD     A,#08H
00AA F9                MOV     R1,A
00AB EA                MOV     A,R2
00AC 3400              ADDC    A,#00H
00AE FA                MOV     R2,A
00AF 120000      E     LCALL   ?C?ILDPTR
00B2 FF                MOV     R7,A
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 9   

00B3 AEF0              MOV     R6,B
00B5 900000      R     MOV     DPTR,#header+02H
00B8 EE                MOV     A,R6
00B9 F0                MOVX    @DPTR,A
00BA A3                INC     DPTR
00BB EF                MOV     A,R7
00BC F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 64
00BD 7B01              MOV     R3,#01H
00BF 7A00        R     MOV     R2,#HIGH header
00C1 7900        R     MOV     R1,#LOW header
00C3 7D10              MOV     R5,#010H
00C5 120000      R     LCALL   _store_in_flash
00C8 EF                MOV     A,R7
00C9 6007              JZ      ?C0005
                                           ; SOURCE LINE # 65
00CB 120000      E     LCALL   memory_full
                                           ; SOURCE LINE # 66
00CE 120000      R     LCALL   stop_collection
                                           ; SOURCE LINE # 67
00D1 22                RET     
                                           ; SOURCE LINE # 68
00D2         ?C0005:
                                           ; SOURCE LINE # 70
00D2 120000      E     LCALL   StopCollection_IRQ_Start
                                           ; SOURCE LINE # 71
00D5 120000      E     LCALL   StartCollection_IRQ_Stop
                                           ; SOURCE LINE # 73
00D8 900000      E     MOV     DPTR,#sample_enable_flag
00DB 7401              MOV     A,#01H
00DD F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 74
00DE 900000      E     MOV     DPTR,#sample_interrupt_count
00E1 E4                CLR     A
00E2 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 76
00E3         exit:
                                           ; SOURCE LINE # 78
00E3         ?C0007:
00E3 22                RET     
             ; FUNCTION start_collection (END)

             ; FUNCTION take_sample (BEGIN)
                                           ; SOURCE LINE # 80
                                           ; SOURCE LINE # 87
0000 900000      R     MOV     DPTR,#sample
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
0006 E4                CLR     A
0007 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 88
0008 120000      E     LCALL   ADC_Wakeup
                                           ; SOURCE LINE # 90
000B 120000      E     LCALL   ADC_Read16
000E 900000      R     MOV     DPTR,#sample
0011 EE                MOV     A,R6
0012 F0                MOVX    @DPTR,A
0013 A3                INC     DPTR
0014 EF                MOV     A,R7
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 91
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 10  

0016 900000      R     MOV     DPTR,#sample
0019 E0                MOVX    A,@DPTR
001A FE                MOV     R6,A
001B A3                INC     DPTR
001C E0                MOVX    A,@DPTR
001D FF                MOV     R7,A
001E EE                MOV     A,R6
001F C4                SWAP    A
0020 F8                MOV     R0,A
0021 54F0              ANL     A,#0F0H
0023 C8                XCH     A,R0
0024 68                XRL     A,R0
0025 FE                MOV     R6,A
0026 EF                MOV     A,R7
0027 C4                SWAP    A
0028 540F              ANL     A,#0FH
002A 48                ORL     A,R0
002B FF                MOV     R7,A
002C EE                MOV     A,R6
002D 540F              ANL     A,#0FH
002F FE                MOV     R6,A
0030 900000      R     MOV     DPTR,#sample
0033 EE                MOV     A,R6
0034 F0                MOVX    @DPTR,A
0035 A3                INC     DPTR
0036 EF                MOV     A,R7
0037 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 93
0038 7B01              MOV     R3,#01H
003A 7A00        R     MOV     R2,#HIGH sample
003C 7900        R     MOV     R1,#LOW sample
003E 7D02              MOV     R5,#02H
0040 120000      R     LCALL   _store_in_flash
0043 EF                MOV     A,R7
0044 6006              JZ      ?C0008
                                           ; SOURCE LINE # 94
0046 120000      E     LCALL   memory_full
                                           ; SOURCE LINE # 95
0049 120000      R     LCALL   stop_collection
                                           ; SOURCE LINE # 96
004C         ?C0008:
                                           ; SOURCE LINE # 98
004C 120000      E     LCALL   ADC_Sleep
                                           ; SOURCE LINE # 100
004F         ?C0009:
004F 22                RET     
             ; FUNCTION take_sample (END)

             ; FUNCTION stop_collection (BEGIN)
                                           ; SOURCE LINE # 102
                                           ; SOURCE LINE # 109
0000 120000      E     LCALL   StartCollection_IRQ_Start
                                           ; SOURCE LINE # 110
0003 120000      E     LCALL   StopCollection_IRQ_Stop
                                           ; SOURCE LINE # 111
0006 900000      E     MOV     DPTR,#sample_enable_flag
0009 E4                CLR     A
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 114
000B         ?C0010:
000B 22                RET     
             ; FUNCTION stop_collection (END)
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 11  


             ; FUNCTION _store_in_flash (BEGIN)
                                           ; SOURCE LINE # 116
0000 900000      R     MOV     DPTR,#buffer
0003 120000      E     LCALL   ?C?PSTXDATA
0006 900000      R     MOV     DPTR,#num_bytes
0009 ED                MOV     A,R5
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 124
000B 900000      R     MOV     DPTR,#byte_diff
000E E4                CLR     A
000F F0                MOVX    @DPTR,A
0010 A3                INC     DPTR
0011 E4                CLR     A
0012 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 125
0013 900000      R     MOV     DPTR,#remaining_bytes
0016 E4                CLR     A
0017 F0                MOVX    @DPTR,A
0018 A3                INC     DPTR
0019 E4                CLR     A
001A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 126
001B 900000      R     MOV     DPTR,#result
001E E4                CLR     A
001F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 129
0020 900000      E     MOV     DPTR,#sample_tail_index
0023 E0                MOVX    A,@DPTR
0024 FE                MOV     R6,A
0025 A3                INC     DPTR
0026 E0                MOVX    A,@DPTR
0027 FF                MOV     R7,A
0028 900000      E     MOV     DPTR,#sample_head_index
002B E0                MOVX    A,@DPTR
002C FC                MOV     R4,A
002D A3                INC     DPTR
002E E0                MOVX    A,@DPTR
002F FD                MOV     R5,A
0030 C3                CLR     C
0031 ED                MOV     A,R5
0032 9F                SUBB    A,R7
0033 FF                MOV     R7,A
0034 EC                MOV     A,R4
0035 9E                SUBB    A,R6
0036 FE                MOV     R6,A
0037 900000      R     MOV     DPTR,#remaining_bytes
003A EE                MOV     A,R6
003B F0                MOVX    @DPTR,A
003C A3                INC     DPTR
003D EF                MOV     A,R7
003E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 130
003F 900000      R     MOV     DPTR,#remaining_bytes
0042 E0                MOVX    A,@DPTR
0043 FE                MOV     R6,A
0044 A3                INC     DPTR
0045 E0                MOVX    A,@DPTR
0046 FF                MOV     R7,A
0047 C3                CLR     C
0048 EE                MOV     A,R6
0049 6480              XRL     A,#080H
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 12  

004B 9480              SUBB    A,#080H
004D 5018              JNC     ?C0011
                                           ; SOURCE LINE # 131
004F 900000      R     MOV     DPTR,#remaining_bytes
0052 E0                MOVX    A,@DPTR
0053 FE                MOV     R6,A
0054 A3                INC     DPTR
0055 E0                MOVX    A,@DPTR
0056 FF                MOV     R7,A
0057 EF                MOV     A,R7
0058 24A8              ADD     A,#0A8H
005A FF                MOV     R7,A
005B EE                MOV     A,R6
005C 3461              ADDC    A,#061H
005E FE                MOV     R6,A
005F 900000      R     MOV     DPTR,#remaining_bytes
0062 EE                MOV     A,R6
0063 F0                MOVX    @DPTR,A
0064 A3                INC     DPTR
0065 EF                MOV     A,R7
0066 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 132
0067         ?C0011:
                                           ; SOURCE LINE # 137
0067 900000      R     MOV     DPTR,#num_bytes
006A E0                MOVX    A,@DPTR
006B FF                MOV     R7,A
006C 7E00              MOV     R6,#00H
006E 900000      R     MOV     DPTR,#remaining_bytes
0071 E0                MOVX    A,@DPTR
0072 FC                MOV     R4,A
0073 A3                INC     DPTR
0074 E0                MOVX    A,@DPTR
0075 FD                MOV     R5,A
0076 C3                CLR     C
0077 ED                MOV     A,R5
0078 9F                SUBB    A,R7
0079 EE                MOV     A,R6
007A 6480              XRL     A,#080H
007C F8                MOV     R0,A
007D EC                MOV     A,R4
007E 6480              XRL     A,#080H
0080 98                SUBB    A,R0
0081 5021              JNC     ?C0012
0083 900000      E     MOV     DPTR,#sample_tail_index
0086 E0                MOVX    A,@DPTR
0087 FE                MOV     R6,A
0088 A3                INC     DPTR
0089 E0                MOVX    A,@DPTR
008A FF                MOV     R7,A
008B 900000      E     MOV     DPTR,#sample_head_index
008E E0                MOVX    A,@DPTR
008F FC                MOV     R4,A
0090 A3                INC     DPTR
0091 E0                MOVX    A,@DPTR
0092 FD                MOV     R5,A
0093 ED                MOV     A,R5
0094 6F                XRL     A,R7
0095 7002              JNZ     ?C0024
0097 EC                MOV     A,R4
0098 6E                XRL     A,R6
0099         ?C0024:
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 13  

0099 6009              JZ      ?C0012
                                           ; SOURCE LINE # 138
009B 900000      R     MOV     DPTR,#result
009E 7401              MOV     A,#01H
00A0 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 139
00A1 020000      R     LJMP    exit
                                           ; SOURCE LINE # 140
00A4         ?C0012:
                                           ; SOURCE LINE # 144
00A4 900000      R     MOV     DPTR,#num_bytes
00A7 E0                MOVX    A,@DPTR
00A8 FF                MOV     R7,A
00A9 7E00              MOV     R6,#00H
00AB 900000      E     MOV     DPTR,#sample_tail_index
00AE E0                MOVX    A,@DPTR
00AF FC                MOV     R4,A
00B0 A3                INC     DPTR
00B1 E0                MOVX    A,@DPTR
00B2 FD                MOV     R5,A
00B3 EF                MOV     A,R7
00B4 2D                ADD     A,R5
00B5 FF                MOV     R7,A
00B6 EE                MOV     A,R6
00B7 3C                ADDC    A,R4
00B8 FE                MOV     R6,A
00B9 D3                SETB    C
00BA EF                MOV     A,R7
00BB 94A8              SUBB    A,#0A8H
00BD EE                MOV     A,R6
00BE 9461              SUBB    A,#061H
00C0 506C              JNC     ?C0014
                                           ; SOURCE LINE # 146
00C2 900000      R     MOV     DPTR,#buffer
00C5 120000      E     LCALL   ?C?PLDXDATA
00C8 C003              PUSH    AR3
00CA C002              PUSH    AR2
00CC C001              PUSH    AR1
00CE 900000      E     MOV     DPTR,#sample_tail_index
00D1 E0                MOVX    A,@DPTR
00D2 FE                MOV     R6,A
00D3 A3                INC     DPTR
00D4 E0                MOVX    A,@DPTR
00D5 FF                MOV     R7,A
00D6 7400        E     MOV     A,#LOW sample_block
00D8 2F                ADD     A,R7
00D9 F9                MOV     R1,A
00DA 7400        E     MOV     A,#HIGH sample_block
00DC 3E                ADDC    A,R6
00DD FA                MOV     R2,A
00DE 7BFF              MOV     R3,#0FFH
00E0 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
00E3 120000      E     LCALL   ?C?PSTXDATA
00E6 900000      R     MOV     DPTR,#num_bytes
00E9 E0                MOVX    A,@DPTR
00EA FF                MOV     R7,A
00EB 7E00              MOV     R6,#00H
00ED 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
00F0 EE                MOV     A,R6
00F1 F0                MOVX    @DPTR,A
00F2 A3                INC     DPTR
00F3 EF                MOV     A,R7
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 14  

00F4 F0                MOVX    @DPTR,A
00F5 D001              POP     AR1
00F7 D002              POP     AR2
00F9 D003              POP     AR3
00FB 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 147
00FE 900000      R     MOV     DPTR,#num_bytes
0101 E0                MOVX    A,@DPTR
0102 FF                MOV     R7,A
0103 7E00              MOV     R6,#00H
0105 900000      E     MOV     DPTR,#sample_tail_index
0108 EE                MOV     A,R6
0109 8FF0              MOV     B,R7
010B 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 149
010E 900000      E     MOV     DPTR,#sample_tail_index
0111 E0                MOVX    A,@DPTR
0112 FE                MOV     R6,A
0113 A3                INC     DPTR
0114 E0                MOVX    A,@DPTR
0115 FF                MOV     R7,A
0116 EF                MOV     A,R7
0117 64A8              XRL     A,#0A8H
0119 7003              JNZ     ?C0025
011B EE                MOV     A,R6
011C 6461              XRL     A,#061H
011E         ?C0025:
011E 6003              JZ      $ + 5H
0120 020000      R     LJMP    ?C0016
                                           ; SOURCE LINE # 150
0123 900000      E     MOV     DPTR,#sample_tail_index
0126 E4                CLR     A
0127 F0                MOVX    @DPTR,A
0128 A3                INC     DPTR
0129 E4                CLR     A
012A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 151
012B         ?C0015:
                                           ; SOURCE LINE # 152
012B 020000      R     LJMP    ?C0016
012E         ?C0014:
                                           ; SOURCE LINE # 153
                                           ; SOURCE LINE # 156
012E 900000      E     MOV     DPTR,#sample_tail_index
0131 E0                MOVX    A,@DPTR
0132 FE                MOV     R6,A
0133 A3                INC     DPTR
0134 E0                MOVX    A,@DPTR
0135 FF                MOV     R7,A
0136 C3                CLR     C
0137 74A8              MOV     A,#0A8H
0139 9F                SUBB    A,R7
013A FF                MOV     R7,A
013B 7461              MOV     A,#061H
013D 9E                SUBB    A,R6
013E FE                MOV     R6,A
013F 900000      R     MOV     DPTR,#remaining_bytes
0142 EE                MOV     A,R6
0143 F0                MOVX    @DPTR,A
0144 A3                INC     DPTR
0145 EF                MOV     A,R7
0146 F0                MOVX    @DPTR,A
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 15  

                                           ; SOURCE LINE # 158
0147 900000      R     MOV     DPTR,#buffer
014A 120000      E     LCALL   ?C?PLDXDATA
014D C003              PUSH    AR3
014F C002              PUSH    AR2
0151 C001              PUSH    AR1
0153 900000      E     MOV     DPTR,#sample_tail_index
0156 E0                MOVX    A,@DPTR
0157 FE                MOV     R6,A
0158 A3                INC     DPTR
0159 E0                MOVX    A,@DPTR
015A FF                MOV     R7,A
015B 7400        E     MOV     A,#LOW sample_block
015D 2F                ADD     A,R7
015E F9                MOV     R1,A
015F 7400        E     MOV     A,#HIGH sample_block
0161 3E                ADDC    A,R6
0162 FA                MOV     R2,A
0163 7BFF              MOV     R3,#0FFH
0165 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
0168 120000      E     LCALL   ?C?PSTXDATA
016B 900000      R     MOV     DPTR,#remaining_bytes
016E E0                MOVX    A,@DPTR
016F FE                MOV     R6,A
0170 A3                INC     DPTR
0171 E0                MOVX    A,@DPTR
0172 FF                MOV     R7,A
0173 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
0176 EE                MOV     A,R6
0177 F0                MOVX    @DPTR,A
0178 A3                INC     DPTR
0179 EF                MOV     A,R7
017A F0                MOVX    @DPTR,A
017B D001              POP     AR1
017D D002              POP     AR2
017F D003              POP     AR3
0181 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 162
0184 900000      R     MOV     DPTR,#buffer
0187 120000      E     LCALL   ?C?PLDXDATA
018A 900000      R     MOV     DPTR,#remaining_bytes
018D E0                MOVX    A,@DPTR
018E FE                MOV     R6,A
018F A3                INC     DPTR
0190 E0                MOVX    A,@DPTR
0191 FF                MOV     R7,A
0192 E9                MOV     A,R1
0193 2F                ADD     A,R7
0194 F9                MOV     R1,A
0195 EA                MOV     A,R2
0196 3E                ADDC    A,R6
0197 FA                MOV     R2,A
0198 C003              PUSH    AR3
019A C002              PUSH    AR2
019C C001              PUSH    AR1
019E 7BFF              MOV     R3,#0FFH
01A0 7A00        E     MOV     R2,#HIGH sample_block
01A2 7900        E     MOV     R1,#LOW sample_block
01A4 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
01A7 120000      E     LCALL   ?C?PSTXDATA
01AA 900000      R     MOV     DPTR,#num_bytes
01AD E0                MOVX    A,@DPTR
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 16  

01AE FF                MOV     R7,A
01AF 7E00              MOV     R6,#00H
01B1 900000      R     MOV     DPTR,#remaining_bytes
01B4 E0                MOVX    A,@DPTR
01B5 FC                MOV     R4,A
01B6 A3                INC     DPTR
01B7 E0                MOVX    A,@DPTR
01B8 FD                MOV     R5,A
01B9 C3                CLR     C
01BA EF                MOV     A,R7
01BB 9D                SUBB    A,R5
01BC FF                MOV     R7,A
01BD EE                MOV     A,R6
01BE 9C                SUBB    A,R4
01BF FE                MOV     R6,A
01C0 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
01C3 EE                MOV     A,R6
01C4 F0                MOVX    @DPTR,A
01C5 A3                INC     DPTR
01C6 EF                MOV     A,R7
01C7 F0                MOVX    @DPTR,A
01C8 D001              POP     AR1
01CA D002              POP     AR2
01CC D003              POP     AR3
01CE 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 166
01D1 900000      R     MOV     DPTR,#num_bytes
01D4 E0                MOVX    A,@DPTR
01D5 FF                MOV     R7,A
01D6 7E00              MOV     R6,#00H
01D8 900000      R     MOV     DPTR,#remaining_bytes
01DB E0                MOVX    A,@DPTR
01DC FC                MOV     R4,A
01DD A3                INC     DPTR
01DE E0                MOVX    A,@DPTR
01DF FD                MOV     R5,A
01E0 C3                CLR     C
01E1 EF                MOV     A,R7
01E2 9D                SUBB    A,R5
01E3 FF                MOV     R7,A
01E4 EE                MOV     A,R6
01E5 9C                SUBB    A,R4
01E6 FE                MOV     R6,A
01E7 900000      E     MOV     DPTR,#sample_tail_index
01EA EE                MOV     A,R6
01EB F0                MOVX    @DPTR,A
01EC A3                INC     DPTR
01ED EF                MOV     A,R7
01EE F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 167
01EF         ?C0016:
                                           ; SOURCE LINE # 171
01EF 7B01              MOV     R3,#01H
01F1 7A00        E     MOV     R2,#HIGH sample_tail_index
01F3 7900        E     MOV     R1,#LOW sample_tail_index
01F5 C003              PUSH    AR3
01F7 C002              PUSH    AR2
01F9 C001              PUSH    AR1
01FB 900000      E     MOV     DPTR,#pointer_tail_index
01FE E0                MOVX    A,@DPTR
01FF FE                MOV     R6,A
0200 A3                INC     DPTR
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 17  

0201 E0                MOVX    A,@DPTR
0202 FF                MOV     R7,A
0203 EF                MOV     A,R7
0204 25E0              ADD     A,ACC
0206 FF                MOV     R7,A
0207 EE                MOV     A,R6
0208 33                RLC     A
0209 FE                MOV     R6,A
020A 7400        E     MOV     A,#LOW current_sample_indices
020C 2F                ADD     A,R7
020D F9                MOV     R1,A
020E 7400        E     MOV     A,#HIGH current_sample_indices
0210 3E                ADDC    A,R6
0211 FA                MOV     R2,A
0212 7BFF              MOV     R3,#0FFH
0214 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
0217 120000      E     LCALL   ?C?PSTXDATA
021A 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
021D E4                CLR     A
021E F0                MOVX    @DPTR,A
021F A3                INC     DPTR
0220 7402              MOV     A,#02H
0222 F0                MOVX    @DPTR,A
0223 D001              POP     AR1
0225 D002              POP     AR2
0227 D003              POP     AR3
0229 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 175
022C 900000      E     MOV     DPTR,#sample_head_index
022F E0                MOVX    A,@DPTR
0230 FE                MOV     R6,A
0231 A3                INC     DPTR
0232 E0                MOVX    A,@DPTR
0233 FF                MOV     R7,A
0234 900000      E     MOV     DPTR,#sample_tail_index
0237 E0                MOVX    A,@DPTR
0238 FC                MOV     R4,A
0239 A3                INC     DPTR
023A E0                MOVX    A,@DPTR
023B FD                MOV     R5,A
023C ED                MOV     A,R5
023D B5070A            CJNE    A,AR7,exit
0240 EC                MOV     A,R4
0241 B50606            CJNE    A,AR6,exit
                                           ; SOURCE LINE # 176
0244 900000      R     MOV     DPTR,#result
0247 7401              MOV     A,#01H
0249 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 177
024A         ?C0017:
                                           ; SOURCE LINE # 179
024A         exit:
                                           ; SOURCE LINE # 180
024A 900000      R     MOV     DPTR,#result
024D E0                MOVX    A,@DPTR
024E FF                MOV     R7,A
                                           ; SOURCE LINE # 181
024F         ?C0018:
024F 22                RET     
             ; FUNCTION _store_in_flash (END)

             ; FUNCTION clear_samples (BEGIN)
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 18  

                                           ; SOURCE LINE # 183
                                           ; SOURCE LINE # 194
0000 900000      E     MOV     DPTR,#sample_tail_index
0003 E0                MOVX    A,@DPTR
0004 FE                MOV     R6,A
0005 A3                INC     DPTR
0006 E0                MOVX    A,@DPTR
0007 FF                MOV     R7,A
0008 900000      E     MOV     DPTR,#sample_head_index
000B E0                MOVX    A,@DPTR
000C FC                MOV     R4,A
000D A3                INC     DPTR
000E E0                MOVX    A,@DPTR
000F FD                MOV     R5,A
0010 D3                SETB    C
0011 ED                MOV     A,R5
0012 9F                SUBB    A,R7
0013 EC                MOV     A,R4
0014 9E                SUBB    A,R6
0015 5003              JNC     $ + 5H
0017 020000      R     LJMP    ?C0019
                                           ; SOURCE LINE # 195
001A 900000      E     MOV     DPTR,#pointer_head_index
001D 7401              MOV     A,#01H
001F 75F020            MOV     B,#020H
0022 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 197
0025 900000      E     MOV     DPTR,#pointer_head_index
0028 E0                MOVX    A,@DPTR
0029 FE                MOV     R6,A
002A A3                INC     DPTR
002B E0                MOVX    A,@DPTR
002C FF                MOV     R7,A
002D C3                CLR     C
002E EF                MOV     A,R7
002F 9460              SUBB    A,#060H
0031 EE                MOV     A,R6
0032 9403              SUBB    A,#03H
0034 4008              JC      ?C0020
                                           ; SOURCE LINE # 198
0036 900000      E     MOV     DPTR,#pointer_head_index
0039 E4                CLR     A
003A F0                MOVX    @DPTR,A
003B A3                INC     DPTR
003C E4                CLR     A
003D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 199
003E         ?C0020:
                                           ; SOURCE LINE # 201
003E 900000      E     MOV     DPTR,#pointer_head_index
0041 E0                MOVX    A,@DPTR
0042 FE                MOV     R6,A
0043 A3                INC     DPTR
0044 E0                MOVX    A,@DPTR
0045 FF                MOV     R7,A
0046 EF                MOV     A,R7
0047 2401              ADD     A,#01H
0049 FF                MOV     R7,A
004A EE                MOV     A,R6
004B 3400              ADDC    A,#00H
004D FE                MOV     R6,A
004E 900000      E     MOV     DPTR,#pointer_tail_index
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 19  

0051 EE                MOV     A,R6
0052 F0                MOVX    @DPTR,A
0053 A3                INC     DPTR
0054 EF                MOV     A,R7
0055 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 205
0056 7B01              MOV     R3,#01H
0058 7A00        E     MOV     R2,#HIGH pointer_head_index
005A 7900        E     MOV     R1,#LOW pointer_head_index
005C C003              PUSH    AR3
005E C002              PUSH    AR2
0060 C001              PUSH    AR1
0062 7BFF              MOV     R3,#0FFH
0064 7A00        E     MOV     R2,#HIGH master_sample_indices
0066 7900        E     MOV     R1,#LOW master_sample_indices
0068 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
006B 120000      E     LCALL   ?C?PSTXDATA
006E 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
0071 E4                CLR     A
0072 F0                MOVX    @DPTR,A
0073 A3                INC     DPTR
0074 7402              MOV     A,#02H
0076 F0                MOVX    @DPTR,A
0077 D001              POP     AR1
0079 D002              POP     AR2
007B D003              POP     AR3
007D 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 209
0080 7B01              MOV     R3,#01H
0082 7A00        E     MOV     R2,#HIGH pointer_tail_index
0084 7900        E     MOV     R1,#LOW pointer_tail_index
0086 C003              PUSH    AR3
0088 C002              PUSH    AR2
008A C001              PUSH    AR1
008C 7BFF              MOV     R3,#0FFH
008E 7A00        E     MOV     R2,#HIGH master_sample_indices+02H
0090 7900        E     MOV     R1,#LOW master_sample_indices+02H
0092 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
0095 120000      E     LCALL   ?C?PSTXDATA
0098 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
009B E4                CLR     A
009C F0                MOVX    @DPTR,A
009D A3                INC     DPTR
009E 7402              MOV     A,#02H
00A0 F0                MOVX    @DPTR,A
00A1 D001              POP     AR1
00A3 D002              POP     AR2
00A5 D003              POP     AR3
00A7 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 214
00AA 7B01              MOV     R3,#01H
00AC 7A00        E     MOV     R2,#HIGH sample_tail_index
00AE 7900        E     MOV     R1,#LOW sample_tail_index
00B0 C003              PUSH    AR3
00B2 C002              PUSH    AR2
00B4 C001              PUSH    AR1
00B6 900000      E     MOV     DPTR,#pointer_tail_index
00B9 E0                MOVX    A,@DPTR
00BA FE                MOV     R6,A
00BB A3                INC     DPTR
00BC E0                MOVX    A,@DPTR
00BD FF                MOV     R7,A
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 20  

00BE EF                MOV     A,R7
00BF 25E0              ADD     A,ACC
00C1 FF                MOV     R7,A
00C2 EE                MOV     A,R6
00C3 33                RLC     A
00C4 FE                MOV     R6,A
00C5 7400        E     MOV     A,#LOW current_sample_indices
00C7 2F                ADD     A,R7
00C8 F9                MOV     R1,A
00C9 7400        E     MOV     A,#HIGH current_sample_indices
00CB 3E                ADDC    A,R6
00CC FA                MOV     R2,A
00CD 7BFF              MOV     R3,#0FFH
00CF 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
00D2 120000      E     LCALL   ?C?PSTXDATA
00D5 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
00D8 E4                CLR     A
00D9 F0                MOVX    @DPTR,A
00DA A3                INC     DPTR
00DB 7402              MOV     A,#02H
00DD F0                MOVX    @DPTR,A
00DE D001              POP     AR1
00E0 D002              POP     AR2
00E2 D003              POP     AR3
00E4 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 216
00E7         ?C0019:
                                           ; SOURCE LINE # 219
00E7 900000      E     MOV     DPTR,#sample_tail_index
00EA E0                MOVX    A,@DPTR
00EB FE                MOV     R6,A
00EC A3                INC     DPTR
00ED E0                MOVX    A,@DPTR
00EE FF                MOV     R7,A
00EF 900000      E     MOV     DPTR,#sample_head_index
00F2 EE                MOV     A,R6
00F3 F0                MOVX    @DPTR,A
00F4 A3                INC     DPTR
00F5 EF                MOV     A,R7
00F6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 221
00F7 7B01              MOV     R3,#01H
00F9 7A00        E     MOV     R2,#HIGH sample_tail_index
00FB 7900        E     MOV     R1,#LOW sample_tail_index
00FD C003              PUSH    AR3
00FF C002              PUSH    AR2
0101 C001              PUSH    AR1
0103 900000      E     MOV     DPTR,#pointer_head_index
0106 E0                MOVX    A,@DPTR
0107 FE                MOV     R6,A
0108 A3                INC     DPTR
0109 E0                MOVX    A,@DPTR
010A FF                MOV     R7,A
010B EF                MOV     A,R7
010C 25E0              ADD     A,ACC
010E FF                MOV     R7,A
010F EE                MOV     A,R6
0110 33                RLC     A
0111 FE                MOV     R6,A
0112 7400        E     MOV     A,#LOW current_sample_indices
0114 2F                ADD     A,R7
0115 F9                MOV     R1,A
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 21  

0116 7400        E     MOV     A,#HIGH current_sample_indices
0118 3E                ADDC    A,R6
0119 FA                MOV     R2,A
011A 7BFF              MOV     R3,#0FFH
011C 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
011F 120000      E     LCALL   ?C?PSTXDATA
0122 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
0125 E4                CLR     A
0126 F0                MOVX    @DPTR,A
0127 A3                INC     DPTR
0128 7402              MOV     A,#02H
012A F0                MOVX    @DPTR,A
012B D001              POP     AR1
012D D002              POP     AR2
012F D003              POP     AR3
0131 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 225
0134 900000      E     MOV     DPTR,#mem_full_flag
0137 E0                MOVX    A,@DPTR
0138 FF                MOV     R7,A
0139 EF                MOV     A,R7
013A 602F              JZ      ?C0022
                                           ; SOURCE LINE # 226
013C 900000      E     MOV     DPTR,#mem_full_flag
013F E4                CLR     A
0140 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 227
0141 7B01              MOV     R3,#01H
0143 7A00        E     MOV     R2,#HIGH mem_full_flag
0145 7900        E     MOV     R1,#LOW mem_full_flag
0147 C003              PUSH    AR3
0149 C002              PUSH    AR2
014B C001              PUSH    AR1
014D 7BFF              MOV     R3,#0FFH
014F 7A00        E     MOV     R2,#HIGH mem_full_flash_flag
0151 7900        E     MOV     R1,#LOW mem_full_flash_flag
0153 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
0156 120000      E     LCALL   ?C?PSTXDATA
0159 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
015C E4                CLR     A
015D F0                MOVX    @DPTR,A
015E A3                INC     DPTR
015F 7401              MOV     A,#01H
0161 F0                MOVX    @DPTR,A
0162 D001              POP     AR1
0164 D002              POP     AR2
0166 D003              POP     AR3
0168 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 228
016B         ?C0021:
                                           ; SOURCE LINE # 231
016B         ?C0022:
016B 22                RET     
             ; FUNCTION clear_samples (END)

             ; FUNCTION reset_pointers (BEGIN)
                                           ; SOURCE LINE # 233
                                           ; SOURCE LINE # 240
0000 900000      E     MOV     DPTR,#pointer_head_index
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
0005 A3                INC     DPTR
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 22  

0006 E4                CLR     A
0007 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 241
0008 900000      E     MOV     DPTR,#pointer_tail_index
000B E4                CLR     A
000C F0                MOVX    @DPTR,A
000D A3                INC     DPTR
000E 7401              MOV     A,#01H
0010 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 242
0011 900000      E     MOV     DPTR,#sample_head_index
0014 E4                CLR     A
0015 F0                MOVX    @DPTR,A
0016 A3                INC     DPTR
0017 E4                CLR     A
0018 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 243
0019 900000      E     MOV     DPTR,#sample_tail_index
001C E4                CLR     A
001D F0                MOVX    @DPTR,A
001E A3                INC     DPTR
001F E4                CLR     A
0020 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 247
0021 7B01              MOV     R3,#01H
0023 7A00        E     MOV     R2,#HIGH pointer_head_index
0025 7900        E     MOV     R1,#LOW pointer_head_index
0027 C003              PUSH    AR3
0029 C002              PUSH    AR2
002B C001              PUSH    AR1
002D 7BFF              MOV     R3,#0FFH
002F 7A00        E     MOV     R2,#HIGH master_sample_indices
0031 7900        E     MOV     R1,#LOW master_sample_indices
0033 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
0036 120000      E     LCALL   ?C?PSTXDATA
0039 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
003C E4                CLR     A
003D F0                MOVX    @DPTR,A
003E A3                INC     DPTR
003F 7402              MOV     A,#02H
0041 F0                MOVX    @DPTR,A
0042 D001              POP     AR1
0044 D002              POP     AR2
0046 D003              POP     AR3
0048 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 251
004B 7B01              MOV     R3,#01H
004D 7A00        E     MOV     R2,#HIGH pointer_tail_index
004F 7900        E     MOV     R1,#LOW pointer_tail_index
0051 C003              PUSH    AR3
0053 C002              PUSH    AR2
0055 C001              PUSH    AR1
0057 7BFF              MOV     R3,#0FFH
0059 7A00        E     MOV     R2,#HIGH master_sample_indices+02H
005B 7900        E     MOV     R1,#LOW master_sample_indices+02H
005D 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
0060 120000      E     LCALL   ?C?PSTXDATA
0063 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
0066 E4                CLR     A
0067 F0                MOVX    @DPTR,A
0068 A3                INC     DPTR
0069 7402              MOV     A,#02H
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 23  

006B F0                MOVX    @DPTR,A
006C D001              POP     AR1
006E D002              POP     AR2
0070 D003              POP     AR3
0072 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 256
0075 7B01              MOV     R3,#01H
0077 7A00        E     MOV     R2,#HIGH sample_head_index
0079 7900        E     MOV     R1,#LOW sample_head_index
007B C003              PUSH    AR3
007D C002              PUSH    AR2
007F C001              PUSH    AR1
0081 7BFF              MOV     R3,#0FFH
0083 7A00        E     MOV     R2,#HIGH current_sample_indices
0085 7900        E     MOV     R1,#LOW current_sample_indices
0087 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
008A 120000      E     LCALL   ?C?PSTXDATA
008D 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
0090 E4                CLR     A
0091 F0                MOVX    @DPTR,A
0092 A3                INC     DPTR
0093 7402              MOV     A,#02H
0095 F0                MOVX    @DPTR,A
0096 D001              POP     AR1
0098 D002              POP     AR2
009A D003              POP     AR3
009C 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 260
009F 7B01              MOV     R3,#01H
00A1 7A00        E     MOV     R2,#HIGH sample_tail_index
00A3 7900        E     MOV     R1,#LOW sample_tail_index
00A5 C003              PUSH    AR3
00A7 C002              PUSH    AR2
00A9 C001              PUSH    AR1
00AB 7BFF              MOV     R3,#0FFH
00AD 7A00        E     MOV     R2,#HIGH current_sample_indices+02H
00AF 7900        E     MOV     R1,#LOW current_sample_indices+02H
00B1 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+03H
00B4 120000      E     LCALL   ?C?PSTXDATA
00B7 900000      E     MOV     DPTR,#?_Em_EEPROM_Write?BYTE+06H
00BA E4                CLR     A
00BB F0                MOVX    @DPTR,A
00BC A3                INC     DPTR
00BD 7402              MOV     A,#02H
00BF F0                MOVX    @DPTR,A
00C0 D001              POP     AR1
00C2 D002              POP     AR2
00C4 D003              POP     AR3
00C6 120000      E     LCALL   _Em_EEPROM_Write
                                           ; SOURCE LINE # 264
00C9         ?C0023:
00C9 22                RET     
             ; FUNCTION reset_pointers (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1569    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     31    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
C51 COMPILER V9.51   SAMPLE_HANDLER                                                        05/30/2014 15:03:35 PAGE 24  

   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
