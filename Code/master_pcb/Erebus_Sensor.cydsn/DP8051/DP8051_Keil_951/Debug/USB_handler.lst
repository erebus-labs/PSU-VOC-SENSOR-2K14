C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE USB_HANDLER
OBJECT MODULE PLACED IN .\DP8051\DP8051_Keil_951\Debug\USB_handler.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Cypress\PSoC Creator\3.0\PSoC Creator\import\keil\pk51\9.51\C51\BIN\c51.exe 
                    -.\USB_handler.c NOIV LARGE MODDP2 OMF2 VB(1) PR(.\DP8051\DP8051_Keil_951\Debug\USB_handler.lst) CD DB NOIP OT(0,SIZE) DF
                    -(DEBUG) INCDIR(.,.\Generated_Source\PSoC3) OJ(.\DP8051\DP8051_Keil_951\Debug\USB_handler.obj)

line level    source

   1          /* ========================================
   2           *
   3           * (c) Erebus Labs Ltd. 2014
   4           *
   5           * Project: Erebus Labs Sensor
   6           * File:    USB_handler.c
   7           *
   8           * Handles USB communication and USB host-initiated tasks
   9           *
  10           * ========================================
  11          */
  12          
  13          #include "USB_handler.h"
  14          
  15          void Run_USB(){
  16   1      /*
  17   1       * Handles all USB communication with the host. Calls functions based on received
  18   1       * commands.
  19   1      */
  20   1          
  21   1          /* Power has just been applied to the Vbus pin, so we enter USB communication mode */
  22   1      
  23   1          uint8 result = 0;
  24   1          uint8 command = 0;
  25   1          
  26   1          RTC_WriteIntervalMask(NONE_MASK);
  27   1          ModifyCollection_IRQ_Stop();
  28   1          Vbus_IRQ_Stop();
  29   1      
  30   1          USBUART_Start(0u, USBUART_5V_OPERATION);
  31   1          
  32   1          /* Wait for Device to enumerate */
  33   1          while(!USBUART_GetConfiguration() && Vbus_Read());
  34   1      
  35   1          /* Enumeration is done, enable OUT endpoint for receive data from Host */
  36   1          USBUART_CDC_Init();
  37   1          
  38   1          while(Vbus_Read())
  39   1          {  
  40   2              if (USBUART_DataIsReady() == 0u){   /* Check for input data from PC */
  41   3                  continue;
  42   3              }
  43   2      
  44   2              result = retrieve_from_buffer(&command, COMMAND_LENGTH);
  45   2              
  46   2              /* Discard zero-length packets */
  47   2              if (command == NULL_BYTE){
  48   3                  continue;
  49   3              }
  50   2          
  51   2              /* Identify command and perform action */
  52   2              if (result == SUCCESS){
  53   3                  
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 2   

  54   3                  switch (command){
  55   4                  
  56   4                      case IDENTIFY:
  57   4                          send_reply(IDENTIFIER);
  58   4                          break;
  59   4                      
  60   4                      case DUMP_DATA:
  61   4                          if (export_samples()){
  62   5                              confirm_export();
  63   5                          }
  64   4                          else{
  65   5                              send_reply(FAIL);
  66   5                          }
  67   4                          break;
  68   4                          
  69   4                      case GET_SETTINGS:
  70   4                          send_settings();
  71   4                          break;
  72   4                          
  73   4                      case CHANGE_SETTING:
  74   4                          send_reply(SUCCESS);
  75   4                          if (apply_settings() == SUCCESS){
  76   5                              send_reply(SUCCESS);
  77   5                          }
  78   4                          else{
  79   5                              send_reply(FAIL);
  80   5                          }                  
  81   4                          break;
  82   4                          
  83   4                      case UPDATE_RTC:
  84   4                          send_reply(SUCCESS);
  85   4                          if (update_RTC() == SUCCESS){
  86   5                              send_reply(SUCCESS);
  87   5                          }
  88   4                          else{
  89   5                              send_reply(FAIL);
  90   5                          }
  91   4                          break;
  92   4                       
  93   4                      case RESET_PTRS:
  94   4                          reset_pointers();
  95   4                          send_reply(SUCCESS);
  96   4                          break;
  97   4                          
  98   4                      default:
  99   4                          send_reply(FAIL);
 100   4                          break;
 101   4      
 102   4                  } /* switch (command) */
 103   3      
 104   3              } /* if (result == SUCCESS) */
 105   2      
 106   2              else{
 107   3                  send_reply(FAIL);
 108   3              }
 109   2      
 110   2          } /* while (Vbus_Read()) */
 111   1          
 112   1          USB_Close();
 113   1          
 114   1          return;
 115   1      }
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 3   

 116          
 117          uint8 retrieve_from_buffer(uint8* buffer, uint8 num_bytes){
 118   1      /* 
 119   1       * Retrieves the specified number of bytes from the USBUART buffer, if possible - if a
 120   1       * different number of bytes is pulled from the buffer, a failure is reported to the
 121   1       * calling routine.
 122   1      */
 123   1      
 124   1          uint16 count = 0;
 125   1          uint8 attempts = 0;
 126   1          uint8 result = FAIL;
 127   1          
 128   1          count = USBUART_GetCount(); 
 129   1          
 130   1          /* If data in buffer is the right amount retrieve_from_buffer it */
 131   1          if (count == num_bytes){
 132   2              USBUART_GetData(buffer, num_bytes);
 133   2              result = SUCCESS;
 134   2          }
 135   1          /* Otherwise, flush the USB buffer and report fail */
 136   1          else if (count > 0){
 137   2              USBUART_GetChar();
 138   2          }
 139   1          
 140   1          return result;
 141   1      }
 142          
 143          void send_reply(uint8 message){
 144   1      /* 
 145   1       * Once the host is ready, sends the reply specified by message.
 146   1      */
 147   1         
 148   1          while(!USBUART_CDCIsReady() && Vbus_Read());
 149   1          
 150   1          if (Vbus_Read()){
 151   2              USBUART_PutData(&message, REPLY_LEN);
 152   2          }
 153   1          
 154   1          return;
 155   1      }
 156          
 157          void send_settings(){
 158   1      /*
 159   1       * Retrieves current sample settings stored in EEPROM and sends them to the host.
 160   1      */
 161   1          
 162   1          uint8 settings[NUM_SETTINGS];
 163   1          
 164   1          settings[0] = get_EEPROM_variable(EE_SENSOR);
 165   1          settings[1] = get_EEPROM_variable(EE_SAMPLE_UNIT);
 166   1          settings[2] = get_EEPROM_variable(EE_SAMPLE_INTERVAL);
 167   1          
 168   1          while(!USBUART_CDCIsReady() && Vbus_Read());
 169   1          
 170   1          if (Vbus_Read()){
 171   2              USBUART_PutData((uint8*) &settings, sizeof(settings));
 172   2          }
 173   1          
 174   1          return;   
 175   1      }
 176          
 177          uint8 apply_settings(){
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 4   

 178   1      /* 
 179   1       * Retrieves new settings from the USBUART buffer that were sent by the host and stores
 180   1       * them in EEPROM.
 181   1      */
 182   1          uint8 result = FAIL;
 183   1          uint8 settings_buffer[NUM_SETTINGS] = {0};
 184   1          struct sampling_settings new_settings;
 185   1          
 186   1          while (!USBUART_DataIsReady() && Vbus_Read());
 187   1          
 188   1          if (Vbus_Read()){
 189   2              if (retrieve_from_buffer(settings_buffer, NUM_SETTINGS) == SUCCESS){
 190   3      
 191   3                  new_settings.sensor = settings_buffer[0];
 192   3                  new_settings.sample_unit = settings_buffer[1];
 193   3                  new_settings.sample_interval = settings_buffer[2];
 194   3                  
 195   3                  result = update_settings(new_settings);   
 196   3              }
 197   2          } 
 198   1          
 199   1          return result;
 200   1      }
 201          
 202          uint8 update_settings(struct sampling_settings new_settings){
 203   1      /*
 204   1       * Handles updating EEPROM with new settings. Updating the settings in EEPROM requires
 205   1       * a Read-Modify-Write cycle of the whole EEPROM sector.
 206   1      */
 207   1          
 208   1          uint8* buffer;
 209   1          float rows_used = 0;
 210   1          uint16 remainder = 0;
 211   1          uint8* src_ptr;
 212   1          uint8* dst_ptr;
 213   1          uint8 i = 0; 
 214   1          float bytes_used = EEPROM_BYTES_USED;
 215   1          uint8 result = SUCCESS;
 216   1          cystatus status;
 217   1          
 218   1          /* Allocate array to hold EEPROM variables */
 219   1          
 220   1          rows_used = ceil(bytes_used/CYDEV_EEPROM_ROW_SIZE);
 221   1          buffer = malloc(((uint16) rows_used) * CYDEV_EEPROM_ROW_SIZE);
 222   1          
 223   1          dst_ptr = buffer;
 224   1          remainder = (rows_used * 16) - EEPROM_BYTES_USED;
 225   1          
 226   1          /* Copy all variables into SRAM */
 227   1          for (i=0; i<EEPROM_BYTES_USED; ++i){
 228   2              *dst_ptr = CY_GET_REG8(CYDEV_EE_BASE + i);
 229   2              ++dst_ptr;      
 230   2          }
 231   1          
 232   1          /* Fill remainder of buffer with zeros */
 233   1          while (i < remainder){
 234   2              *dst_ptr = 0;
 235   2              ++i;
 236   2          }
 237   1          
 238   1          /* Modify variables in SRAM */
 239   1          buffer[0] = new_settings.sensor;
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 5   

 240   1          buffer[1] = new_settings.sample_unit;
 241   1          buffer[2] = new_settings.sample_interval;
 242   1          
 243   1          /* Disable interrupts and erase EEPROM */
 244   1          CyGlobalIntDisable;
 245   1          status = Re_EEPROM_EraseSector(SECTOR_NUMBER);
 246   1          CyGlobalIntEnable;
 247   1          
 248   1          if (status != CYRET_SUCCESS){
 249   2              result = FAIL;
 250   2              goto exit;
 251   2          }
 252   1          
 253   1          /* Write back modified EEPROM Variables */
 254   1          i = 0;
 255   1          src_ptr = buffer;
 256   1          while ((i < rows_used) && (i < EEPROM_ROWS)){
 257   2              /* Disable interrupts during EEPROM write operation */
 258   2              CyGlobalIntDisable;
 259   2              status = Re_EEPROM_Write(src_ptr, i);
 260   2              CyGlobalIntEnable;
 261   2              
 262   2              if (status != CYRET_SUCCESS){
 263   3                 result = FAIL;
 264   3              goto exit;
 265   3          }
 266   2              src_ptr = src_ptr + CYDEV_EEPROM_ROW_SIZE;
 267   2              ++i;
 268   2          }
 269   1           
 270   1          free(buffer);
 271   1          
 272   1      exit:   
 273   1          return result;   
 274   1      }
 275          
 276          uint8 export_samples(){
 277   1      /*
 278   1       * Dumps the contents of the Flash sample block to the host. This routine makes no
 279   1       * distinction between different types of data stored in Flash. It iterates through
 280   1       * the sample block array copying one byte at a time into the export buffer and does
 281   1       * no analysis of the bytes it is sending.
 282   1       *
 283   1       * Optimization suggestion: The export buffer could be eliminated in favor of passing
 284   1       * flash pointers to the load_buffer function and incrementing the pointers
 285   1       * 64-bytes at a time.
 286   1      */
 287   1          
 288   1          uint8 result = SUCCESS;
 289   1          uint8 export_buffer[BUFFER_LEN];
 290   1          uint16 export_index = sample_head_index; 
 291   1          uint16 byte_count = 0;
 292   1          uint8 i = 0;
 293   1          
 294   1          /* Before doing a bunch of work, make sure we have samples to send */
 295   1          if ((export_index == sample_tail_index) && !mem_full_flag){
 296   2              export_buffer[0] = NO_DATA;
 297   2              
 298   2              for (i=1; i< BUFFER_LEN; ++i){
 299   3                  export_buffer[i] = PADBYTE;
 300   3              }
 301   2              load_buffer(export_buffer);
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 6   

 302   2                      
 303   2              goto exit;
 304   2          }
 305   1                  
 306   1          /* Loop 1: Iterate over data samples until export pointer meets the tail */
 307   1          do
 308   1          {   
 309   2              /* Loop 2: Iterate over the 64-byte USB buffer, copying bytes into it */
 310   2              while (i < BUFFER_LEN)
 311   2              {
 312   3                  export_buffer[i] = sample_block[export_index];
 313   3                  ++i;
 314   3                  ++export_index;
 315   3                  ++byte_count;
 316   3      
 317   3                  /* Check to make sure we're not incrementing export_ptr past
 318   3                   * the bounds of our sample array - wrap around to first element if true */
 319   3                  if (export_index >= SAMPLE_BLOCK_SIZE){
 320   4                          export_index = 0;
 321   4                  }
 322   3      
 323   3                  /* Once the last sample byte has been put in the buffer,
 324   3                   * add a pad byte to mark the end of this packet */
 325   3                  if (export_index == sample_tail_index){
 326   4                      export_buffer[i] = PADBYTE;
 327   4                      break;
 328   4                  }           
 329   3              }
 330   2              
 331   2              /* Send 64-byte packet to host */
 332   2              load_buffer(export_buffer);
 333   2              i = 0;
 334   2              
 335   2              /* Wait for permission from host to send next packet */
 336   2              if (wait_for_continue() == FAIL){
 337   3                  result = FAIL;
 338   3                  goto exit;
 339   3              }
 340   2          } while (export_index != sample_tail_index);
 341   1          
 342   1          /* Add the size trailer packet to get total transmission size,
 343   1           * excluding pad bytes */
 344   1          byte_count = byte_count + 4;
 345   1          
 346   1          /* Trailer Packet to Identify End of Sampled Data in Memory */ 
 347   1          export_buffer[0] = 0x80; /* End of Data Identifier */
 348   1          export_buffer[1] = 0x00;
 349   1          
 350   1          /* Byte count may be up to 16-bits long - split into two bytes
 351   1           * and copy to buffer */
 352   1          export_buffer[2] = (uint8)(byte_count >> 8);
 353   1          export_buffer[3] = (uint8)0x00FF & byte_count;
 354   1          
 355   1          load_buffer(export_buffer);
 356   1      
 357   1      exit:
 358   1          
 359   1          return result;
 360   1      }
 361          
 362          void load_buffer(uint8* export_buffer){
 363   1      /*
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 7   

 364   1       * Loads a 64-byte export buffer into the USBUART buffer to be sent to the host.
 365   1       * USB Specification says that when a maximum payload size packet (64-bytes) is sent
 366   1       * to the host, the host does not consider the transaction complete unless it is
 367   1       * followed by a zero-length packet, so we send one after loading the export_buffer.
 368   1      */
 369   1          
 370   1          while(!USBUART_CDCIsReady() && Vbus_Read());
 371   1          USBUART_PutData(export_buffer, BUFFER_LEN);
 372   1         
 373   1          /* Add zero-length packet so host completes transaction */
 374   1          while(!USBUART_CDCIsReady() && Vbus_Read());
 375   1          USBUART_PutData(export_buffer, 0);
 376   1      
 377   1          return;
 378   1      }
 379              
 380          uint8 wait_for_continue(){
 381   1      /* 
 382   1       * Stalls until a reply is received from the host. The result of that reply is returned.
 383   1       * Data dumping with the Python GUI is very heavily interlocked, with replies from the
 384   1       * host expected between every 64-byte packet.
 385   1      */
 386   1          uint8 reply = 0;
 387   1          uint8 retrieve_from_buffer_status = 0;
 388   1          uint8 continue_status = FAIL;
 389   1      
 390   1          while(!reply && Vbus_Read()){
 391   2                  
 392   2              while(!USBUART_GetCount() && Vbus_Read()); 
 393   2              retrieve_from_buffer_status = retrieve_from_buffer(&reply, COMMAND_LENGTH);
 394   2              
 395   2              if (retrieve_from_buffer_status == SUCCESS && reply == NEXT){
 396   3      
 397   3                  continue_status = SUCCESS;
 398   3                  break;
 399   3              }
 400   2              
 401   2              else if (retrieve_from_buffer_status == SUCCESS){
 402   3                  continue_status = FAIL;            
 403   3              }
 404   2          }    
 405   1          
 406   1          return continue_status;
 407   1      }
 408          
 409          void confirm_export(){
 410   1      /*
 411   1       * Awaits a SUCCESS or FAIL reply from the host when dumping samples is complete. If
 412   1       * the host replies with SUCCESS (indicating that they received the expected number of
 413   1       * bytes) then we clear the sample array. If not, simply return and wait for the host
 414   1       * to send the dump data command again.
 415   1      */
 416   1      
 417   1          uint8 command = 0;
 418   1          
 419   1          while(Vbus_Read()){
 420   2              while(!USBUART_DataIsReady() && Vbus_Read());
 421   2                      
 422   2              if (retrieve_from_buffer(&command, COMMAND_LENGTH) == SUCCESS){
 423   3                  
 424   3                  if (command == SUCCESS){
 425   4                      clear_samples();           
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 8   

 426   4                      break;
 427   4                  }
 428   3                  
 429   3                  else if (command == NEXT){
 430   4                      send_reply(FAIL);
 431   4                      break;   
 432   4                  }
 433   3                  
 434   3                  else if (command == FAIL){
 435   4                      break;
 436   4                  }            
 437   3              }
 438   2          }
 439   1          
 440   1          return;
 441   1      }
 442          
 443          uint8 update_RTC(){
 444   1      /*
 445   1       * Invoked by the host every time a connection with the host application is made. Updates
 446   1       * the current time in the RTC with the time sent by the host.
 447   1      */
 448   1      
 449   1          uint8 result = FAIL;
 450   1          uint8 time_buffer[TIME_LENGTH] = {0};
 451   1          RTC_TIME_DATE new_time;
 452   1          
 453   1          while (!USBUART_DataIsReady() && Vbus_Read());
 454   1          
 455   1          if (Vbus_Read()){
 456   2              if (retrieve_from_buffer(time_buffer, TIME_LENGTH) == SUCCESS){
 457   3                  new_time.Year = ((uint16) time_buffer[0]) << 0x8;
 458   3                  new_time.Year = new_time.Year | ((uint16) time_buffer[1]);
 459   3                  new_time.Sec = time_buffer[2];
 460   3                  new_time.Min = time_buffer[3];
 461   3                  new_time.Hour = time_buffer[4];
 462   3                  new_time.DayOfMonth = time_buffer[5];
 463   3                  new_time.Month = time_buffer[6];
 464   3                  
 465   3                  RTC_WriteTime(&new_time);
 466   3                  
 467   3                  result = SUCCESS;
 468   3      
 469   3              }
 470   2          }
 471   1          
 472   1          return result;
 473   1      }
 474          
 475          void USB_Close(){
 476   1      /*
 477   1       * Cleans up when the USB cable is disconnected.
 478   1      */
 479   1          
 480   1          /* Clear pending interrupts that occurred while plugged into host */
 481   1          USBUART_Stop();
 482   1          Vbus_ClearInterrupt();
 483   1          Vbus_IRQ_ClearPending();
 484   1          clear_button_interrupts();
 485   1          USB_waiting = 0;
 486   1          
 487   1          /* Reapply EEPROM variables to sample parameters in case they were changed */
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 9   

 488   1          sampling_setup(); 
 489   1          
 490   1          /* Re-enter normal operating mode */
 491   1          ModifyCollection_IRQ_Start();
 492   1          Vbus_IRQ_Start();   
 493   1      
 494   1          return;
 495   1      }
 496          
 497          /* [] END OF FILE */
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 10  

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION Run_USB (BEGIN)
                                           ; SOURCE LINE # 15
                                           ; SOURCE LINE # 23
0000 900000      R     MOV     DPTR,#result
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 24
0005 900000      R     MOV     DPTR,#command
0008 E4                CLR     A
0009 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 26
000A 7F00              MOV     R7,#00H
000C 120000      E     LCALL   _RTC_WriteIntervalMask
                                           ; SOURCE LINE # 27
000F 120000      E     LCALL   ModifyCollection_IRQ_Stop
                                           ; SOURCE LINE # 28
0012 120000      E     LCALL   Vbus_IRQ_Stop
                                           ; SOURCE LINE # 30
0015 7D01              MOV     R5,#01H
0017 7F00              MOV     R7,#00H
0019 120000      E     LCALL   _USBUART_Start
001C         ?C0001:
                                           ; SOURCE LINE # 33
001C 120000      E     LCALL   USBUART_GetConfiguration
001F EF                MOV     A,R7
0020 7006              JNZ     ?C0002
0022 120000      E     LCALL   Vbus_Read
0025 EF                MOV     A,R7
0026 70F4              JNZ     ?C0001
0028         ?C0002:
                                           ; SOURCE LINE # 36
0028 120000      E     LCALL   USBUART_CDC_Init
002B         ?C0003:
                                           ; SOURCE LINE # 38
002B 120000      E     LCALL   Vbus_Read
002E EF                MOV     A,R7
002F 7003              JNZ     $ + 5H
0031 020000      R     LJMP    ?C0004
                                           ; SOURCE LINE # 39
                                           ; SOURCE LINE # 40
0034 120000      E     LCALL   USBUART_DataIsReady
0037 EF                MOV     A,R7
0038 60F1              JZ      ?C0003
                                           ; SOURCE LINE # 41
                                           ; SOURCE LINE # 42
003A         ?C0005:
                                           ; SOURCE LINE # 44
003A 7B01              MOV     R3,#01H
003C 7A00        R     MOV     R2,#HIGH command
003E 7900        R     MOV     R1,#LOW command
0040 7D01              MOV     R5,#01H
0042 120000      R     LCALL   _retrieve_from_buffer
0045 900000      R     MOV     DPTR,#result
0048 EF                MOV     A,R7
0049 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 47
004A 900000      R     MOV     DPTR,#command
004D E0                MOVX    A,@DPTR
004E FF                MOV     R7,A
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 11  

004F EF                MOV     A,R7
0050 60D9              JZ      ?C0003
                                           ; SOURCE LINE # 48
                                           ; SOURCE LINE # 49
0052         ?C0006:
                                           ; SOURCE LINE # 52
0052 900000      R     MOV     DPTR,#result
0055 E0                MOVX    A,@DPTR
0056 FF                MOV     R7,A
0057 EF                MOV     A,R7
0058 6420              XRL     A,#020H
005A 6003              JZ      $ + 5H
005C 020000      R     LJMP    ?C0007
                                           ; SOURCE LINE # 54
005F 900000      R     MOV     DPTR,#command
0062 E0                MOVX    A,@DPTR
0063 FF                MOV     R7,A
0064 EF                MOV     A,R7
0065 120000      E     LCALL   ?C?CCASE
0068 0000        R     DW      ?C0009
006A 01                DB      01H
006B 0000        R     DW      ?C0010
006D 02                DB      02H
006E 0000        R     DW      ?C0013
0070 03                DB      03H
0071 0000        R     DW      ?C0014
0073 04                DB      04H
0074 0000        R     DW      ?C0020
0076 05                DB      05H
0077 0000        R     DW      ?C0017
0079 06                DB      06H
007A 0000              DW      00H
007C 0000        R     DW      ?C0021
                                           ; SOURCE LINE # 56
007E         ?C0009:
                                           ; SOURCE LINE # 57
007E 7F10              MOV     R7,#010H
0080 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 58
0083 80A6              SJMP    ?C0003
                                           ; SOURCE LINE # 60
0085         ?C0010:
                                           ; SOURCE LINE # 61
0085 120000      R     LCALL   export_samples
0088 EF                MOV     A,R7
0089 6005              JZ      ?C0011
                                           ; SOURCE LINE # 62
008B 120000      R     LCALL   confirm_export
                                           ; SOURCE LINE # 63
008E 809B              SJMP    ?C0003
0090         ?C0011:
                                           ; SOURCE LINE # 64
                                           ; SOURCE LINE # 65
0090 7F30              MOV     R7,#030H
0092 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 66
0095         ?C0012:
                                           ; SOURCE LINE # 67
0095 8094              SJMP    ?C0003
                                           ; SOURCE LINE # 69
0097         ?C0013:
                                           ; SOURCE LINE # 70
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 12  

0097 120000      R     LCALL   send_settings
                                           ; SOURCE LINE # 71
009A 808F              SJMP    ?C0003
                                           ; SOURCE LINE # 73
009C         ?C0014:
                                           ; SOURCE LINE # 74
009C 7F20              MOV     R7,#020H
009E 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 75
00A1 120000      R     LCALL   apply_settings
00A4 EF                MOV     A,R7
00A5 B42008            CJNE    A,#020H,?C0015
                                           ; SOURCE LINE # 76
00A8 7F20              MOV     R7,#020H
00AA 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 77
00AD 020000      R     LJMP    ?C0003
00B0         ?C0015:
                                           ; SOURCE LINE # 78
                                           ; SOURCE LINE # 79
00B0 7F30              MOV     R7,#030H
00B2 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 80
00B5         ?C0016:
                                           ; SOURCE LINE # 81
00B5 020000      R     LJMP    ?C0003
                                           ; SOURCE LINE # 83
00B8         ?C0017:
                                           ; SOURCE LINE # 84
00B8 7F20              MOV     R7,#020H
00BA 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 85
00BD 120000      R     LCALL   update_RTC
00C0 EF                MOV     A,R7
00C1 B42008            CJNE    A,#020H,?C0018
                                           ; SOURCE LINE # 86
00C4 7F20              MOV     R7,#020H
00C6 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 87
00C9 020000      R     LJMP    ?C0003
00CC         ?C0018:
                                           ; SOURCE LINE # 88
                                           ; SOURCE LINE # 89
00CC 7F30              MOV     R7,#030H
00CE 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 90
00D1         ?C0019:
                                           ; SOURCE LINE # 91
00D1 020000      R     LJMP    ?C0003
                                           ; SOURCE LINE # 93
00D4         ?C0020:
                                           ; SOURCE LINE # 94
00D4 120000      E     LCALL   reset_pointers
                                           ; SOURCE LINE # 95
00D7 7F20              MOV     R7,#020H
00D9 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 96
00DC 020000      R     LJMP    ?C0003
                                           ; SOURCE LINE # 98
00DF         ?C0021:
                                           ; SOURCE LINE # 99
00DF 7F30              MOV     R7,#030H
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 13  

00E1 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 100
00E4 020000      R     LJMP    ?C0003
                                           ; SOURCE LINE # 102
00E7         ?C0008:
                                           ; SOURCE LINE # 104
00E7 020000      R     LJMP    ?C0003
00EA         ?C0007:
                                           ; SOURCE LINE # 106
                                           ; SOURCE LINE # 107
00EA 7F30              MOV     R7,#030H
00EC 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 108
00EF         ?C0022:
                                           ; SOURCE LINE # 110
00EF 020000      R     LJMP    ?C0003
00F2         ?C0004:
                                           ; SOURCE LINE # 112
00F2 120000      R     LCALL   USB_Close
                                           ; SOURCE LINE # 115
00F5         ?C0023:
00F5 22                RET     
             ; FUNCTION Run_USB (END)

             ; FUNCTION _retrieve_from_buffer (BEGIN)
                                           ; SOURCE LINE # 117
0000 900000      R     MOV     DPTR,#buffer
0003 120000      E     LCALL   ?C?PSTXDATA
0006 900000      R     MOV     DPTR,#num_bytes
0009 ED                MOV     A,R5
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 124
000B 900000      R     MOV     DPTR,#count
000E E4                CLR     A
000F F0                MOVX    @DPTR,A
0010 A3                INC     DPTR
0011 E4                CLR     A
0012 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 125
0013 900000      R     MOV     DPTR,#attempts
0016 E4                CLR     A
0017 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 126
0018 900000      R     MOV     DPTR,#result
001B 7430              MOV     A,#030H
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 128
001E 120000      E     LCALL   USBUART_GetCount
0021 900000      R     MOV     DPTR,#count
0024 EE                MOV     A,R6
0025 F0                MOVX    @DPTR,A
0026 A3                INC     DPTR
0027 EF                MOV     A,R7
0028 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 131
0029 900000      R     MOV     DPTR,#num_bytes
002C E0                MOVX    A,@DPTR
002D FF                MOV     R7,A
002E 7E00              MOV     R6,#00H
0030 900000      R     MOV     DPTR,#count
0033 E0                MOVX    A,@DPTR
0034 FC                MOV     R4,A
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 14  

0035 A3                INC     DPTR
0036 E0                MOVX    A,@DPTR
0037 FD                MOV     R5,A
0038 EF                MOV     A,R7
0039 B5051E            CJNE    A,AR5,?C0024
003C EE                MOV     A,R6
003D B5041A            CJNE    A,AR4,?C0024
                                           ; SOURCE LINE # 132
0040 900000      R     MOV     DPTR,#buffer
0043 120000      E     LCALL   ?C?PLDXDATA
0046 900000      R     MOV     DPTR,#num_bytes
0049 E0                MOVX    A,@DPTR
004A FF                MOV     R7,A
004B EF                MOV     A,R7
004C FD                MOV     R5,A
004D 7C00              MOV     R4,#00H
004F 120000      E     LCALL   _USBUART_GetData
                                           ; SOURCE LINE # 133
0052 900000      R     MOV     DPTR,#result
0055 7420              MOV     A,#020H
0057 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 134
0058 8014              SJMP    ?C0025
005A         ?C0024:
                                           ; SOURCE LINE # 136
005A 900000      R     MOV     DPTR,#count
005D E0                MOVX    A,@DPTR
005E FE                MOV     R6,A
005F A3                INC     DPTR
0060 E0                MOVX    A,@DPTR
0061 FF                MOV     R7,A
0062 D3                SETB    C
0063 EF                MOV     A,R7
0064 9400              SUBB    A,#00H
0066 EE                MOV     A,R6
0067 9400              SUBB    A,#00H
0069 4003              JC      ?C0025
                                           ; SOURCE LINE # 137
006B 120000      E     LCALL   USBUART_GetChar
                                           ; SOURCE LINE # 138
006E         ?C0026:
006E         ?C0025:
                                           ; SOURCE LINE # 140
006E 900000      R     MOV     DPTR,#result
0071 E0                MOVX    A,@DPTR
0072 FF                MOV     R7,A
                                           ; SOURCE LINE # 141
0073         ?C0027:
0073 22                RET     
             ; FUNCTION _retrieve_from_buffer (END)

             ; FUNCTION _send_reply (BEGIN)
                                           ; SOURCE LINE # 143
0000 900000      R     MOV     DPTR,#message
0003 EF                MOV     A,R7
0004 F0                MOVX    @DPTR,A
0005         ?C0028:
                                           ; SOURCE LINE # 148
0005 120000      E     LCALL   USBUART_CDCIsReady
0008 EF                MOV     A,R7
0009 7006              JNZ     ?C0029
000B 120000      E     LCALL   Vbus_Read
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 15  

000E EF                MOV     A,R7
000F 70F4              JNZ     ?C0028
0011         ?C0029:
                                           ; SOURCE LINE # 150
0011 120000      E     LCALL   Vbus_Read
0014 EF                MOV     A,R7
0015 600D              JZ      ?C0031
                                           ; SOURCE LINE # 151
0017 7B01              MOV     R3,#01H
0019 7A00        R     MOV     R2,#HIGH message
001B 7900        R     MOV     R1,#LOW message
001D 7D01              MOV     R5,#01H
001F 7C00              MOV     R4,#00H
0021 120000      E     LCALL   _USBUART_PutData
                                           ; SOURCE LINE # 152
0024         ?C0030:
                                           ; SOURCE LINE # 155
0024         ?C0031:
0024 22                RET     
             ; FUNCTION _send_reply (END)

             ; FUNCTION send_settings (BEGIN)
                                           ; SOURCE LINE # 157
                                           ; SOURCE LINE # 164
0000 7F00              MOV     R7,#00H
0002 7E00              MOV     R6,#00H
0004 120000      E     LCALL   _get_EEPROM_variable
0007 900000      R     MOV     DPTR,#settings
000A EF                MOV     A,R7
000B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 165
000C 7F01              MOV     R7,#01H
000E 7E00              MOV     R6,#00H
0010 120000      E     LCALL   _get_EEPROM_variable
0013 900000      R     MOV     DPTR,#settings+01H
0016 EF                MOV     A,R7
0017 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 166
0018 7F02              MOV     R7,#02H
001A 7E00              MOV     R6,#00H
001C 120000      E     LCALL   _get_EEPROM_variable
001F 900000      R     MOV     DPTR,#settings+02H
0022 EF                MOV     A,R7
0023 F0                MOVX    @DPTR,A
0024         ?C0032:
                                           ; SOURCE LINE # 168
0024 120000      E     LCALL   USBUART_CDCIsReady
0027 EF                MOV     A,R7
0028 7006              JNZ     ?C0033
002A 120000      E     LCALL   Vbus_Read
002D EF                MOV     A,R7
002E 70F4              JNZ     ?C0032
0030         ?C0033:
                                           ; SOURCE LINE # 170
0030 120000      E     LCALL   Vbus_Read
0033 EF                MOV     A,R7
0034 600D              JZ      ?C0035
                                           ; SOURCE LINE # 171
0036 7B01              MOV     R3,#01H
0038 7A00        R     MOV     R2,#HIGH settings
003A 7900        R     MOV     R1,#LOW settings
003C 7D03              MOV     R5,#03H
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 16  

003E 7C00              MOV     R4,#00H
0040 120000      E     LCALL   _USBUART_PutData
                                           ; SOURCE LINE # 172
0043         ?C0034:
                                           ; SOURCE LINE # 175
0043         ?C0035:
0043 22                RET     
             ; FUNCTION send_settings (END)

             ; FUNCTION apply_settings (BEGIN)
                                           ; SOURCE LINE # 177
                                           ; SOURCE LINE # 182
0000 900000      R     MOV     DPTR,#result
0003 7430              MOV     A,#030H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 183
0006 7BFF              MOV     R3,#0FFH
0008 7A00        R     MOV     R2,#HIGH _?ix1000
000A 7900        R     MOV     R1,#LOW _?ix1000
000C C003              PUSH    AR3
000E C002              PUSH    AR2
0010 C001              PUSH    AR1
0012 7B01              MOV     R3,#01H
0014 7A00        R     MOV     R2,#HIGH settings_buffer
0016 7900        R     MOV     R1,#LOW settings_buffer
0018 A801              MOV     R0,AR1
001A AC02              MOV     R4,AR2
001C AD03              MOV     R5,AR3
001E D001              POP     AR1
0020 D002              POP     AR2
0022 D003              POP     AR3
0024 7E00              MOV     R6,#00H
0026 7F03              MOV     R7,#03H
0028 120000      E     LCALL   ?C?COPYAMD
002B         ?C0036:
                                           ; SOURCE LINE # 186
002B 120000      E     LCALL   USBUART_DataIsReady
002E EF                MOV     A,R7
002F 7006              JNZ     ?C0037
0031 120000      E     LCALL   Vbus_Read
0034 EF                MOV     A,R7
0035 70F4              JNZ     ?C0036
0037         ?C0037:
                                           ; SOURCE LINE # 188
0037 120000      E     LCALL   Vbus_Read
003A EF                MOV     A,R7
003B 605B              JZ      ?C0038
                                           ; SOURCE LINE # 189
003D 7B01              MOV     R3,#01H
003F 7A00        R     MOV     R2,#HIGH settings_buffer
0041 7900        R     MOV     R1,#LOW settings_buffer
0043 7D03              MOV     R5,#03H
0045 120000      R     LCALL   _retrieve_from_buffer
0048 EF                MOV     A,R7
0049 6420              XRL     A,#020H
004B 704B              JNZ     ?C0038
                                           ; SOURCE LINE # 191
004D 900000      R     MOV     DPTR,#settings_buffer
0050 E0                MOVX    A,@DPTR
0051 FF                MOV     R7,A
0052 900000      R     MOV     DPTR,#new_settings
0055 EF                MOV     A,R7
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 17  

0056 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 192
0057 900000      R     MOV     DPTR,#settings_buffer+01H
005A E0                MOVX    A,@DPTR
005B FF                MOV     R7,A
005C 900000      R     MOV     DPTR,#new_settings+01H
005F EF                MOV     A,R7
0060 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 193
0061 900000      R     MOV     DPTR,#settings_buffer+02H
0064 E0                MOVX    A,@DPTR
0065 FF                MOV     R7,A
0066 900000      R     MOV     DPTR,#new_settings+02H
0069 EF                MOV     A,R7
006A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 195
006B 7B01              MOV     R3,#01H
006D 7A00        R     MOV     R2,#HIGH new_settings
006F 7900        R     MOV     R1,#LOW new_settings
0071 C003              PUSH    AR3
0073 C002              PUSH    AR2
0075 C001              PUSH    AR1
0077 7B01              MOV     R3,#01H
0079 7A00        R     MOV     R2,#HIGH ?update_settings?BYTE
007B 7900        R     MOV     R1,#LOW ?update_settings?BYTE
007D A801              MOV     R0,AR1
007F AC02              MOV     R4,AR2
0081 AD03              MOV     R5,AR3
0083 D001              POP     AR1
0085 D002              POP     AR2
0087 D003              POP     AR3
0089 7E00              MOV     R6,#00H
008B 7F03              MOV     R7,#03H
008D 120000      E     LCALL   ?C?COPYAMD
0090 120000      R     LCALL   update_settings
0093 900000      R     MOV     DPTR,#result
0096 EF                MOV     A,R7
0097 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 196
0098         ?C0039:
                                           ; SOURCE LINE # 197
0098         ?C0038:
                                           ; SOURCE LINE # 199
0098 900000      R     MOV     DPTR,#result
009B E0                MOVX    A,@DPTR
009C FF                MOV     R7,A
                                           ; SOURCE LINE # 200
009D         ?C0040:
009D 22                RET     
             ; FUNCTION apply_settings (END)

             ; FUNCTION update_settings (BEGIN)
                                           ; SOURCE LINE # 202
                                           ; SOURCE LINE # 209
0000 7F00              MOV     R7,#00H
0002 7E00              MOV     R6,#00H
0004 7D00              MOV     R5,#00H
0006 7C00              MOV     R4,#00H
0008 900000      R     MOV     DPTR,#rows_used
000B 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 210
000E 900000      R     MOV     DPTR,#remainder
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 18  

0011 E4                CLR     A
0012 F0                MOVX    @DPTR,A
0013 A3                INC     DPTR
0014 E4                CLR     A
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 213
0016 900000      R     MOV     DPTR,#i
0019 E4                CLR     A
001A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 214
001B 7F00              MOV     R7,#00H
001D 7E00              MOV     R6,#00H
001F 7D40              MOV     R5,#040H
0021 7C40              MOV     R4,#040H
0023 900000      R     MOV     DPTR,#bytes_used
0026 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 215
0029 900000      R     MOV     DPTR,#result
002C 7420              MOV     A,#020H
002E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 220
002F 7B00              MOV     R3,#00H
0031 7A00              MOV     R2,#00H
0033 7980              MOV     R1,#080H
0035 7841              MOV     R0,#041H
0037 900000      R     MOV     DPTR,#bytes_used
003A 120000      E     LCALL   ?C?LLDXDATA
003D 120000      E     LCALL   ?C?FPDIV
0040 120000      E     LCALL   _ceil
0043 900000      R     MOV     DPTR,#rows_used
0046 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 221
0049 900000      R     MOV     DPTR,#rows_used
004C 120000      E     LCALL   ?C?LLDXDATA
004F 120000      E     LCALL   ?C?CASTF
0052 EF                MOV     A,R7
0053 C4                SWAP    A
0054 F8                MOV     R0,A
0055 540F              ANL     A,#0FH
0057 C8                XCH     A,R0
0058 68                XRL     A,R0
0059 FF                MOV     R7,A
005A EE                MOV     A,R6
005B C4                SWAP    A
005C 54F0              ANL     A,#0F0H
005E 48                ORL     A,R0
005F FE                MOV     R6,A
0060 120000      E     LCALL   _malloc
0063 AA06              MOV     R2,AR6
0065 A907              MOV     R1,AR7
0067 7B01              MOV     R3,#01H
0069 900000      R     MOV     DPTR,#buffer
006C 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 223
006F 900000      R     MOV     DPTR,#buffer
0072 120000      E     LCALL   ?C?PLDXDATA
0075 900000      R     MOV     DPTR,#dst_ptr
0078 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 224
007B 7F00              MOV     R7,#00H
007D 7E00              MOV     R6,#00H
007F 7D80              MOV     R5,#080H
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 19  

0081 7C41              MOV     R4,#041H
0083 900000      R     MOV     DPTR,#rows_used
0086 120000      E     LCALL   ?C?LLDXDATA0
0089 120000      E     LCALL   ?C?FPMUL
008C 7B00              MOV     R3,#00H
008E 7A00              MOV     R2,#00H
0090 7940              MOV     R1,#040H
0092 78C0              MOV     R0,#0C0H
0094 120000      E     LCALL   ?C?FPADD
0097 120000      E     LCALL   ?C?CASTF
009A 900000      R     MOV     DPTR,#remainder
009D EE                MOV     A,R6
009E F0                MOVX    @DPTR,A
009F A3                INC     DPTR
00A0 EF                MOV     A,R7
00A1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 227
00A2 900000      R     MOV     DPTR,#i
00A5 E4                CLR     A
00A6 F0                MOVX    @DPTR,A
00A7         ?C0041:
00A7 900000      R     MOV     DPTR,#i
00AA E0                MOVX    A,@DPTR
00AB FF                MOV     R7,A
00AC EF                MOV     A,R7
00AD C3                CLR     C
00AE 9403              SUBB    A,#03H
00B0 5031              JNC     ?C0044
                                           ; SOURCE LINE # 228
00B2 900000      R     MOV     DPTR,#i
00B5 E0                MOVX    A,@DPTR
00B6 FF                MOV     R7,A
00B7 7E00              MOV     R6,#00H
00B9 EF                MOV     A,R7
00BA 2400              ADD     A,#00H
00BC FF                MOV     R7,A
00BD EE                MOV     A,R6
00BE 3480              ADDC    A,#080H
00C0 FE                MOV     R6,A
00C1 8F82              MOV     DPL,R7
00C3 8E83              MOV     DPH,R6
00C5 E0                MOVX    A,@DPTR
00C6 FF                MOV     R7,A
00C7 900000      R     MOV     DPTR,#dst_ptr
00CA 120000      E     LCALL   ?C?PLDXDATA
00CD EF                MOV     A,R7
00CE 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 229
00D1 900000      R     MOV     DPTR,#dst_ptr+01H
00D4 E4                CLR     A
00D5 75F001            MOV     B,#01H
00D8 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 230
00DB         ?C0043:
00DB 900000      R     MOV     DPTR,#i
00DE E0                MOVX    A,@DPTR
00DF 04                INC     A
00E0 F0                MOVX    @DPTR,A
00E1 80C4              SJMP    ?C0041
00E3         ?C0042:
00E3         ?C0044:
                                           ; SOURCE LINE # 233
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 20  

00E3 900000      R     MOV     DPTR,#i
00E6 E0                MOVX    A,@DPTR
00E7 FF                MOV     R7,A
00E8 7E00              MOV     R6,#00H
00EA 900000      R     MOV     DPTR,#remainder
00ED E0                MOVX    A,@DPTR
00EE FC                MOV     R4,A
00EF A3                INC     DPTR
00F0 E0                MOVX    A,@DPTR
00F1 FD                MOV     R5,A
00F2 C3                CLR     C
00F3 EF                MOV     A,R7
00F4 9D                SUBB    A,R5
00F5 EE                MOV     A,R6
00F6 9C                SUBB    A,R4
00F7 5012              JNC     ?C0045
                                           ; SOURCE LINE # 234
00F9 900000      R     MOV     DPTR,#dst_ptr
00FC 120000      E     LCALL   ?C?PLDXDATA
00FF E4                CLR     A
0100 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 235
0103 900000      R     MOV     DPTR,#i
0106 E0                MOVX    A,@DPTR
0107 04                INC     A
0108 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 236
0109 80D8              SJMP    ?C0044
010B         ?C0045:
                                           ; SOURCE LINE # 239
010B 900000      R     MOV     DPTR,#new_settings
010E E0                MOVX    A,@DPTR
010F FF                MOV     R7,A
0110 900000      R     MOV     DPTR,#buffer
0113 120000      E     LCALL   ?C?PLDXDATA
0116 EF                MOV     A,R7
0117 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 240
011A 900000      R     MOV     DPTR,#new_settings+01H
011D E0                MOVX    A,@DPTR
011E FF                MOV     R7,A
011F 900000      R     MOV     DPTR,#buffer
0122 120000      E     LCALL   ?C?PLDXDATA
0125 E9                MOV     A,R1
0126 2401              ADD     A,#01H
0128 F9                MOV     R1,A
0129 EA                MOV     A,R2
012A 3400              ADDC    A,#00H
012C FA                MOV     R2,A
012D EF                MOV     A,R7
012E 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 241
0131 900000      R     MOV     DPTR,#new_settings+02H
0134 E0                MOVX    A,@DPTR
0135 FF                MOV     R7,A
0136 900000      R     MOV     DPTR,#buffer
0139 120000      E     LCALL   ?C?PLDXDATA
013C E9                MOV     A,R1
013D 2402              ADD     A,#02H
013F F9                MOV     R1,A
0140 EA                MOV     A,R2
0141 3400              ADDC    A,#00H
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 21  

0143 FA                MOV     R2,A
0144 EF                MOV     A,R7
0145 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 244
0148 9044F4            MOV     DPTR,#044F4H
014B E0                MOVX    A,@DPTR
014C FF                MOV     R7,A
014D EF                MOV     A,R7
014E 4402              ORL     A,#02H
0150 FF                MOV     R7,A
0151 EF                MOV     A,R7
0152 F0                MOVX    @DPTR,A
0153 00                NOP     
0154 C2AF              CLR     EA
                                           ; SOURCE LINE # 245
0156 7F00              MOV     R7,#00H
0158 120000      E     LCALL   _Re_EEPROM_EraseSector
015B 900000      R     MOV     DPTR,#status
015E EF                MOV     A,R7
015F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 246
0160 D2AF              SETB    EA
0162 9044F4            MOV     DPTR,#044F4H
0165 74FD              MOV     A,#0FDH
0167 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 248
0168 900000      R     MOV     DPTR,#status
016B E0                MOVX    A,@DPTR
016C FF                MOV     R7,A
016D EF                MOV     A,R7
016E 6009              JZ      ?C0046
                                           ; SOURCE LINE # 249
0170 900000      R     MOV     DPTR,#result
0173 7430              MOV     A,#030H
0175 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 250
0176 020000      R     LJMP    exit
                                           ; SOURCE LINE # 251
0179         ?C0046:
                                           ; SOURCE LINE # 254
0179 900000      R     MOV     DPTR,#i
017C E4                CLR     A
017D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 255
017E 900000      R     MOV     DPTR,#buffer
0181 120000      E     LCALL   ?C?PLDXDATA
0184 900000      R     MOV     DPTR,#src_ptr
0187 120000      E     LCALL   ?C?PSTXDATA
018A         ?C0048:
                                           ; SOURCE LINE # 256
018A 900000      R     MOV     DPTR,#i
018D E0                MOVX    A,@DPTR
018E FC                MOV     R4,A
018F E4                CLR     A
0190 120000      E     LCALL   ?C?FCASTC
0193 900000      R     MOV     DPTR,#rows_used
0196 120000      E     LCALL   ?C?LLDXDATA0
0199 120000      E     LCALL   ?C?FPCMP3
019C 6058              JZ      ?C0049
019E 4056              JC      ?C0049
01A0 900000      R     MOV     DPTR,#i
01A3 E0                MOVX    A,@DPTR
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 22  

01A4 FF                MOV     R7,A
01A5 EF                MOV     A,R7
01A6 C3                CLR     C
01A7 9480              SUBB    A,#080H
01A9 504B              JNC     ?C0049
                                           ; SOURCE LINE # 258
01AB 9044F4            MOV     DPTR,#044F4H
01AE E0                MOVX    A,@DPTR
01AF FF                MOV     R7,A
01B0 EF                MOV     A,R7
01B1 4402              ORL     A,#02H
01B3 FF                MOV     R7,A
01B4 EF                MOV     A,R7
01B5 F0                MOVX    @DPTR,A
01B6 00                NOP     
01B7 C2AF              CLR     EA
                                           ; SOURCE LINE # 259
01B9 900000      R     MOV     DPTR,#src_ptr
01BC 120000      E     LCALL   ?C?PLDXDATA
01BF 900000      R     MOV     DPTR,#i
01C2 E0                MOVX    A,@DPTR
01C3 FD                MOV     R5,A
01C4 120000      E     LCALL   _Re_EEPROM_Write
01C7 900000      R     MOV     DPTR,#status
01CA EF                MOV     A,R7
01CB F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 260
01CC D2AF              SETB    EA
01CE 9044F4            MOV     DPTR,#044F4H
01D1 74FD              MOV     A,#0FDH
01D3 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 262
01D4 900000      R     MOV     DPTR,#status
01D7 E0                MOVX    A,@DPTR
01D8 FF                MOV     R7,A
01D9 EF                MOV     A,R7
01DA 6008              JZ      ?C0050
                                           ; SOURCE LINE # 263
01DC 900000      R     MOV     DPTR,#result
01DF 7430              MOV     A,#030H
01E1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 264
01E2 801F              SJMP    exit
                                           ; SOURCE LINE # 265
01E4         ?C0050:
                                           ; SOURCE LINE # 266
01E4 900000      R     MOV     DPTR,#src_ptr+01H
01E7 E4                CLR     A
01E8 75F010            MOV     B,#010H
01EB 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 267
01EE 900000      R     MOV     DPTR,#i
01F1 E0                MOVX    A,@DPTR
01F2 04                INC     A
01F3 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 268
01F4 8094              SJMP    ?C0048
01F6         ?C0049:
                                           ; SOURCE LINE # 270
01F6 900000      R     MOV     DPTR,#buffer
01F9 120000      E     LCALL   ?C?PLDXDATA
01FC AE02              MOV     R6,AR2
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 23  

01FE AF01              MOV     R7,AR1
0200 120000      E     LCALL   _free
                                           ; SOURCE LINE # 272
0203         exit:
                                           ; SOURCE LINE # 273
0203 900000      R     MOV     DPTR,#result
0206 E0                MOVX    A,@DPTR
0207 FF                MOV     R7,A
                                           ; SOURCE LINE # 274
0208         ?C0051:
0208 22                RET     
             ; FUNCTION update_settings (END)

             ; FUNCTION export_samples (BEGIN)
                                           ; SOURCE LINE # 276
                                           ; SOURCE LINE # 288
0000 900000      R     MOV     DPTR,#result
0003 7420              MOV     A,#020H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 290
0006 900000      E     MOV     DPTR,#sample_head_index
0009 E0                MOVX    A,@DPTR
000A FE                MOV     R6,A
000B A3                INC     DPTR
000C E0                MOVX    A,@DPTR
000D FF                MOV     R7,A
000E 900000      R     MOV     DPTR,#export_index
0011 EE                MOV     A,R6
0012 F0                MOVX    @DPTR,A
0013 A3                INC     DPTR
0014 EF                MOV     A,R7
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 291
0016 900000      R     MOV     DPTR,#byte_count
0019 E4                CLR     A
001A F0                MOVX    @DPTR,A
001B A3                INC     DPTR
001C E4                CLR     A
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 292
001E 900000      R     MOV     DPTR,#i
0021 E4                CLR     A
0022 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 295
0023 900000      E     MOV     DPTR,#sample_tail_index
0026 E0                MOVX    A,@DPTR
0027 FE                MOV     R6,A
0028 A3                INC     DPTR
0029 E0                MOVX    A,@DPTR
002A FF                MOV     R7,A
002B 900000      R     MOV     DPTR,#export_index
002E E0                MOVX    A,@DPTR
002F FC                MOV     R4,A
0030 A3                INC     DPTR
0031 E0                MOVX    A,@DPTR
0032 FD                MOV     R5,A
0033 ED                MOV     A,R5
0034 6F                XRL     A,R7
0035 7002              JNZ     ?C0097
0037 EC                MOV     A,R4
0038 6E                XRL     A,R6
0039         ?C0097:
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 24  

0039 7045              JNZ     ?C0060
003B 900000      E     MOV     DPTR,#mem_full_flag
003E E0                MOVX    A,@DPTR
003F FF                MOV     R7,A
0040 EF                MOV     A,R7
0041 703D              JNZ     ?C0060
                                           ; SOURCE LINE # 296
0043 900000      R     MOV     DPTR,#export_buffer
0046 74A0              MOV     A,#0A0H
0048 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 298
0049 900000      R     MOV     DPTR,#i
004C 7401              MOV     A,#01H
004E F0                MOVX    @DPTR,A
004F         ?C0053:
004F 900000      R     MOV     DPTR,#i
0052 E0                MOVX    A,@DPTR
0053 FF                MOV     R7,A
0054 EF                MOV     A,R7
0055 C3                CLR     C
0056 9440              SUBB    A,#040H
0058 501A              JNC     ?C0054
                                           ; SOURCE LINE # 299
005A 900000      R     MOV     DPTR,#i
005D E0                MOVX    A,@DPTR
005E FF                MOV     R7,A
005F 7400        R     MOV     A,#LOW export_buffer
0061 2F                ADD     A,R7
0062 F582              MOV     DPL,A
0064 E4                CLR     A
0065 3400        R     ADDC    A,#HIGH export_buffer
0067 F583              MOV     DPH,A
0069 7440              MOV     A,#040H
006B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 300
006C         ?C0055:
006C 900000      R     MOV     DPTR,#i
006F E0                MOVX    A,@DPTR
0070 04                INC     A
0071 F0                MOVX    @DPTR,A
0072 80DB              SJMP    ?C0053
0074         ?C0054:
                                           ; SOURCE LINE # 301
0074 7B01              MOV     R3,#01H
0076 7A00        R     MOV     R2,#HIGH export_buffer
0078 7900        R     MOV     R1,#LOW export_buffer
007A 120000      R     LCALL   _load_buffer
                                           ; SOURCE LINE # 303
007D 020000      R     LJMP    exit
                                           ; SOURCE LINE # 304
0080         ?C0052:
0080         ?C0059:
                                           ; SOURCE LINE # 308
0080         ?C0060:
                                           ; SOURCE LINE # 310
0080 900000      R     MOV     DPTR,#i
0083 E0                MOVX    A,@DPTR
0084 FF                MOV     R7,A
0085 EF                MOV     A,R7
0086 C3                CLR     C
0087 9440              SUBB    A,#040H
0089 4003              JC      $ + 5H
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 25  

008B 020000      R     LJMP    ?C0061
                                           ; SOURCE LINE # 311
                                           ; SOURCE LINE # 312
008E 900000      R     MOV     DPTR,#export_index
0091 E0                MOVX    A,@DPTR
0092 FE                MOV     R6,A
0093 A3                INC     DPTR
0094 E0                MOVX    A,@DPTR
0095 FF                MOV     R7,A
0096 7400        E     MOV     A,#LOW sample_block
0098 2F                ADD     A,R7
0099 F582              MOV     DPL,A
009B 7400        E     MOV     A,#HIGH sample_block
009D 3E                ADDC    A,R6
009E F583              MOV     DPH,A
00A0 E4                CLR     A
00A1 93                MOVC    A,@A+DPTR
00A2 FF                MOV     R7,A
00A3 900000      R     MOV     DPTR,#i
00A6 E0                MOVX    A,@DPTR
00A7 FE                MOV     R6,A
00A8 7400        R     MOV     A,#LOW export_buffer
00AA 2E                ADD     A,R6
00AB F582              MOV     DPL,A
00AD E4                CLR     A
00AE 3400        R     ADDC    A,#HIGH export_buffer
00B0 F583              MOV     DPH,A
00B2 EF                MOV     A,R7
00B3 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 313
00B4 900000      R     MOV     DPTR,#i
00B7 E0                MOVX    A,@DPTR
00B8 04                INC     A
00B9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 314
00BA 900000      R     MOV     DPTR,#export_index
00BD E4                CLR     A
00BE 75F001            MOV     B,#01H
00C1 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 315
00C4 900000      R     MOV     DPTR,#byte_count
00C7 E4                CLR     A
00C8 75F001            MOV     B,#01H
00CB 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 319
00CE 900000      R     MOV     DPTR,#export_index
00D1 E0                MOVX    A,@DPTR
00D2 FE                MOV     R6,A
00D3 A3                INC     DPTR
00D4 E0                MOVX    A,@DPTR
00D5 FF                MOV     R7,A
00D6 C3                CLR     C
00D7 EF                MOV     A,R7
00D8 94A8              SUBB    A,#0A8H
00DA EE                MOV     A,R6
00DB 9461              SUBB    A,#061H
00DD 4008              JC      ?C0062
                                           ; SOURCE LINE # 320
00DF 900000      R     MOV     DPTR,#export_index
00E2 E4                CLR     A
00E3 F0                MOVX    @DPTR,A
00E4 A3                INC     DPTR
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 26  

00E5 E4                CLR     A
00E6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 321
00E7         ?C0062:
                                           ; SOURCE LINE # 325
00E7 900000      E     MOV     DPTR,#sample_tail_index
00EA E0                MOVX    A,@DPTR
00EB FE                MOV     R6,A
00EC A3                INC     DPTR
00ED E0                MOVX    A,@DPTR
00EE FF                MOV     R7,A
00EF 900000      R     MOV     DPTR,#export_index
00F2 E0                MOVX    A,@DPTR
00F3 FC                MOV     R4,A
00F4 A3                INC     DPTR
00F5 E0                MOVX    A,@DPTR
00F6 FD                MOV     R5,A
00F7 ED                MOV     A,R5
00F8 6F                XRL     A,R7
00F9 7002              JNZ     ?C0098
00FB EC                MOV     A,R4
00FC 6E                XRL     A,R6
00FD         ?C0098:
00FD 7081              JNZ     ?C0060
                                           ; SOURCE LINE # 326
00FF 900000      R     MOV     DPTR,#i
0102 E0                MOVX    A,@DPTR
0103 FF                MOV     R7,A
0104 7400        R     MOV     A,#LOW export_buffer
0106 2F                ADD     A,R7
0107 F582              MOV     DPL,A
0109 E4                CLR     A
010A 3400        R     ADDC    A,#HIGH export_buffer
010C F583              MOV     DPH,A
010E 7440              MOV     A,#040H
0110 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 327
0111 8003              SJMP    ?C0061
                                           ; SOURCE LINE # 328
0113         ?C0063:
                                           ; SOURCE LINE # 329
0113 020000      R     LJMP    ?C0060
0116         ?C0061:
                                           ; SOURCE LINE # 332
0116 7B01              MOV     R3,#01H
0118 7A00        R     MOV     R2,#HIGH export_buffer
011A 7900        R     MOV     R1,#LOW export_buffer
011C 120000      R     LCALL   _load_buffer
                                           ; SOURCE LINE # 333
011F 900000      R     MOV     DPTR,#i
0122 E4                CLR     A
0123 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 336
0124 120000      R     LCALL   wait_for_continue
0127 EF                MOV     A,R7
0128 B43008            CJNE    A,#030H,?C0057
                                           ; SOURCE LINE # 337
012B 900000      R     MOV     DPTR,#result
012E 7430              MOV     A,#030H
0130 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 338
0131 805B              SJMP    exit
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 27  

                                           ; SOURCE LINE # 339
0133         ?C0064:
                                           ; SOURCE LINE # 340
0133         ?C0057:
0133 900000      E     MOV     DPTR,#sample_tail_index
0136 E0                MOVX    A,@DPTR
0137 FE                MOV     R6,A
0138 A3                INC     DPTR
0139 E0                MOVX    A,@DPTR
013A FF                MOV     R7,A
013B 900000      R     MOV     DPTR,#export_index
013E E0                MOVX    A,@DPTR
013F FC                MOV     R4,A
0140 A3                INC     DPTR
0141 E0                MOVX    A,@DPTR
0142 FD                MOV     R5,A
0143 ED                MOV     A,R5
0144 6F                XRL     A,R7
0145 7002              JNZ     ?C0099
0147 EC                MOV     A,R4
0148 6E                XRL     A,R6
0149         ?C0099:
0149 6003              JZ      $ + 5H
014B 020000      R     LJMP    ?C0060
014E         ?C0058:
                                           ; SOURCE LINE # 344
014E 900000      R     MOV     DPTR,#byte_count
0151 E4                CLR     A
0152 75F004            MOV     B,#04H
0155 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 347
0158 900000      R     MOV     DPTR,#export_buffer
015B 7480              MOV     A,#080H
015D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 348
015E 900000      R     MOV     DPTR,#export_buffer+01H
0161 E4                CLR     A
0162 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 352
0163 900000      R     MOV     DPTR,#byte_count
0166 E0                MOVX    A,@DPTR
0167 FE                MOV     R6,A
0168 A3                INC     DPTR
0169 E0                MOVX    A,@DPTR
016A FF                MOV     R7,A
016B EE                MOV     A,R6
016C FF                MOV     R7,A
016D 7E00              MOV     R6,#00H
016F 900000      R     MOV     DPTR,#export_buffer+02H
0172 EF                MOV     A,R7
0173 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 353
0174 900000      R     MOV     DPTR,#byte_count
0177 E0                MOVX    A,@DPTR
0178 FE                MOV     R6,A
0179 A3                INC     DPTR
017A E0                MOVX    A,@DPTR
017B FF                MOV     R7,A
017C EF                MOV     A,R7
017D 54FF              ANL     A,#0FFH
017F FF                MOV     R7,A
0180 900000      R     MOV     DPTR,#export_buffer+03H
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 28  

0183 EF                MOV     A,R7
0184 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 355
0185 7B01              MOV     R3,#01H
0187 7A00        R     MOV     R2,#HIGH export_buffer
0189 7900        R     MOV     R1,#LOW export_buffer
018B 120000      R     LCALL   _load_buffer
                                           ; SOURCE LINE # 357
018E         exit:
                                           ; SOURCE LINE # 359
018E 900000      R     MOV     DPTR,#result
0191 E0                MOVX    A,@DPTR
0192 FF                MOV     R7,A
                                           ; SOURCE LINE # 360
0193         ?C0065:
0193 22                RET     
             ; FUNCTION export_samples (END)

             ; FUNCTION _load_buffer (BEGIN)
                                           ; SOURCE LINE # 362
0000 900000      R     MOV     DPTR,#export_buffer
0003 120000      E     LCALL   ?C?PSTXDATA
0006         ?C0066:
                                           ; SOURCE LINE # 370
0006 120000      E     LCALL   USBUART_CDCIsReady
0009 EF                MOV     A,R7
000A 7006              JNZ     ?C0067
000C 120000      E     LCALL   Vbus_Read
000F EF                MOV     A,R7
0010 70F4              JNZ     ?C0066
0012         ?C0067:
                                           ; SOURCE LINE # 371
0012 900000      R     MOV     DPTR,#export_buffer
0015 120000      E     LCALL   ?C?PLDXDATA
0018 7D40              MOV     R5,#040H
001A 7C00              MOV     R4,#00H
001C 120000      E     LCALL   _USBUART_PutData
001F         ?C0068:
                                           ; SOURCE LINE # 374
001F 120000      E     LCALL   USBUART_CDCIsReady
0022 EF                MOV     A,R7
0023 7006              JNZ     ?C0069
0025 120000      E     LCALL   Vbus_Read
0028 EF                MOV     A,R7
0029 70F4              JNZ     ?C0068
002B         ?C0069:
                                           ; SOURCE LINE # 375
002B 900000      R     MOV     DPTR,#export_buffer
002E 120000      E     LCALL   ?C?PLDXDATA
0031 7D00              MOV     R5,#00H
0033 7C00              MOV     R4,#00H
0035 120000      E     LCALL   _USBUART_PutData
                                           ; SOURCE LINE # 378
0038         ?C0070:
0038 22                RET     
             ; FUNCTION _load_buffer (END)

             ; FUNCTION wait_for_continue (BEGIN)
                                           ; SOURCE LINE # 380
                                           ; SOURCE LINE # 386
0000 900000      R     MOV     DPTR,#reply
0003 E4                CLR     A
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 29  

0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 387
0005 900000      R     MOV     DPTR,#retrieve_from_buffer_status
0008 E4                CLR     A
0009 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 388
000A 900000      R     MOV     DPTR,#continue_status
000D 7430              MOV     A,#030H
000F F0                MOVX    @DPTR,A
0010         ?C0071:
                                           ; SOURCE LINE # 390
0010 900000      R     MOV     DPTR,#reply
0013 E0                MOVX    A,@DPTR
0014 FF                MOV     R7,A
0015 EF                MOV     A,R7
0016 7050              JNZ     ?C0072
0018 120000      E     LCALL   Vbus_Read
001B EF                MOV     A,R7
001C 604A              JZ      ?C0072
001E         ?C0073:
                                           ; SOURCE LINE # 392
001E 120000      E     LCALL   USBUART_GetCount
0021 EF                MOV     A,R7
0022 4E                ORL     A,R6
0023 7006              JNZ     ?C0074
0025 120000      E     LCALL   Vbus_Read
0028 EF                MOV     A,R7
0029 70F3              JNZ     ?C0073
002B         ?C0074:
                                           ; SOURCE LINE # 393
002B 7B01              MOV     R3,#01H
002D 7A00        R     MOV     R2,#HIGH reply
002F 7900        R     MOV     R1,#LOW reply
0031 7D01              MOV     R5,#01H
0033 120000      R     LCALL   _retrieve_from_buffer
0036 900000      R     MOV     DPTR,#retrieve_from_buffer_status
0039 EF                MOV     A,R7
003A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 395
003B 900000      R     MOV     DPTR,#retrieve_from_buffer_status
003E E0                MOVX    A,@DPTR
003F FF                MOV     R7,A
0040 EF                MOV     A,R7
0041 B42013            CJNE    A,#020H,?C0075
0044 900000      R     MOV     DPTR,#reply
0047 E0                MOVX    A,@DPTR
0048 FF                MOV     R7,A
0049 EF                MOV     A,R7
004A B4070A            CJNE    A,#07H,?C0075
                                           ; SOURCE LINE # 397
004D 900000      R     MOV     DPTR,#continue_status
0050 7420              MOV     A,#020H
0052 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 398
0053 8013              SJMP    ?C0072
                                           ; SOURCE LINE # 399
0055 80B9              SJMP    ?C0071
0057         ?C0075:
                                           ; SOURCE LINE # 401
0057 900000      R     MOV     DPTR,#retrieve_from_buffer_status
005A E0                MOVX    A,@DPTR
005B FF                MOV     R7,A
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 30  

005C EF                MOV     A,R7
005D B420B0            CJNE    A,#020H,?C0071
                                           ; SOURCE LINE # 402
0060 900000      R     MOV     DPTR,#continue_status
0063 7430              MOV     A,#030H
0065 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 403
0066         ?C0077:
0066         ?C0076:
                                           ; SOURCE LINE # 404
0066 80A8              SJMP    ?C0071
0068         ?C0072:
                                           ; SOURCE LINE # 406
0068 900000      R     MOV     DPTR,#continue_status
006B E0                MOVX    A,@DPTR
006C FF                MOV     R7,A
                                           ; SOURCE LINE # 407
006D         ?C0078:
006D 22                RET     
             ; FUNCTION wait_for_continue (END)

             ; FUNCTION confirm_export (BEGIN)
                                           ; SOURCE LINE # 409
                                           ; SOURCE LINE # 417
0000 900000      R     MOV     DPTR,#command
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
0005         ?C0079:
                                           ; SOURCE LINE # 419
0005 120000      E     LCALL   Vbus_Read
0008 EF                MOV     A,R7
0009 6047              JZ      ?C0089
000B         ?C0081:
                                           ; SOURCE LINE # 420
000B 120000      E     LCALL   USBUART_DataIsReady
000E EF                MOV     A,R7
000F 7006              JNZ     ?C0082
0011 120000      E     LCALL   Vbus_Read
0014 EF                MOV     A,R7
0015 70F4              JNZ     ?C0081
0017         ?C0082:
                                           ; SOURCE LINE # 422
0017 7B01              MOV     R3,#01H
0019 7A00        R     MOV     R2,#HIGH command
001B 7900        R     MOV     R1,#LOW command
001D 7D01              MOV     R5,#01H
001F 120000      R     LCALL   _retrieve_from_buffer
0022 EF                MOV     A,R7
0023 B420DF            CJNE    A,#020H,?C0079
                                           ; SOURCE LINE # 424
0026 900000      R     MOV     DPTR,#command
0029 E0                MOVX    A,@DPTR
002A FF                MOV     R7,A
002B EF                MOV     A,R7
002C B42006            CJNE    A,#020H,?C0084
                                           ; SOURCE LINE # 425
002F 120000      E     LCALL   clear_samples
                                           ; SOURCE LINE # 426
0032 22                RET     
                                           ; SOURCE LINE # 427
0033 80D0              SJMP    ?C0079
0035         ?C0084:
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 31  

                                           ; SOURCE LINE # 429
0035 900000      R     MOV     DPTR,#command
0038 E0                MOVX    A,@DPTR
0039 FF                MOV     R7,A
003A EF                MOV     A,R7
003B B40708            CJNE    A,#07H,?C0086
                                           ; SOURCE LINE # 430
003E 7F30              MOV     R7,#030H
0040 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 431
0043 22                RET     
                                           ; SOURCE LINE # 432
0044 80BF              SJMP    ?C0079
0046         ?C0086:
                                           ; SOURCE LINE # 434
0046 900000      R     MOV     DPTR,#command
0049 E0                MOVX    A,@DPTR
004A FF                MOV     R7,A
004B EF                MOV     A,R7
004C B430B6            CJNE    A,#030H,?C0079
                                           ; SOURCE LINE # 435
004F 22                RET     
                                           ; SOURCE LINE # 436
0050         ?C0088:
0050         ?C0087:
0050         ?C0085:
                                           ; SOURCE LINE # 437
0050         ?C0083:
                                           ; SOURCE LINE # 438
0050 80B3              SJMP    ?C0079
0052         ?C0080:
                                           ; SOURCE LINE # 441
0052         ?C0089:
0052 22                RET     
             ; FUNCTION confirm_export (END)

             ; FUNCTION update_RTC (BEGIN)
                                           ; SOURCE LINE # 443
                                           ; SOURCE LINE # 449
0000 900000      R     MOV     DPTR,#result
0003 7430              MOV     A,#030H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 450
0006 7BFF              MOV     R3,#0FFH
0008 7A00        R     MOV     R2,#HIGH _?ix1001
000A 7900        R     MOV     R1,#LOW _?ix1001
000C C003              PUSH    AR3
000E C002              PUSH    AR2
0010 C001              PUSH    AR1
0012 7B01              MOV     R3,#01H
0014 7A00        R     MOV     R2,#HIGH time_buffer
0016 7900        R     MOV     R1,#LOW time_buffer
0018 A801              MOV     R0,AR1
001A AC02              MOV     R4,AR2
001C AD03              MOV     R5,AR3
001E D001              POP     AR1
0020 D002              POP     AR2
0022 D003              POP     AR3
0024 7E00              MOV     R6,#00H
0026 7F07              MOV     R7,#07H
0028 120000      E     LCALL   ?C?COPYAMD
002B         ?C0090:
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 32  

                                           ; SOURCE LINE # 453
002B 120000      E     LCALL   USBUART_DataIsReady
002E EF                MOV     A,R7
002F 7006              JNZ     ?C0091
0031 120000      E     LCALL   Vbus_Read
0034 EF                MOV     A,R7
0035 70F4              JNZ     ?C0090
0037         ?C0091:
                                           ; SOURCE LINE # 455
0037 120000      E     LCALL   Vbus_Read
003A EF                MOV     A,R7
003B 7003              JNZ     $ + 5H
003D 020000      R     LJMP    ?C0092
                                           ; SOURCE LINE # 456
0040 7B01              MOV     R3,#01H
0042 7A00        R     MOV     R2,#HIGH time_buffer
0044 7900        R     MOV     R1,#LOW time_buffer
0046 7D07              MOV     R5,#07H
0048 120000      R     LCALL   _retrieve_from_buffer
004B EF                MOV     A,R7
004C 6420              XRL     A,#020H
004E 7071              JNZ     ?C0092
                                           ; SOURCE LINE # 457
0050 900000      R     MOV     DPTR,#time_buffer
0053 E0                MOVX    A,@DPTR
0054 FF                MOV     R7,A
0055 7E00              MOV     R6,#00H
0057 EF                MOV     A,R7
0058 7F00              MOV     R7,#00H
005A FE                MOV     R6,A
005B 900000      R     MOV     DPTR,#new_time+08H
005E EE                MOV     A,R6
005F F0                MOVX    @DPTR,A
0060 A3                INC     DPTR
0061 EF                MOV     A,R7
0062 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 458
0063 900000      R     MOV     DPTR,#time_buffer+01H
0066 E0                MOVX    A,@DPTR
0067 FF                MOV     R7,A
0068 7E00              MOV     R6,#00H
006A 900000      R     MOV     DPTR,#new_time+08H
006D E0                MOVX    A,@DPTR
006E FC                MOV     R4,A
006F A3                INC     DPTR
0070 E0                MOVX    A,@DPTR
0071 FD                MOV     R5,A
0072 EE                MOV     A,R6
0073 4C                ORL     A,R4
0074 FE                MOV     R6,A
0075 EF                MOV     A,R7
0076 4D                ORL     A,R5
0077 FF                MOV     R7,A
0078 900000      R     MOV     DPTR,#new_time+08H
007B EE                MOV     A,R6
007C F0                MOVX    @DPTR,A
007D A3                INC     DPTR
007E EF                MOV     A,R7
007F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 459
0080 900000      R     MOV     DPTR,#time_buffer+02H
0083 E0                MOVX    A,@DPTR
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 33  

0084 FF                MOV     R7,A
0085 900000      R     MOV     DPTR,#new_time
0088 EF                MOV     A,R7
0089 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 460
008A 900000      R     MOV     DPTR,#time_buffer+03H
008D E0                MOVX    A,@DPTR
008E FF                MOV     R7,A
008F 900000      R     MOV     DPTR,#new_time+01H
0092 EF                MOV     A,R7
0093 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 461
0094 900000      R     MOV     DPTR,#time_buffer+04H
0097 E0                MOVX    A,@DPTR
0098 FF                MOV     R7,A
0099 900000      R     MOV     DPTR,#new_time+02H
009C EF                MOV     A,R7
009D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 462
009E 900000      R     MOV     DPTR,#time_buffer+05H
00A1 E0                MOVX    A,@DPTR
00A2 FF                MOV     R7,A
00A3 900000      R     MOV     DPTR,#new_time+04H
00A6 EF                MOV     A,R7
00A7 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 463
00A8 900000      R     MOV     DPTR,#time_buffer+06H
00AB E0                MOVX    A,@DPTR
00AC FF                MOV     R7,A
00AD 900000      R     MOV     DPTR,#new_time+07H
00B0 EF                MOV     A,R7
00B1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 465
00B2 7B01              MOV     R3,#01H
00B4 7A00        R     MOV     R2,#HIGH new_time
00B6 7900        R     MOV     R1,#LOW new_time
00B8 120000      E     LCALL   _RTC_WriteTime
                                           ; SOURCE LINE # 467
00BB 900000      R     MOV     DPTR,#result
00BE 7420              MOV     A,#020H
00C0 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 469
00C1         ?C0093:
                                           ; SOURCE LINE # 470
00C1         ?C0092:
                                           ; SOURCE LINE # 472
00C1 900000      R     MOV     DPTR,#result
00C4 E0                MOVX    A,@DPTR
00C5 FF                MOV     R7,A
                                           ; SOURCE LINE # 473
00C6         ?C0094:
00C6 22                RET     
             ; FUNCTION update_RTC (END)

             ; FUNCTION USB_Close (BEGIN)
                                           ; SOURCE LINE # 475
                                           ; SOURCE LINE # 481
0000 120000      E     LCALL   USBUART_Stop
                                           ; SOURCE LINE # 482
0003 120000      E     LCALL   Vbus_ClearInterrupt
                                           ; SOURCE LINE # 483
0006 120000      E     LCALL   Vbus_IRQ_ClearPending
C51 COMPILER V9.51   USB_HANDLER                                                           05/31/2014 14:22:03 PAGE 34  

                                           ; SOURCE LINE # 484
0009 120000      E     LCALL   clear_button_interrupts
                                           ; SOURCE LINE # 485
000C 900000      E     MOV     DPTR,#USB_waiting
000F E4                CLR     A
0010 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 488
0011 120000      E     LCALL   sampling_setup
                                           ; SOURCE LINE # 491
0014 120000      E     LCALL   ModifyCollection_IRQ_Start
                                           ; SOURCE LINE # 492
0017 120000      E     LCALL   Vbus_IRQ_Start
                                           ; SOURCE LINE # 495
001A         ?C0095:
001A 22                RET     
             ; FUNCTION USB_Close (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2026    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =    141    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
