C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE USB_HANDLER
OBJECT MODULE PLACED IN .\DP8051\DP8051_Keil_951\Debug\USB_handler.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Cypress\PSoC Creator\3.0\PSoC Creator\import\keil\pk51\9.51\C51\BIN\c51.exe 
                    -.\USB_handler.c NOIV LARGE MODDP2 OMF2 VB(1) PR(.\DP8051\DP8051_Keil_951\Debug\USB_handler.lst) CD DB NOIP OT(0,SIZE) DF
                    -(DEBUG) INCDIR(.,.\Generated_Source\PSoC3) OJ(.\DP8051\DP8051_Keil_951\Debug\USB_handler.obj)

line level    source

   1          /* ========================================
   2           *
   3           * (c) Erebus Labs Ltd. 2014
   4           *
   5           * Project: Erebus Labs Sensor
   6           * File:    USB_handler.c
   7           *
   8           * Handles USB communication and USB host-initiated tasks
   9           *
  10           * ========================================
  11          */
  12          
  13          /*
  14           * ========================================
  15           * Header Files
  16           * ========================================
  17          */
  18          
  19          /* C Library Headers */
  20          #include <stdlib.h>
  21          #include <math.h>
  22          
  23          /* Cypress Headers */
  24          #include "project.h"
  25          
  26          /* Project Headers */
  27          #include "globals.h"
  28          #include "utility.h"
  29          #include "sample_handler.h"   
  30          #include "USB_handler.h"
  31          
  32          /*
  33           * ========================================
  34           * Function Definitions
  35           * ========================================
  36          */
  37          
  38          static uint8 retrieve_from_buffer(uint8* buffer, uint8 num_bytes){
  39   1      /* 
  40   1       * Retrieves the specified number of bytes from the USBUART buffer, if possible - if a
  41   1       * different number of bytes is pulled from the buffer, a failure is reported to the
  42   1       * calling routine.
  43   1      */
  44   1      
  45   1          uint16 count = 0;
  46   1          uint8 attempts = 0;
  47   1          uint8 result = FAIL;
  48   1          
  49   1          count = USBUART_GetCount(); 
  50   1          
  51   1          /* If data in buffer is the right amount retrieve_from_buffer it */
  52   1          if (count == num_bytes){
  53   2              USBUART_GetData(buffer, num_bytes);
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 2   

  54   2              result = SUCCESS;
  55   2          }
  56   1          /* Otherwise, flush the USB buffer and report fail */
  57   1          else if (count > 0){
  58   2              USBUART_GetChar();
  59   2          }
  60   1          
  61   1          return result;
  62   1      }
  63          
  64          static void send_reply(uint8 message){
  65   1      /* 
  66   1       * Once the host is ready, sends the reply specified by message.
  67   1      */
  68   1         
  69   1          while (!USBUART_CDCIsReady() && check_usb_connection());
  70   1          
  71   1          if (check_usb_connection()){
  72   2              USBUART_PutData(&message, REPLY_LEN);
  73   2          }
  74   1          
  75   1          return;
  76   1      }
  77          
  78          static void send_settings(){
  79   1      /*
  80   1       * Retrieves current sample settings stored in EEPROM and sends them to the host.
  81   1      */
  82   1          
  83   1          uint8 settings[NUM_SETTINGS];
  84   1          
  85   1          settings[0] = get_EEPROM_variable(EE_SENSOR);
  86   1          settings[1] = get_EEPROM_variable(EE_SAMPLE_UNIT);
  87   1          settings[2] = get_EEPROM_variable(EE_SAMPLE_INTERVAL);
  88   1          
  89   1          while (!USBUART_CDCIsReady() && check_usb_connection());
  90   1          
  91   1          if (check_usb_connection()){
  92   2              USBUART_PutData((uint8*) &settings, sizeof(settings));
  93   2          }
  94   1          
  95   1          return;   
  96   1      }
  97          
  98          static uint8 update_settings(struct sampling_settings new_settings){
  99   1      /*
 100   1       * Handles updating EEPROM with new settings. Updating the settings in EEPROM requires
 101   1       * a Read-Modify-Write cycle of the whole EEPROM sector.
 102   1      */
 103   1          
 104   1          uint8* buffer;
 105   1          float rows_used = 0;
 106   1          uint16 remainder = 0;
 107   1          uint8* src_ptr;
 108   1          uint8* dst_ptr;
 109   1          uint8 i = 0; 
 110   1          float bytes_used = EEPROM_BYTES_USED;
 111   1          uint8 result = SUCCESS;
 112   1          cystatus status;
 113   1          
 114   1          /* Allocate array to hold EEPROM variables */
 115   1          
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 3   

 116   1          rows_used = ceil(bytes_used/CYDEV_EEPROM_ROW_SIZE);
 117   1          buffer = malloc(((uint16) rows_used) * CYDEV_EEPROM_ROW_SIZE);
 118   1          
 119   1          dst_ptr = buffer;
 120   1          remainder = (rows_used * 16) - EEPROM_BYTES_USED;
 121   1          
 122   1          /* Copy all variables into SRAM */
 123   1          for (i=0; i<EEPROM_BYTES_USED; ++i, ++dst_ptr){
 124   2              *dst_ptr = CY_GET_REG8(CYDEV_EE_BASE + i);
 125   2          }
 126   1          
 127   1          /* Fill remainder of buffer with zeros */
 128   1          for (i = 0; i < remainder; ++i, ++dst_ptr){
 129   2                      *dst_ptr = 0;
 130   2          }
 131   1      /*    
 132   1          while (i < remainder){
 133   1              *dst_ptr = 0;
 134   1              ++i;
 135   1          }
 136   1       */   
 137   1          /* Modify variables in SRAM */
 138   1          buffer[0] = new_settings.sensor;
 139   1          buffer[1] = new_settings.sample_unit;
 140   1          buffer[2] = new_settings.sample_interval;
 141   1          
 142   1          /* Disable interrupts and erase EEPROM */
 143   1          CyGlobalIntDisable;
 144   1          status = Re_EEPROM_EraseSector(SECTOR_NUMBER);
 145   1          CyGlobalIntEnable;
 146   1          
 147   1          if (CYRET_SUCCESS != status){
 148   2              result = FAIL;
 149   2              goto exit;
 150   2          }
 151   1          
 152   1          /* Write back modified EEPROM Variables */
 153   1          i = 0;
 154   1          src_ptr = buffer;
 155   1          while ((i < rows_used) && (i < EEPROM_ROWS)){
 156   2              
 157   2              /* Disable interrupts during EEPROM write operation */
 158   2              CyGlobalIntDisable;
 159   2              status = Re_EEPROM_Write(src_ptr, i);
 160   2              CyGlobalIntEnable;
 161   2              
 162   2              if (CYRET_SUCCESS != status){
 163   3                  result = FAIL;
 164   3                  goto exit;
 165   3              }
 166   2              
 167   2              src_ptr = src_ptr + CYDEV_EEPROM_ROW_SIZE;
 168   2              ++i;
 169   2          }
 170   1           
 171   1          free(buffer);
 172   1          
 173   1      exit:   
 174   1          return result;   
 175   1      }
 176          
 177          static uint8 apply_settings(){
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 4   

 178   1      /* 
 179   1       * Retrieves new settings from the USBUART buffer that were sent by the host and stores
 180   1       * them in EEPROM.
 181   1      */
 182   1          uint8 result = FAIL;
 183   1          uint8 settings_buffer[NUM_SETTINGS] = {0};
 184   1          struct sampling_settings new_settings;
 185   1          
 186   1          while (!USBUART_DataIsReady() && check_usb_connection());
 187   1          
 188   1          if (check_usb_connection()){
 189   2              if (SUCCESS == retrieve_from_buffer(settings_buffer, NUM_SETTINGS)){
 190   3      
 191   3                  new_settings.sensor = settings_buffer[0];
 192   3                  new_settings.sample_unit = settings_buffer[1];
 193   3                  new_settings.sample_interval = settings_buffer[2];
 194   3                  
 195   3                  result = update_settings(new_settings);   
 196   3              }
 197   2          } 
 198   1          
 199   1          return result;
 200   1      }
 201          
 202          static void load_buffer(uint8* export_buffer){
 203   1      /*
 204   1       * Loads a 64-byte export buffer into the USBUART buffer to be sent to the host.
 205   1       * USB Specification says that when a maximum payload size packet (64-bytes) is sent
 206   1       * to the host, the host does not consider the transaction complete unless it is
 207   1       * followed by a zero-length packet, so we send one after loading the export_buffer.
 208   1      */
 209   1          
 210   1          while (!USBUART_CDCIsReady() && check_usb_connection());
 211   1          USBUART_PutData(export_buffer, BUFFER_LEN);
 212   1         
 213   1          /* Add zero-length packet so host completes transaction */
 214   1          while (!USBUART_CDCIsReady() && check_usb_connection());
 215   1          USBUART_PutData(export_buffer, 0);
 216   1      
 217   1          return;
 218   1      }
 219              
 220          static uint8 wait_for_continue(){
 221   1      /* 
 222   1       * Stalls until a reply is received from the host. The result of that reply is returned.
 223   1       * Data dumping with the Python GUI is very heavily interlocked, with replies from the
 224   1       * host expected between every 64-byte packet.
 225   1      */
 226   1          uint8 reply = 0;
 227   1          uint8 retrieve_from_buffer_status = 0;
 228   1          uint8 continue_status = FAIL;
 229   1      
 230   1          while (!reply && check_usb_connection()){
 231   2                  
 232   2              while (!USBUART_GetCount() && check_usb_connection()); 
 233   2              retrieve_from_buffer_status = retrieve_from_buffer(&reply, COMMAND_LENGTH);
 234   2              
 235   2              if ((SUCCESS == retrieve_from_buffer_status) && (NEXT == reply)){
 236   3                  continue_status = SUCCESS;
 237   3                  break;
 238   3              }
 239   2              
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 5   

 240   2              else if (retrieve_from_buffer_status == SUCCESS){
 241   3                  continue_status = FAIL;            
 242   3              }
 243   2          }    
 244   1          
 245   1          return continue_status;
 246   1      }
 247          
 248          static void confirm_export(){
 249   1      /*
 250   1       * Awaits a SUCCESS or FAIL reply from the host when dumping samples is complete. If
 251   1       * the host replies with SUCCESS (indicating that they received the expected number of
 252   1       * bytes) then we clear the sample array. If not, simply return and wait for the host
 253   1       * to send the dump data command again.
 254   1      */
 255   1      
 256   1          uint8 command = 0;
 257   1          
 258   1          while (check_usb_connection()){
 259   2              while (!USBUART_DataIsReady() && check_usb_connection());
 260   2                      
 261   2              if (SUCCESS == retrieve_from_buffer(&command, COMMAND_LENGTH)){
 262   3                  
 263   3                  if (SUCCESS == command){
 264   4                      clear_samples();           
 265   4                      break;
 266   4                  }
 267   3                  
 268   3                  else if (NEXT == command){
 269   4                      send_reply(FAIL);
 270   4                      break;   
 271   4                  }
 272   3                  
 273   3                  else if (FAIL == command){
 274   4                      break;
 275   4                  }            
 276   3              }
 277   2          }
 278   1          
 279   1          return;
 280   1      }
 281          
 282          static uint8 export_samples(){
 283   1      /*
 284   1       * Dumps the contents of the Flash sample block to the host. This routine makes no
 285   1       * distinction between different types of data stored in Flash. It iterates through
 286   1       * the sample block array copying one byte at a time into the export buffer and does
 287   1       * no analysis of the bytes it is sending.
 288   1       *
 289   1       * Optimization suggestion: The export buffer could be eliminated in favor of passing
 290   1       * flash pointers to the load_buffer function and incrementing the pointers
 291   1       * 64-bytes at a time.
 292   1      */
 293   1          
 294   1          uint8 result = SUCCESS;
 295   1          uint8 export_buffer[BUFFER_LEN];
 296   1          uint16 export_index = sample_head_index; 
 297   1          uint16 byte_count = 0;
 298   1          uint8 i = 0;
 299   1          
 300   1          /* Before doing a bunch of work, make sure we have samples to send */
 301   1          if ((export_index == sample_tail_index) && !mem_full_flag){
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 6   

 302   2              export_buffer[0] = NO_DATA;
 303   2              
 304   2              for (i=1; i< BUFFER_LEN; ++i){
 305   3                  export_buffer[i] = PADBYTE;
 306   3              }
 307   2              load_buffer(export_buffer);
 308   2                      
 309   2              goto exit;
 310   2          }
 311   1                  
 312   1          /* Loop 1: Iterate over data samples until export pointer meets the tail */
 313   1          do
 314   1          {   
 315   2              /* Loop 2: Iterate over the 64-byte USB buffer, copying bytes into it */
 316   2              while (i < BUFFER_LEN)
 317   2              {
 318   3                  export_buffer[i] = sample_block[export_index];
 319   3                  ++i;
 320   3                  ++export_index;
 321   3                  ++byte_count;
 322   3      
 323   3                  /* Check to make sure we're not incrementing export_ptr past
 324   3                   * the bounds of our sample array - wrap around to first element if true */
 325   3                  if (export_index >= SAMPLE_BLOCK_SIZE){
 326   4                          export_index = 0;
 327   4                  }
 328   3      
 329   3                  /* Once the last sample byte has been put in the buffer,
 330   3                   * add a pad byte to mark the end of this packet */
 331   3                  if (export_index == sample_tail_index){
 332   4                      export_buffer[i] = PADBYTE;
 333   4                      break;
 334   4                  }           
 335   3              }
 336   2              
 337   2              /* Send 64-byte packet to host */
 338   2              load_buffer(export_buffer);
 339   2              i = 0;
 340   2              
 341   2              /* Wait for permission from host to send next packet */
 342   2              if (wait_for_continue() == FAIL){
 343   3                  result = FAIL;
 344   3                  goto exit;
 345   3              }
 346   2          } while (export_index != sample_tail_index);
 347   1          
 348   1          /* Add the size trailer packet to get total transmission size,
 349   1           * excluding pad bytes */
 350   1          byte_count = byte_count + 4;
 351   1          
 352   1          /* Trailer Packet to Identify End of Sampled Data in Memory */ 
 353   1          export_buffer[0] = 0x80; /* End of Data Identifier */
 354   1          export_buffer[1] = 0x00;
 355   1          
 356   1          /* Byte count may be up to 16-bits long - split into two bytes
 357   1           * and copy to buffer */
 358   1          export_buffer[2] = (uint8)(byte_count >> 8);
 359   1          export_buffer[3] = (uint8)0x00FF & byte_count;
 360   1          
 361   1          load_buffer(export_buffer);
 362   1      
 363   1      exit:
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 7   

 364   1          
 365   1          return result;
 366   1      }
 367          
 368          static uint8 update_RTC(){
 369   1      /*
 370   1       * Invoked by the host every time a connection with the host application is made. Updates
 371   1       * the current time in the RTC with the time sent by the host.
 372   1      */
 373   1      
 374   1          uint8 result = FAIL;
 375   1          uint8 time_buffer[TIME_LENGTH] = {0};
 376   1          RTC_TIME_DATE new_time;
 377   1          
 378   1          while (!USBUART_DataIsReady() && check_usb_connection());
 379   1          
 380   1          if (check_usb_connection()){
 381   2              if (SUCCESS == retrieve_from_buffer(time_buffer, TIME_LENGTH)){
 382   3                  new_time.Year = ((uint16) time_buffer[0]) << 0x8;
 383   3                  new_time.Year = new_time.Year | ((uint16) time_buffer[1]);
 384   3                  new_time.Sec = time_buffer[2];
 385   3                  new_time.Min = time_buffer[3];
 386   3                  new_time.Hour = time_buffer[4];
 387   3                  new_time.DayOfMonth = time_buffer[5];
 388   3                  new_time.Month = time_buffer[6];
 389   3                  
 390   3                  RTC_WriteTime(&new_time);
 391   3                  
 392   3                  result = SUCCESS;
 393   3              }
 394   2          }
 395   1          
 396   1          return result;
 397   1      }
 398          
 399          static void USB_Close(){
 400   1      /*
 401   1       * Cleans up when the USB cable is disconnected.
 402   1      */
 403   1          
 404   1          /* Clear pending interrupts that occurred while plugged into host */
 405   1          USBUART_Stop();
 406   1          Vbus_ClearInterrupt();
 407   1          Vbus_IRQ_ClearPending();
 408   1          clear_button_interrupts();
 409   1          USB_waiting = 0;
 410   1          
 411   1          /* Reapply EEPROM variables to sample parameters in case they were changed */
 412   1          sampling_setup(); 
 413   1          
 414   1          /* Re-enter normal operating mode */
 415   1          ModifyCollection_IRQ_Start();
 416   1          Vbus_IRQ_Start();   
 417   1      
 418   1          return;
 419   1      }
 420          
 421          void Run_USB(){
 422   1      /*
 423   1       * Handles all USB communication with the host. Calls functions based on received
 424   1       * commands.
 425   1      */
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 8   

 426   1          
 427   1          /* Power has just been applied to the Vbus pin, so we enter USB communication mode */
 428   1      
 429   1          uint8 result = 0;
 430   1          uint8 command = 0;
 431   1      
 432   1          stop_collection();
 433   1          RTC_WriteIntervalMask(NONE_MASK);
 434   1          ModifyCollection_IRQ_Stop();
 435   1          Vbus_IRQ_Stop();
 436   1      
 437   1          USBUART_Start(0u, USBUART_5V_OPERATION);
 438   1          
 439   1          /* Wait for Device to enumerate */
 440   1          while (!USBUART_GetConfiguration() && check_usb_connection());
 441   1      
 442   1          /* Enumeration is done, enable OUT endpoint for receive data from Host */
 443   1          USBUART_CDC_Init();
 444   1          
 445   1          while (check_usb_connection())
 446   1          {  
 447   2              if (0u == USBUART_DataIsReady()){   /* Check for input data from PC */
 448   3                  continue;
 449   3              }
 450   2      
 451   2              result = retrieve_from_buffer(&command, COMMAND_LENGTH);
 452   2              
 453   2              /* Discard zero-length packets */
 454   2              if (NULL_BYTE == command){
 455   3                  continue;
 456   3              }
 457   2          
 458   2              /* Identify command and perform action */
 459   2              if (SUCCESS == result){
 460   3                  
 461   3                  switch (command){
 462   4              
 463   4                  case IDENTIFY:
 464   4                      send_reply(IDENTIFIER);
 465   4                      break;
 466   4                  
 467   4                  case DUMP_DATA:
 468   4                      if (export_samples()){
 469   5                          confirm_export();
 470   5                      }
 471   4                      else{
 472   5                          send_reply(FAIL);
 473   5                      }
 474   4                      break;
 475   4                      
 476   4                  case GET_SETTINGS:
 477   4                      send_settings();
 478   4                      break;
 479   4                      
 480   4                  case CHANGE_SETTING:
 481   4                      send_reply(SUCCESS);
 482   4                      if (SUCCESS == apply_settings()){
 483   5                          send_reply(SUCCESS);
 484   5                      }
 485   4                      else{
 486   5                          send_reply(FAIL);
 487   5                      }                  
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 9   

 488   4                      break;
 489   4                      
 490   4                  case UPDATE_RTC:
 491   4                      send_reply(SUCCESS);
 492   4                      if (SUCCESS == update_RTC()){
 493   5                          send_reply(SUCCESS);
 494   5                      }
 495   4                      else{
 496   5                          send_reply(FAIL);
 497   5                      }
 498   4                      break;
 499   4                   
 500   4                  case RESET_PTRS:
 501   4                      reset_pointers();
 502   4                      send_reply(SUCCESS);
 503   4                      break;
 504   4                      
 505   4                  default:
 506   4                      send_reply(FAIL);
 507   4                      break;
 508   4      
 509   4                  } /* switch (command) */
 510   3      
 511   3              } /* if (SUCCESS == result) */
 512   2      
 513   2              else{
 514   3                  send_reply(FAIL);
 515   3              }
 516   2      
 517   2          } /* while (check_usb_connection()) */
 518   1          
 519   1          USB_Close();
 520   1          
 521   1          return;
 522   1      }
 523          
 524          
 525          
 526          /* [] END OF FILE */
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 10  

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION _retrieve_from_buffer (BEGIN)
                                           ; SOURCE LINE # 38
0000 900000      R     MOV     DPTR,#buffer
0003 120000      E     LCALL   ?C?PSTXDATA
0006 900000      R     MOV     DPTR,#num_bytes
0009 ED                MOV     A,R5
000A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 45
000B 900000      R     MOV     DPTR,#count
000E E4                CLR     A
000F F0                MOVX    @DPTR,A
0010 A3                INC     DPTR
0011 E4                CLR     A
0012 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 46
0013 900000      R     MOV     DPTR,#attempts
0016 E4                CLR     A
0017 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 47
0018 900000      R     MOV     DPTR,#result
001B 7430              MOV     A,#030H
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 49
001E 120000      E     LCALL   USBUART_GetCount
0021 900000      R     MOV     DPTR,#count
0024 EE                MOV     A,R6
0025 F0                MOVX    @DPTR,A
0026 A3                INC     DPTR
0027 EF                MOV     A,R7
0028 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 52
0029 900000      R     MOV     DPTR,#num_bytes
002C E0                MOVX    A,@DPTR
002D FF                MOV     R7,A
002E 7E00              MOV     R6,#00H
0030 900000      R     MOV     DPTR,#count
0033 E0                MOVX    A,@DPTR
0034 FC                MOV     R4,A
0035 A3                INC     DPTR
0036 E0                MOVX    A,@DPTR
0037 FD                MOV     R5,A
0038 EF                MOV     A,R7
0039 B5051E            CJNE    A,AR5,?C0001
003C EE                MOV     A,R6
003D B5041A            CJNE    A,AR4,?C0001
                                           ; SOURCE LINE # 53
0040 900000      R     MOV     DPTR,#buffer
0043 120000      E     LCALL   ?C?PLDXDATA
0046 900000      R     MOV     DPTR,#num_bytes
0049 E0                MOVX    A,@DPTR
004A FF                MOV     R7,A
004B EF                MOV     A,R7
004C FD                MOV     R5,A
004D 7C00              MOV     R4,#00H
004F 120000      E     LCALL   _USBUART_GetData
                                           ; SOURCE LINE # 54
0052 900000      R     MOV     DPTR,#result
0055 7420              MOV     A,#020H
0057 F0                MOVX    @DPTR,A
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 11  

                                           ; SOURCE LINE # 55
0058 8014              SJMP    ?C0002
005A         ?C0001:
                                           ; SOURCE LINE # 57
005A 900000      R     MOV     DPTR,#count
005D E0                MOVX    A,@DPTR
005E FE                MOV     R6,A
005F A3                INC     DPTR
0060 E0                MOVX    A,@DPTR
0061 FF                MOV     R7,A
0062 D3                SETB    C
0063 EF                MOV     A,R7
0064 9400              SUBB    A,#00H
0066 EE                MOV     A,R6
0067 9400              SUBB    A,#00H
0069 4003              JC      ?C0002
                                           ; SOURCE LINE # 58
006B 120000      E     LCALL   USBUART_GetChar
                                           ; SOURCE LINE # 59
006E         ?C0003:
006E         ?C0002:
                                           ; SOURCE LINE # 61
006E 900000      R     MOV     DPTR,#result
0071 E0                MOVX    A,@DPTR
0072 FF                MOV     R7,A
                                           ; SOURCE LINE # 62
0073         ?C0004:
0073 22                RET     
             ; FUNCTION _retrieve_from_buffer (END)

             ; FUNCTION _send_reply (BEGIN)
                                           ; SOURCE LINE # 64
0000 900000      R     MOV     DPTR,#message
0003 EF                MOV     A,R7
0004 F0                MOVX    @DPTR,A
0005         ?C0005:
                                           ; SOURCE LINE # 69
0005 120000      E     LCALL   USBUART_CDCIsReady
0008 EF                MOV     A,R7
0009 7006              JNZ     ?C0006
000B 120000      E     LCALL   Vbus_Read
000E EF                MOV     A,R7
000F 70F4              JNZ     ?C0005
0011         ?C0006:
                                           ; SOURCE LINE # 71
0011 120000      E     LCALL   Vbus_Read
0014 EF                MOV     A,R7
0015 600D              JZ      ?C0008
                                           ; SOURCE LINE # 72
0017 7B01              MOV     R3,#01H
0019 7A00        R     MOV     R2,#HIGH message
001B 7900        R     MOV     R1,#LOW message
001D 7D01              MOV     R5,#01H
001F 7C00              MOV     R4,#00H
0021 120000      E     LCALL   _USBUART_PutData
                                           ; SOURCE LINE # 73
0024         ?C0007:
                                           ; SOURCE LINE # 76
0024         ?C0008:
0024 22                RET     
             ; FUNCTION _send_reply (END)

C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 12  

             ; FUNCTION send_settings (BEGIN)
                                           ; SOURCE LINE # 78
                                           ; SOURCE LINE # 85
0000 7F00              MOV     R7,#00H
0002 7E00              MOV     R6,#00H
0004 120000      E     LCALL   _get_EEPROM_variable
0007 900000      R     MOV     DPTR,#settings
000A EF                MOV     A,R7
000B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 86
000C 7F01              MOV     R7,#01H
000E 7E00              MOV     R6,#00H
0010 120000      E     LCALL   _get_EEPROM_variable
0013 900000      R     MOV     DPTR,#settings+01H
0016 EF                MOV     A,R7
0017 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 87
0018 7F02              MOV     R7,#02H
001A 7E00              MOV     R6,#00H
001C 120000      E     LCALL   _get_EEPROM_variable
001F 900000      R     MOV     DPTR,#settings+02H
0022 EF                MOV     A,R7
0023 F0                MOVX    @DPTR,A
0024         ?C0009:
                                           ; SOURCE LINE # 89
0024 120000      E     LCALL   USBUART_CDCIsReady
0027 EF                MOV     A,R7
0028 7006              JNZ     ?C0010
002A 120000      E     LCALL   Vbus_Read
002D EF                MOV     A,R7
002E 70F4              JNZ     ?C0009
0030         ?C0010:
                                           ; SOURCE LINE # 91
0030 120000      E     LCALL   Vbus_Read
0033 EF                MOV     A,R7
0034 600D              JZ      ?C0012
                                           ; SOURCE LINE # 92
0036 7B01              MOV     R3,#01H
0038 7A00        R     MOV     R2,#HIGH settings
003A 7900        R     MOV     R1,#LOW settings
003C 7D03              MOV     R5,#03H
003E 7C00              MOV     R4,#00H
0040 120000      E     LCALL   _USBUART_PutData
                                           ; SOURCE LINE # 93
0043         ?C0011:
                                           ; SOURCE LINE # 96
0043         ?C0012:
0043 22                RET     
             ; FUNCTION send_settings (END)

             ; FUNCTION update_settings (BEGIN)
                                           ; SOURCE LINE # 98
                                           ; SOURCE LINE # 105
0000 7F00              MOV     R7,#00H
0002 7E00              MOV     R6,#00H
0004 7D00              MOV     R5,#00H
0006 7C00              MOV     R4,#00H
0008 900000      R     MOV     DPTR,#rows_used
000B 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 106
000E 900000      R     MOV     DPTR,#remainder
0011 E4                CLR     A
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 13  

0012 F0                MOVX    @DPTR,A
0013 A3                INC     DPTR
0014 E4                CLR     A
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 109
0016 900000      R     MOV     DPTR,#i
0019 E4                CLR     A
001A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 110
001B 7F00              MOV     R7,#00H
001D 7E00              MOV     R6,#00H
001F 7D40              MOV     R5,#040H
0021 7C40              MOV     R4,#040H
0023 900000      R     MOV     DPTR,#bytes_used
0026 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 111
0029 900000      R     MOV     DPTR,#result
002C 7420              MOV     A,#020H
002E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 116
002F 7B00              MOV     R3,#00H
0031 7A00              MOV     R2,#00H
0033 7980              MOV     R1,#080H
0035 7841              MOV     R0,#041H
0037 900000      R     MOV     DPTR,#bytes_used
003A 120000      E     LCALL   ?C?LLDXDATA
003D 120000      E     LCALL   ?C?FPDIV
0040 120000      E     LCALL   _ceil
0043 900000      R     MOV     DPTR,#rows_used
0046 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 117
0049 900000      R     MOV     DPTR,#rows_used
004C 120000      E     LCALL   ?C?LLDXDATA
004F 120000      E     LCALL   ?C?CASTF
0052 EF                MOV     A,R7
0053 C4                SWAP    A
0054 F8                MOV     R0,A
0055 540F              ANL     A,#0FH
0057 C8                XCH     A,R0
0058 68                XRL     A,R0
0059 FF                MOV     R7,A
005A EE                MOV     A,R6
005B C4                SWAP    A
005C 54F0              ANL     A,#0F0H
005E 48                ORL     A,R0
005F FE                MOV     R6,A
0060 120000      E     LCALL   _malloc
0063 AA06              MOV     R2,AR6
0065 A907              MOV     R1,AR7
0067 7B01              MOV     R3,#01H
0069 900000      R     MOV     DPTR,#buffer
006C 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 119
006F 900000      R     MOV     DPTR,#buffer
0072 120000      E     LCALL   ?C?PLDXDATA
0075 900000      R     MOV     DPTR,#dst_ptr
0078 120000      E     LCALL   ?C?PSTXDATA
                                           ; SOURCE LINE # 120
007B 7F00              MOV     R7,#00H
007D 7E00              MOV     R6,#00H
007F 7D80              MOV     R5,#080H
0081 7C41              MOV     R4,#041H
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 14  

0083 900000      R     MOV     DPTR,#rows_used
0086 120000      E     LCALL   ?C?LLDXDATA0
0089 120000      E     LCALL   ?C?FPMUL
008C 7B00              MOV     R3,#00H
008E 7A00              MOV     R2,#00H
0090 7940              MOV     R1,#040H
0092 78C0              MOV     R0,#0C0H
0094 120000      E     LCALL   ?C?FPADD
0097 120000      E     LCALL   ?C?CASTF
009A 900000      R     MOV     DPTR,#remainder
009D EE                MOV     A,R6
009E F0                MOVX    @DPTR,A
009F A3                INC     DPTR
00A0 EF                MOV     A,R7
00A1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 123
00A2 900000      R     MOV     DPTR,#i
00A5 E4                CLR     A
00A6 F0                MOVX    @DPTR,A
00A7         ?C0013:
00A7 900000      R     MOV     DPTR,#i
00AA E0                MOVX    A,@DPTR
00AB FF                MOV     R7,A
00AC EF                MOV     A,R7
00AD C3                CLR     C
00AE 9403              SUBB    A,#03H
00B0 5031              JNC     ?C0014
                                           ; SOURCE LINE # 124
00B2 900000      R     MOV     DPTR,#i
00B5 E0                MOVX    A,@DPTR
00B6 FF                MOV     R7,A
00B7 7E00              MOV     R6,#00H
00B9 EF                MOV     A,R7
00BA 2400              ADD     A,#00H
00BC FF                MOV     R7,A
00BD EE                MOV     A,R6
00BE 3480              ADDC    A,#080H
00C0 FE                MOV     R6,A
00C1 8F82              MOV     DPL,R7
00C3 8E83              MOV     DPH,R6
00C5 E0                MOVX    A,@DPTR
00C6 FF                MOV     R7,A
00C7 900000      R     MOV     DPTR,#dst_ptr
00CA 120000      E     LCALL   ?C?PLDXDATA
00CD EF                MOV     A,R7
00CE 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 125
00D1         ?C0015:
00D1 900000      R     MOV     DPTR,#i
00D4 E0                MOVX    A,@DPTR
00D5 04                INC     A
00D6 F0                MOVX    @DPTR,A
00D7 900000      R     MOV     DPTR,#dst_ptr+01H
00DA E4                CLR     A
00DB 75F001            MOV     B,#01H
00DE 120000      E     LCALL   ?C?IILDX
00E1 80C4              SJMP    ?C0013
00E3         ?C0014:
                                           ; SOURCE LINE # 128
00E3 900000      R     MOV     DPTR,#i
00E6 E4                CLR     A
00E7 F0                MOVX    @DPTR,A
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 15  

00E8         ?C0016:
00E8 900000      R     MOV     DPTR,#i
00EB E0                MOVX    A,@DPTR
00EC FF                MOV     R7,A
00ED 7E00              MOV     R6,#00H
00EF 900000      R     MOV     DPTR,#remainder
00F2 E0                MOVX    A,@DPTR
00F3 FC                MOV     R4,A
00F4 A3                INC     DPTR
00F5 E0                MOVX    A,@DPTR
00F6 FD                MOV     R5,A
00F7 C3                CLR     C
00F8 EF                MOV     A,R7
00F9 9D                SUBB    A,R5
00FA EE                MOV     A,R6
00FB 9C                SUBB    A,R4
00FC 501C              JNC     ?C0017
                                           ; SOURCE LINE # 129
00FE 900000      R     MOV     DPTR,#dst_ptr
0101 120000      E     LCALL   ?C?PLDXDATA
0104 E4                CLR     A
0105 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 130
0108         ?C0018:
0108 900000      R     MOV     DPTR,#i
010B E0                MOVX    A,@DPTR
010C 04                INC     A
010D F0                MOVX    @DPTR,A
010E 900000      R     MOV     DPTR,#dst_ptr+01H
0111 E4                CLR     A
0112 75F001            MOV     B,#01H
0115 120000      E     LCALL   ?C?IILDX
0118 80CE              SJMP    ?C0016
011A         ?C0017:
                                           ; SOURCE LINE # 138
011A 900000      R     MOV     DPTR,#new_settings
011D E0                MOVX    A,@DPTR
011E FF                MOV     R7,A
011F 900000      R     MOV     DPTR,#buffer
0122 120000      E     LCALL   ?C?PLDXDATA
0125 EF                MOV     A,R7
0126 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 139
0129 900000      R     MOV     DPTR,#new_settings+01H
012C E0                MOVX    A,@DPTR
012D FF                MOV     R7,A
012E 900000      R     MOV     DPTR,#buffer
0131 120000      E     LCALL   ?C?PLDXDATA
0134 E9                MOV     A,R1
0135 2401              ADD     A,#01H
0137 F9                MOV     R1,A
0138 EA                MOV     A,R2
0139 3400              ADDC    A,#00H
013B FA                MOV     R2,A
013C EF                MOV     A,R7
013D 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 140
0140 900000      R     MOV     DPTR,#new_settings+02H
0143 E0                MOVX    A,@DPTR
0144 FF                MOV     R7,A
0145 900000      R     MOV     DPTR,#buffer
0148 120000      E     LCALL   ?C?PLDXDATA
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 16  

014B E9                MOV     A,R1
014C 2402              ADD     A,#02H
014E F9                MOV     R1,A
014F EA                MOV     A,R2
0150 3400              ADDC    A,#00H
0152 FA                MOV     R2,A
0153 EF                MOV     A,R7
0154 120000      E     LCALL   ?C?CSTPTR
                                           ; SOURCE LINE # 143
0157 9044F4            MOV     DPTR,#044F4H
015A E0                MOVX    A,@DPTR
015B FF                MOV     R7,A
015C EF                MOV     A,R7
015D 4402              ORL     A,#02H
015F FF                MOV     R7,A
0160 EF                MOV     A,R7
0161 F0                MOVX    @DPTR,A
0162 00                NOP     
0163 C2AF              CLR     EA
                                           ; SOURCE LINE # 144
0165 7F00              MOV     R7,#00H
0167 120000      E     LCALL   _Re_EEPROM_EraseSector
016A 900000      R     MOV     DPTR,#status
016D EF                MOV     A,R7
016E F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 145
016F D2AF              SETB    EA
0171 9044F4            MOV     DPTR,#044F4H
0174 74FD              MOV     A,#0FDH
0176 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 147
0177 900000      R     MOV     DPTR,#status
017A E0                MOVX    A,@DPTR
017B FF                MOV     R7,A
017C EF                MOV     A,R7
017D 6009              JZ      ?C0019
                                           ; SOURCE LINE # 148
017F 900000      R     MOV     DPTR,#result
0182 7430              MOV     A,#030H
0184 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 149
0185 020000      R     LJMP    exit
                                           ; SOURCE LINE # 150
0188         ?C0019:
                                           ; SOURCE LINE # 153
0188 900000      R     MOV     DPTR,#i
018B E4                CLR     A
018C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 154
018D 900000      R     MOV     DPTR,#buffer
0190 120000      E     LCALL   ?C?PLDXDATA
0193 900000      R     MOV     DPTR,#src_ptr
0196 120000      E     LCALL   ?C?PSTXDATA
0199         ?C0021:
                                           ; SOURCE LINE # 155
0199 900000      R     MOV     DPTR,#i
019C E0                MOVX    A,@DPTR
019D FC                MOV     R4,A
019E E4                CLR     A
019F 120000      E     LCALL   ?C?FCASTC
01A2 900000      R     MOV     DPTR,#rows_used
01A5 120000      E     LCALL   ?C?LLDXDATA0
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 17  

01A8 120000      E     LCALL   ?C?FPCMP3
01AB 6058              JZ      ?C0022
01AD 4056              JC      ?C0022
01AF 900000      R     MOV     DPTR,#i
01B2 E0                MOVX    A,@DPTR
01B3 FF                MOV     R7,A
01B4 EF                MOV     A,R7
01B5 C3                CLR     C
01B6 9480              SUBB    A,#080H
01B8 504B              JNC     ?C0022
                                           ; SOURCE LINE # 158
01BA 9044F4            MOV     DPTR,#044F4H
01BD E0                MOVX    A,@DPTR
01BE FF                MOV     R7,A
01BF EF                MOV     A,R7
01C0 4402              ORL     A,#02H
01C2 FF                MOV     R7,A
01C3 EF                MOV     A,R7
01C4 F0                MOVX    @DPTR,A
01C5 00                NOP     
01C6 C2AF              CLR     EA
                                           ; SOURCE LINE # 159
01C8 900000      R     MOV     DPTR,#src_ptr
01CB 120000      E     LCALL   ?C?PLDXDATA
01CE 900000      R     MOV     DPTR,#i
01D1 E0                MOVX    A,@DPTR
01D2 FD                MOV     R5,A
01D3 120000      E     LCALL   _Re_EEPROM_Write
01D6 900000      R     MOV     DPTR,#status
01D9 EF                MOV     A,R7
01DA F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 160
01DB D2AF              SETB    EA
01DD 9044F4            MOV     DPTR,#044F4H
01E0 74FD              MOV     A,#0FDH
01E2 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 162
01E3 900000      R     MOV     DPTR,#status
01E6 E0                MOVX    A,@DPTR
01E7 FF                MOV     R7,A
01E8 EF                MOV     A,R7
01E9 6008              JZ      ?C0023
                                           ; SOURCE LINE # 163
01EB 900000      R     MOV     DPTR,#result
01EE 7430              MOV     A,#030H
01F0 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 164
01F1 801F              SJMP    exit
                                           ; SOURCE LINE # 165
01F3         ?C0023:
                                           ; SOURCE LINE # 167
01F3 900000      R     MOV     DPTR,#src_ptr+01H
01F6 E4                CLR     A
01F7 75F010            MOV     B,#010H
01FA 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 168
01FD 900000      R     MOV     DPTR,#i
0200 E0                MOVX    A,@DPTR
0201 04                INC     A
0202 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 169
0203 8094              SJMP    ?C0021
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 18  

0205         ?C0022:
                                           ; SOURCE LINE # 171
0205 900000      R     MOV     DPTR,#buffer
0208 120000      E     LCALL   ?C?PLDXDATA
020B AE02              MOV     R6,AR2
020D AF01              MOV     R7,AR1
020F 120000      E     LCALL   _free
                                           ; SOURCE LINE # 173
0212         exit:
                                           ; SOURCE LINE # 174
0212 900000      R     MOV     DPTR,#result
0215 E0                MOVX    A,@DPTR
0216 FF                MOV     R7,A
                                           ; SOURCE LINE # 175
0217         ?C0024:
0217 22                RET     
             ; FUNCTION update_settings (END)

             ; FUNCTION apply_settings (BEGIN)
                                           ; SOURCE LINE # 177
                                           ; SOURCE LINE # 182
0000 900000      R     MOV     DPTR,#result
0003 7430              MOV     A,#030H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 183
0006 7BFF              MOV     R3,#0FFH
0008 7A00        R     MOV     R2,#HIGH _?ix1000
000A 7900        R     MOV     R1,#LOW _?ix1000
000C C003              PUSH    AR3
000E C002              PUSH    AR2
0010 C001              PUSH    AR1
0012 7B01              MOV     R3,#01H
0014 7A00        R     MOV     R2,#HIGH settings_buffer
0016 7900        R     MOV     R1,#LOW settings_buffer
0018 A801              MOV     R0,AR1
001A AC02              MOV     R4,AR2
001C AD03              MOV     R5,AR3
001E D001              POP     AR1
0020 D002              POP     AR2
0022 D003              POP     AR3
0024 7E00              MOV     R6,#00H
0026 7F03              MOV     R7,#03H
0028 120000      E     LCALL   ?C?COPYAMD
002B         ?C0025:
                                           ; SOURCE LINE # 186
002B 120000      E     LCALL   USBUART_DataIsReady
002E EF                MOV     A,R7
002F 7006              JNZ     ?C0026
0031 120000      E     LCALL   Vbus_Read
0034 EF                MOV     A,R7
0035 70F4              JNZ     ?C0025
0037         ?C0026:
                                           ; SOURCE LINE # 188
0037 120000      E     LCALL   Vbus_Read
003A EF                MOV     A,R7
003B 605B              JZ      ?C0027
                                           ; SOURCE LINE # 189
003D 7B01              MOV     R3,#01H
003F 7A00        R     MOV     R2,#HIGH settings_buffer
0041 7900        R     MOV     R1,#LOW settings_buffer
0043 7D03              MOV     R5,#03H
0045 120000      R     LCALL   _retrieve_from_buffer
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 19  

0048 EF                MOV     A,R7
0049 6420              XRL     A,#020H
004B 704B              JNZ     ?C0027
                                           ; SOURCE LINE # 191
004D 900000      R     MOV     DPTR,#settings_buffer
0050 E0                MOVX    A,@DPTR
0051 FF                MOV     R7,A
0052 900000      R     MOV     DPTR,#new_settings
0055 EF                MOV     A,R7
0056 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 192
0057 900000      R     MOV     DPTR,#settings_buffer+01H
005A E0                MOVX    A,@DPTR
005B FF                MOV     R7,A
005C 900000      R     MOV     DPTR,#new_settings+01H
005F EF                MOV     A,R7
0060 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 193
0061 900000      R     MOV     DPTR,#settings_buffer+02H
0064 E0                MOVX    A,@DPTR
0065 FF                MOV     R7,A
0066 900000      R     MOV     DPTR,#new_settings+02H
0069 EF                MOV     A,R7
006A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 195
006B 7B01              MOV     R3,#01H
006D 7A00        R     MOV     R2,#HIGH new_settings
006F 7900        R     MOV     R1,#LOW new_settings
0071 C003              PUSH    AR3
0073 C002              PUSH    AR2
0075 C001              PUSH    AR1
0077 7B01              MOV     R3,#01H
0079 7A00        R     MOV     R2,#HIGH ?update_settings?BYTE
007B 7900        R     MOV     R1,#LOW ?update_settings?BYTE
007D A801              MOV     R0,AR1
007F AC02              MOV     R4,AR2
0081 AD03              MOV     R5,AR3
0083 D001              POP     AR1
0085 D002              POP     AR2
0087 D003              POP     AR3
0089 7E00              MOV     R6,#00H
008B 7F03              MOV     R7,#03H
008D 120000      E     LCALL   ?C?COPYAMD
0090 120000      R     LCALL   update_settings
0093 900000      R     MOV     DPTR,#result
0096 EF                MOV     A,R7
0097 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 196
0098         ?C0028:
                                           ; SOURCE LINE # 197
0098         ?C0027:
                                           ; SOURCE LINE # 199
0098 900000      R     MOV     DPTR,#result
009B E0                MOVX    A,@DPTR
009C FF                MOV     R7,A
                                           ; SOURCE LINE # 200
009D         ?C0029:
009D 22                RET     
             ; FUNCTION apply_settings (END)

             ; FUNCTION _load_buffer (BEGIN)
                                           ; SOURCE LINE # 202
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 20  

0000 900000      R     MOV     DPTR,#export_buffer
0003 120000      E     LCALL   ?C?PSTXDATA
0006         ?C0030:
                                           ; SOURCE LINE # 210
0006 120000      E     LCALL   USBUART_CDCIsReady
0009 EF                MOV     A,R7
000A 7006              JNZ     ?C0031
000C 120000      E     LCALL   Vbus_Read
000F EF                MOV     A,R7
0010 70F4              JNZ     ?C0030
0012         ?C0031:
                                           ; SOURCE LINE # 211
0012 900000      R     MOV     DPTR,#export_buffer
0015 120000      E     LCALL   ?C?PLDXDATA
0018 7D40              MOV     R5,#040H
001A 7C00              MOV     R4,#00H
001C 120000      E     LCALL   _USBUART_PutData
001F         ?C0032:
                                           ; SOURCE LINE # 214
001F 120000      E     LCALL   USBUART_CDCIsReady
0022 EF                MOV     A,R7
0023 7006              JNZ     ?C0033
0025 120000      E     LCALL   Vbus_Read
0028 EF                MOV     A,R7
0029 70F4              JNZ     ?C0032
002B         ?C0033:
                                           ; SOURCE LINE # 215
002B 900000      R     MOV     DPTR,#export_buffer
002E 120000      E     LCALL   ?C?PLDXDATA
0031 7D00              MOV     R5,#00H
0033 7C00              MOV     R4,#00H
0035 120000      E     LCALL   _USBUART_PutData
                                           ; SOURCE LINE # 218
0038         ?C0034:
0038 22                RET     
             ; FUNCTION _load_buffer (END)

             ; FUNCTION wait_for_continue (BEGIN)
                                           ; SOURCE LINE # 220
                                           ; SOURCE LINE # 226
0000 900000      R     MOV     DPTR,#reply
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 227
0005 900000      R     MOV     DPTR,#retrieve_from_buffer_status
0008 E4                CLR     A
0009 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 228
000A 900000      R     MOV     DPTR,#continue_status
000D 7430              MOV     A,#030H
000F F0                MOVX    @DPTR,A
0010         ?C0035:
                                           ; SOURCE LINE # 230
0010 900000      R     MOV     DPTR,#reply
0013 E0                MOVX    A,@DPTR
0014 FF                MOV     R7,A
0015 EF                MOV     A,R7
0016 7050              JNZ     ?C0036
0018 120000      E     LCALL   Vbus_Read
001B EF                MOV     A,R7
001C 604A              JZ      ?C0036
001E         ?C0037:
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 21  

                                           ; SOURCE LINE # 232
001E 120000      E     LCALL   USBUART_GetCount
0021 EF                MOV     A,R7
0022 4E                ORL     A,R6
0023 7006              JNZ     ?C0038
0025 120000      E     LCALL   Vbus_Read
0028 EF                MOV     A,R7
0029 70F3              JNZ     ?C0037
002B         ?C0038:
                                           ; SOURCE LINE # 233
002B 7B01              MOV     R3,#01H
002D 7A00        R     MOV     R2,#HIGH reply
002F 7900        R     MOV     R1,#LOW reply
0031 7D01              MOV     R5,#01H
0033 120000      R     LCALL   _retrieve_from_buffer
0036 900000      R     MOV     DPTR,#retrieve_from_buffer_status
0039 EF                MOV     A,R7
003A F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 235
003B 900000      R     MOV     DPTR,#retrieve_from_buffer_status
003E E0                MOVX    A,@DPTR
003F FF                MOV     R7,A
0040 EF                MOV     A,R7
0041 B42013            CJNE    A,#020H,?C0039
0044 900000      R     MOV     DPTR,#reply
0047 E0                MOVX    A,@DPTR
0048 FF                MOV     R7,A
0049 EF                MOV     A,R7
004A B4070A            CJNE    A,#07H,?C0039
                                           ; SOURCE LINE # 236
004D 900000      R     MOV     DPTR,#continue_status
0050 7420              MOV     A,#020H
0052 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 237
0053 8013              SJMP    ?C0036
                                           ; SOURCE LINE # 238
0055 80B9              SJMP    ?C0035
0057         ?C0039:
                                           ; SOURCE LINE # 240
0057 900000      R     MOV     DPTR,#retrieve_from_buffer_status
005A E0                MOVX    A,@DPTR
005B FF                MOV     R7,A
005C EF                MOV     A,R7
005D B420B0            CJNE    A,#020H,?C0035
                                           ; SOURCE LINE # 241
0060 900000      R     MOV     DPTR,#continue_status
0063 7430              MOV     A,#030H
0065 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 242
0066         ?C0041:
0066         ?C0040:
                                           ; SOURCE LINE # 243
0066 80A8              SJMP    ?C0035
0068         ?C0036:
                                           ; SOURCE LINE # 245
0068 900000      R     MOV     DPTR,#continue_status
006B E0                MOVX    A,@DPTR
006C FF                MOV     R7,A
                                           ; SOURCE LINE # 246
006D         ?C0042:
006D 22                RET     
             ; FUNCTION wait_for_continue (END)
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 22  


             ; FUNCTION confirm_export (BEGIN)
                                           ; SOURCE LINE # 248
                                           ; SOURCE LINE # 256
0000 900000      R     MOV     DPTR,#command
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
0005         ?C0043:
                                           ; SOURCE LINE # 258
0005 120000      E     LCALL   Vbus_Read
0008 EF                MOV     A,R7
0009 6047              JZ      ?C0053
000B         ?C0045:
                                           ; SOURCE LINE # 259
000B 120000      E     LCALL   USBUART_DataIsReady
000E EF                MOV     A,R7
000F 7006              JNZ     ?C0046
0011 120000      E     LCALL   Vbus_Read
0014 EF                MOV     A,R7
0015 70F4              JNZ     ?C0045
0017         ?C0046:
                                           ; SOURCE LINE # 261
0017 7B01              MOV     R3,#01H
0019 7A00        R     MOV     R2,#HIGH command
001B 7900        R     MOV     R1,#LOW command
001D 7D01              MOV     R5,#01H
001F 120000      R     LCALL   _retrieve_from_buffer
0022 EF                MOV     A,R7
0023 B420DF            CJNE    A,#020H,?C0043
                                           ; SOURCE LINE # 263
0026 900000      R     MOV     DPTR,#command
0029 E0                MOVX    A,@DPTR
002A FF                MOV     R7,A
002B EF                MOV     A,R7
002C B42006            CJNE    A,#020H,?C0048
                                           ; SOURCE LINE # 264
002F 120000      E     LCALL   clear_samples
                                           ; SOURCE LINE # 265
0032 22                RET     
                                           ; SOURCE LINE # 266
0033 80D0              SJMP    ?C0043
0035         ?C0048:
                                           ; SOURCE LINE # 268
0035 900000      R     MOV     DPTR,#command
0038 E0                MOVX    A,@DPTR
0039 FF                MOV     R7,A
003A EF                MOV     A,R7
003B B40708            CJNE    A,#07H,?C0050
                                           ; SOURCE LINE # 269
003E 7F30              MOV     R7,#030H
0040 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 270
0043 22                RET     
                                           ; SOURCE LINE # 271
0044 80BF              SJMP    ?C0043
0046         ?C0050:
                                           ; SOURCE LINE # 273
0046 900000      R     MOV     DPTR,#command
0049 E0                MOVX    A,@DPTR
004A FF                MOV     R7,A
004B EF                MOV     A,R7
004C B430B6            CJNE    A,#030H,?C0043
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 23  

                                           ; SOURCE LINE # 274
004F 22                RET     
                                           ; SOURCE LINE # 275
0050         ?C0052:
0050         ?C0051:
0050         ?C0049:
                                           ; SOURCE LINE # 276
0050         ?C0047:
                                           ; SOURCE LINE # 277
0050 80B3              SJMP    ?C0043
0052         ?C0044:
                                           ; SOURCE LINE # 280
0052         ?C0053:
0052 22                RET     
             ; FUNCTION confirm_export (END)

             ; FUNCTION export_samples (BEGIN)
                                           ; SOURCE LINE # 282
                                           ; SOURCE LINE # 294
0000 900000      R     MOV     DPTR,#result
0003 7420              MOV     A,#020H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 296
0006 900000      E     MOV     DPTR,#sample_head_index
0009 E0                MOVX    A,@DPTR
000A FE                MOV     R6,A
000B A3                INC     DPTR
000C E0                MOVX    A,@DPTR
000D FF                MOV     R7,A
000E 900000      R     MOV     DPTR,#export_index
0011 EE                MOV     A,R6
0012 F0                MOVX    @DPTR,A
0013 A3                INC     DPTR
0014 EF                MOV     A,R7
0015 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 297
0016 900000      R     MOV     DPTR,#byte_count
0019 E4                CLR     A
001A F0                MOVX    @DPTR,A
001B A3                INC     DPTR
001C E4                CLR     A
001D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 298
001E 900000      R     MOV     DPTR,#i
0021 E4                CLR     A
0022 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 301
0023 900000      E     MOV     DPTR,#sample_tail_index
0026 E0                MOVX    A,@DPTR
0027 FE                MOV     R6,A
0028 A3                INC     DPTR
0029 E0                MOVX    A,@DPTR
002A FF                MOV     R7,A
002B 900000      R     MOV     DPTR,#export_index
002E E0                MOVX    A,@DPTR
002F FC                MOV     R4,A
0030 A3                INC     DPTR
0031 E0                MOVX    A,@DPTR
0032 FD                MOV     R5,A
0033 ED                MOV     A,R5
0034 6F                XRL     A,R7
0035 7002              JNZ     ?C0098
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 24  

0037 EC                MOV     A,R4
0038 6E                XRL     A,R6
0039         ?C0098:
0039 7045              JNZ     ?C0062
003B 900000      E     MOV     DPTR,#mem_full_flag
003E E0                MOVX    A,@DPTR
003F FF                MOV     R7,A
0040 EF                MOV     A,R7
0041 703D              JNZ     ?C0062
                                           ; SOURCE LINE # 302
0043 900000      R     MOV     DPTR,#export_buffer
0046 74A0              MOV     A,#0A0H
0048 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 304
0049 900000      R     MOV     DPTR,#i
004C 7401              MOV     A,#01H
004E F0                MOVX    @DPTR,A
004F         ?C0055:
004F 900000      R     MOV     DPTR,#i
0052 E0                MOVX    A,@DPTR
0053 FF                MOV     R7,A
0054 EF                MOV     A,R7
0055 C3                CLR     C
0056 9440              SUBB    A,#040H
0058 501A              JNC     ?C0056
                                           ; SOURCE LINE # 305
005A 900000      R     MOV     DPTR,#i
005D E0                MOVX    A,@DPTR
005E FF                MOV     R7,A
005F 7400        R     MOV     A,#LOW export_buffer
0061 2F                ADD     A,R7
0062 F582              MOV     DPL,A
0064 E4                CLR     A
0065 3400        R     ADDC    A,#HIGH export_buffer
0067 F583              MOV     DPH,A
0069 7440              MOV     A,#040H
006B F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 306
006C         ?C0057:
006C 900000      R     MOV     DPTR,#i
006F E0                MOVX    A,@DPTR
0070 04                INC     A
0071 F0                MOVX    @DPTR,A
0072 80DB              SJMP    ?C0055
0074         ?C0056:
                                           ; SOURCE LINE # 307
0074 7B01              MOV     R3,#01H
0076 7A00        R     MOV     R2,#HIGH export_buffer
0078 7900        R     MOV     R1,#LOW export_buffer
007A 120000      R     LCALL   _load_buffer
                                           ; SOURCE LINE # 309
007D 020000      R     LJMP    exit
                                           ; SOURCE LINE # 310
0080         ?C0054:
0080         ?C0061:
                                           ; SOURCE LINE # 314
0080         ?C0062:
                                           ; SOURCE LINE # 316
0080 900000      R     MOV     DPTR,#i
0083 E0                MOVX    A,@DPTR
0084 FF                MOV     R7,A
0085 EF                MOV     A,R7
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 25  

0086 C3                CLR     C
0087 9440              SUBB    A,#040H
0089 4003              JC      $ + 5H
008B 020000      R     LJMP    ?C0063
                                           ; SOURCE LINE # 317
                                           ; SOURCE LINE # 318
008E 900000      R     MOV     DPTR,#export_index
0091 E0                MOVX    A,@DPTR
0092 FE                MOV     R6,A
0093 A3                INC     DPTR
0094 E0                MOVX    A,@DPTR
0095 FF                MOV     R7,A
0096 7400        E     MOV     A,#LOW sample_block
0098 2F                ADD     A,R7
0099 F582              MOV     DPL,A
009B 7400        E     MOV     A,#HIGH sample_block
009D 3E                ADDC    A,R6
009E F583              MOV     DPH,A
00A0 E4                CLR     A
00A1 93                MOVC    A,@A+DPTR
00A2 FF                MOV     R7,A
00A3 900000      R     MOV     DPTR,#i
00A6 E0                MOVX    A,@DPTR
00A7 FE                MOV     R6,A
00A8 7400        R     MOV     A,#LOW export_buffer
00AA 2E                ADD     A,R6
00AB F582              MOV     DPL,A
00AD E4                CLR     A
00AE 3400        R     ADDC    A,#HIGH export_buffer
00B0 F583              MOV     DPH,A
00B2 EF                MOV     A,R7
00B3 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 319
00B4 900000      R     MOV     DPTR,#i
00B7 E0                MOVX    A,@DPTR
00B8 04                INC     A
00B9 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 320
00BA 900000      R     MOV     DPTR,#export_index
00BD E4                CLR     A
00BE 75F001            MOV     B,#01H
00C1 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 321
00C4 900000      R     MOV     DPTR,#byte_count
00C7 E4                CLR     A
00C8 75F001            MOV     B,#01H
00CB 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 325
00CE 900000      R     MOV     DPTR,#export_index
00D1 E0                MOVX    A,@DPTR
00D2 FE                MOV     R6,A
00D3 A3                INC     DPTR
00D4 E0                MOVX    A,@DPTR
00D5 FF                MOV     R7,A
00D6 C3                CLR     C
00D7 EF                MOV     A,R7
00D8 94A8              SUBB    A,#0A8H
00DA EE                MOV     A,R6
00DB 9461              SUBB    A,#061H
00DD 4008              JC      ?C0064
                                           ; SOURCE LINE # 326
00DF 900000      R     MOV     DPTR,#export_index
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 26  

00E2 E4                CLR     A
00E3 F0                MOVX    @DPTR,A
00E4 A3                INC     DPTR
00E5 E4                CLR     A
00E6 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 327
00E7         ?C0064:
                                           ; SOURCE LINE # 331
00E7 900000      E     MOV     DPTR,#sample_tail_index
00EA E0                MOVX    A,@DPTR
00EB FE                MOV     R6,A
00EC A3                INC     DPTR
00ED E0                MOVX    A,@DPTR
00EE FF                MOV     R7,A
00EF 900000      R     MOV     DPTR,#export_index
00F2 E0                MOVX    A,@DPTR
00F3 FC                MOV     R4,A
00F4 A3                INC     DPTR
00F5 E0                MOVX    A,@DPTR
00F6 FD                MOV     R5,A
00F7 ED                MOV     A,R5
00F8 6F                XRL     A,R7
00F9 7002              JNZ     ?C0099
00FB EC                MOV     A,R4
00FC 6E                XRL     A,R6
00FD         ?C0099:
00FD 7081              JNZ     ?C0062
                                           ; SOURCE LINE # 332
00FF 900000      R     MOV     DPTR,#i
0102 E0                MOVX    A,@DPTR
0103 FF                MOV     R7,A
0104 7400        R     MOV     A,#LOW export_buffer
0106 2F                ADD     A,R7
0107 F582              MOV     DPL,A
0109 E4                CLR     A
010A 3400        R     ADDC    A,#HIGH export_buffer
010C F583              MOV     DPH,A
010E 7440              MOV     A,#040H
0110 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 333
0111 8003              SJMP    ?C0063
                                           ; SOURCE LINE # 334
0113         ?C0065:
                                           ; SOURCE LINE # 335
0113 020000      R     LJMP    ?C0062
0116         ?C0063:
                                           ; SOURCE LINE # 338
0116 7B01              MOV     R3,#01H
0118 7A00        R     MOV     R2,#HIGH export_buffer
011A 7900        R     MOV     R1,#LOW export_buffer
011C 120000      R     LCALL   _load_buffer
                                           ; SOURCE LINE # 339
011F 900000      R     MOV     DPTR,#i
0122 E4                CLR     A
0123 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 342
0124 120000      R     LCALL   wait_for_continue
0127 EF                MOV     A,R7
0128 B43008            CJNE    A,#030H,?C0059
                                           ; SOURCE LINE # 343
012B 900000      R     MOV     DPTR,#result
012E 7430              MOV     A,#030H
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 27  

0130 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 344
0131 805B              SJMP    exit
                                           ; SOURCE LINE # 345
0133         ?C0066:
                                           ; SOURCE LINE # 346
0133         ?C0059:
0133 900000      E     MOV     DPTR,#sample_tail_index
0136 E0                MOVX    A,@DPTR
0137 FE                MOV     R6,A
0138 A3                INC     DPTR
0139 E0                MOVX    A,@DPTR
013A FF                MOV     R7,A
013B 900000      R     MOV     DPTR,#export_index
013E E0                MOVX    A,@DPTR
013F FC                MOV     R4,A
0140 A3                INC     DPTR
0141 E0                MOVX    A,@DPTR
0142 FD                MOV     R5,A
0143 ED                MOV     A,R5
0144 6F                XRL     A,R7
0145 7002              JNZ     ?C0100
0147 EC                MOV     A,R4
0148 6E                XRL     A,R6
0149         ?C0100:
0149 6003              JZ      $ + 5H
014B 020000      R     LJMP    ?C0062
014E         ?C0060:
                                           ; SOURCE LINE # 350
014E 900000      R     MOV     DPTR,#byte_count
0151 E4                CLR     A
0152 75F004            MOV     B,#04H
0155 120000      E     LCALL   ?C?IILDX
                                           ; SOURCE LINE # 353
0158 900000      R     MOV     DPTR,#export_buffer
015B 7480              MOV     A,#080H
015D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 354
015E 900000      R     MOV     DPTR,#export_buffer+01H
0161 E4                CLR     A
0162 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 358
0163 900000      R     MOV     DPTR,#byte_count
0166 E0                MOVX    A,@DPTR
0167 FE                MOV     R6,A
0168 A3                INC     DPTR
0169 E0                MOVX    A,@DPTR
016A FF                MOV     R7,A
016B EE                MOV     A,R6
016C FF                MOV     R7,A
016D 7E00              MOV     R6,#00H
016F 900000      R     MOV     DPTR,#export_buffer+02H
0172 EF                MOV     A,R7
0173 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 359
0174 900000      R     MOV     DPTR,#byte_count
0177 E0                MOVX    A,@DPTR
0178 FE                MOV     R6,A
0179 A3                INC     DPTR
017A E0                MOVX    A,@DPTR
017B FF                MOV     R7,A
017C EF                MOV     A,R7
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 28  

017D 54FF              ANL     A,#0FFH
017F FF                MOV     R7,A
0180 900000      R     MOV     DPTR,#export_buffer+03H
0183 EF                MOV     A,R7
0184 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 361
0185 7B01              MOV     R3,#01H
0187 7A00        R     MOV     R2,#HIGH export_buffer
0189 7900        R     MOV     R1,#LOW export_buffer
018B 120000      R     LCALL   _load_buffer
                                           ; SOURCE LINE # 363
018E         exit:
                                           ; SOURCE LINE # 365
018E 900000      R     MOV     DPTR,#result
0191 E0                MOVX    A,@DPTR
0192 FF                MOV     R7,A
                                           ; SOURCE LINE # 366
0193         ?C0067:
0193 22                RET     
             ; FUNCTION export_samples (END)

             ; FUNCTION update_RTC (BEGIN)
                                           ; SOURCE LINE # 368
                                           ; SOURCE LINE # 374
0000 900000      R     MOV     DPTR,#result
0003 7430              MOV     A,#030H
0005 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 375
0006 7BFF              MOV     R3,#0FFH
0008 7A00        R     MOV     R2,#HIGH _?ix1001
000A 7900        R     MOV     R1,#LOW _?ix1001
000C C003              PUSH    AR3
000E C002              PUSH    AR2
0010 C001              PUSH    AR1
0012 7B01              MOV     R3,#01H
0014 7A00        R     MOV     R2,#HIGH time_buffer
0016 7900        R     MOV     R1,#LOW time_buffer
0018 A801              MOV     R0,AR1
001A AC02              MOV     R4,AR2
001C AD03              MOV     R5,AR3
001E D001              POP     AR1
0020 D002              POP     AR2
0022 D003              POP     AR3
0024 7E00              MOV     R6,#00H
0026 7F07              MOV     R7,#07H
0028 120000      E     LCALL   ?C?COPYAMD
002B         ?C0068:
                                           ; SOURCE LINE # 378
002B 120000      E     LCALL   USBUART_DataIsReady
002E EF                MOV     A,R7
002F 7006              JNZ     ?C0069
0031 120000      E     LCALL   Vbus_Read
0034 EF                MOV     A,R7
0035 70F4              JNZ     ?C0068
0037         ?C0069:
                                           ; SOURCE LINE # 380
0037 120000      E     LCALL   Vbus_Read
003A EF                MOV     A,R7
003B 7003              JNZ     $ + 5H
003D 020000      R     LJMP    ?C0070
                                           ; SOURCE LINE # 381
0040 7B01              MOV     R3,#01H
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 29  

0042 7A00        R     MOV     R2,#HIGH time_buffer
0044 7900        R     MOV     R1,#LOW time_buffer
0046 7D07              MOV     R5,#07H
0048 120000      R     LCALL   _retrieve_from_buffer
004B EF                MOV     A,R7
004C 6420              XRL     A,#020H
004E 7071              JNZ     ?C0070
                                           ; SOURCE LINE # 382
0050 900000      R     MOV     DPTR,#time_buffer
0053 E0                MOVX    A,@DPTR
0054 FF                MOV     R7,A
0055 7E00              MOV     R6,#00H
0057 EF                MOV     A,R7
0058 7F00              MOV     R7,#00H
005A FE                MOV     R6,A
005B 900000      R     MOV     DPTR,#new_time+08H
005E EE                MOV     A,R6
005F F0                MOVX    @DPTR,A
0060 A3                INC     DPTR
0061 EF                MOV     A,R7
0062 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 383
0063 900000      R     MOV     DPTR,#time_buffer+01H
0066 E0                MOVX    A,@DPTR
0067 FF                MOV     R7,A
0068 7E00              MOV     R6,#00H
006A 900000      R     MOV     DPTR,#new_time+08H
006D E0                MOVX    A,@DPTR
006E FC                MOV     R4,A
006F A3                INC     DPTR
0070 E0                MOVX    A,@DPTR
0071 FD                MOV     R5,A
0072 EE                MOV     A,R6
0073 4C                ORL     A,R4
0074 FE                MOV     R6,A
0075 EF                MOV     A,R7
0076 4D                ORL     A,R5
0077 FF                MOV     R7,A
0078 900000      R     MOV     DPTR,#new_time+08H
007B EE                MOV     A,R6
007C F0                MOVX    @DPTR,A
007D A3                INC     DPTR
007E EF                MOV     A,R7
007F F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 384
0080 900000      R     MOV     DPTR,#time_buffer+02H
0083 E0                MOVX    A,@DPTR
0084 FF                MOV     R7,A
0085 900000      R     MOV     DPTR,#new_time
0088 EF                MOV     A,R7
0089 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 385
008A 900000      R     MOV     DPTR,#time_buffer+03H
008D E0                MOVX    A,@DPTR
008E FF                MOV     R7,A
008F 900000      R     MOV     DPTR,#new_time+01H
0092 EF                MOV     A,R7
0093 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 386
0094 900000      R     MOV     DPTR,#time_buffer+04H
0097 E0                MOVX    A,@DPTR
0098 FF                MOV     R7,A
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 30  

0099 900000      R     MOV     DPTR,#new_time+02H
009C EF                MOV     A,R7
009D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 387
009E 900000      R     MOV     DPTR,#time_buffer+05H
00A1 E0                MOVX    A,@DPTR
00A2 FF                MOV     R7,A
00A3 900000      R     MOV     DPTR,#new_time+04H
00A6 EF                MOV     A,R7
00A7 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 388
00A8 900000      R     MOV     DPTR,#time_buffer+06H
00AB E0                MOVX    A,@DPTR
00AC FF                MOV     R7,A
00AD 900000      R     MOV     DPTR,#new_time+07H
00B0 EF                MOV     A,R7
00B1 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 390
00B2 7B01              MOV     R3,#01H
00B4 7A00        R     MOV     R2,#HIGH new_time
00B6 7900        R     MOV     R1,#LOW new_time
00B8 120000      E     LCALL   _RTC_WriteTime
                                           ; SOURCE LINE # 392
00BB 900000      R     MOV     DPTR,#result
00BE 7420              MOV     A,#020H
00C0 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 393
00C1         ?C0071:
                                           ; SOURCE LINE # 394
00C1         ?C0070:
                                           ; SOURCE LINE # 396
00C1 900000      R     MOV     DPTR,#result
00C4 E0                MOVX    A,@DPTR
00C5 FF                MOV     R7,A
                                           ; SOURCE LINE # 397
00C6         ?C0072:
00C6 22                RET     
             ; FUNCTION update_RTC (END)

             ; FUNCTION USB_Close (BEGIN)
                                           ; SOURCE LINE # 399
                                           ; SOURCE LINE # 405
0000 120000      E     LCALL   USBUART_Stop
                                           ; SOURCE LINE # 406
0003 120000      E     LCALL   Vbus_ClearInterrupt
                                           ; SOURCE LINE # 407
0006 120000      E     LCALL   Vbus_IRQ_ClearPending
                                           ; SOURCE LINE # 408
0009 120000      E     LCALL   clear_button_interrupts
                                           ; SOURCE LINE # 409
000C 900000      E     MOV     DPTR,#USB_waiting
000F E4                CLR     A
0010 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 412
0011 120000      E     LCALL   sampling_setup
                                           ; SOURCE LINE # 415
0014 120000      E     LCALL   ModifyCollection_IRQ_Start
                                           ; SOURCE LINE # 416
0017 120000      E     LCALL   Vbus_IRQ_Start
                                           ; SOURCE LINE # 419
001A         ?C0073:
001A 22                RET     
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 31  

             ; FUNCTION USB_Close (END)

             ; FUNCTION Run_USB (BEGIN)
                                           ; SOURCE LINE # 421
                                           ; SOURCE LINE # 429
0000 900000      R     MOV     DPTR,#result
0003 E4                CLR     A
0004 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 430
0005 900000      R     MOV     DPTR,#command
0008 E4                CLR     A
0009 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 432
000A 120000      E     LCALL   stop_collection
                                           ; SOURCE LINE # 433
000D 7F00              MOV     R7,#00H
000F 120000      E     LCALL   _RTC_WriteIntervalMask
                                           ; SOURCE LINE # 434
0012 120000      E     LCALL   ModifyCollection_IRQ_Stop
                                           ; SOURCE LINE # 435
0015 120000      E     LCALL   Vbus_IRQ_Stop
                                           ; SOURCE LINE # 437
0018 7D01              MOV     R5,#01H
001A 7F00              MOV     R7,#00H
001C 120000      E     LCALL   _USBUART_Start
001F         ?C0074:
                                           ; SOURCE LINE # 440
001F 120000      E     LCALL   USBUART_GetConfiguration
0022 EF                MOV     A,R7
0023 7006              JNZ     ?C0075
0025 120000      E     LCALL   Vbus_Read
0028 EF                MOV     A,R7
0029 70F4              JNZ     ?C0074
002B         ?C0075:
                                           ; SOURCE LINE # 443
002B 120000      E     LCALL   USBUART_CDC_Init
002E         ?C0076:
                                           ; SOURCE LINE # 445
002E 120000      E     LCALL   Vbus_Read
0031 EF                MOV     A,R7
0032 7003              JNZ     $ + 5H
0034 020000      R     LJMP    ?C0077
                                           ; SOURCE LINE # 446
                                           ; SOURCE LINE # 447
0037 120000      E     LCALL   USBUART_DataIsReady
003A EF                MOV     A,R7
003B 60F1              JZ      ?C0076
                                           ; SOURCE LINE # 448
                                           ; SOURCE LINE # 449
003D         ?C0078:
                                           ; SOURCE LINE # 451
003D 7B01              MOV     R3,#01H
003F 7A00        R     MOV     R2,#HIGH command
0041 7900        R     MOV     R1,#LOW command
0043 7D01              MOV     R5,#01H
0045 120000      R     LCALL   _retrieve_from_buffer
0048 900000      R     MOV     DPTR,#result
004B EF                MOV     A,R7
004C F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 454
004D 900000      R     MOV     DPTR,#command
0050 E0                MOVX    A,@DPTR
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 32  

0051 FF                MOV     R7,A
0052 EF                MOV     A,R7
0053 60D9              JZ      ?C0076
                                           ; SOURCE LINE # 455
                                           ; SOURCE LINE # 456
0055         ?C0079:
                                           ; SOURCE LINE # 459
0055 900000      R     MOV     DPTR,#result
0058 E0                MOVX    A,@DPTR
0059 FF                MOV     R7,A
005A EF                MOV     A,R7
005B 6420              XRL     A,#020H
005D 6003              JZ      $ + 5H
005F 020000      R     LJMP    ?C0080
                                           ; SOURCE LINE # 461
0062 900000      R     MOV     DPTR,#command
0065 E0                MOVX    A,@DPTR
0066 FF                MOV     R7,A
0067 EF                MOV     A,R7
0068 120000      E     LCALL   ?C?CCASE
006B 0000        R     DW      ?C0082
006D 01                DB      01H
006E 0000        R     DW      ?C0083
0070 02                DB      02H
0071 0000        R     DW      ?C0086
0073 03                DB      03H
0074 0000        R     DW      ?C0087
0076 04                DB      04H
0077 0000        R     DW      ?C0093
0079 05                DB      05H
007A 0000        R     DW      ?C0090
007C 06                DB      06H
007D 0000              DW      00H
007F 0000        R     DW      ?C0094
                                           ; SOURCE LINE # 463
0081         ?C0082:
                                           ; SOURCE LINE # 464
0081 7F10              MOV     R7,#010H
0083 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 465
0086 80A6              SJMP    ?C0076
                                           ; SOURCE LINE # 467
0088         ?C0083:
                                           ; SOURCE LINE # 468
0088 120000      R     LCALL   export_samples
008B EF                MOV     A,R7
008C 6005              JZ      ?C0084
                                           ; SOURCE LINE # 469
008E 120000      R     LCALL   confirm_export
                                           ; SOURCE LINE # 470
0091 809B              SJMP    ?C0076
0093         ?C0084:
                                           ; SOURCE LINE # 471
                                           ; SOURCE LINE # 472
0093 7F30              MOV     R7,#030H
0095 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 473
0098         ?C0085:
                                           ; SOURCE LINE # 474
0098 8094              SJMP    ?C0076
                                           ; SOURCE LINE # 476
009A         ?C0086:
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 33  

                                           ; SOURCE LINE # 477
009A 120000      R     LCALL   send_settings
                                           ; SOURCE LINE # 478
009D 808F              SJMP    ?C0076
                                           ; SOURCE LINE # 480
009F         ?C0087:
                                           ; SOURCE LINE # 481
009F 7F20              MOV     R7,#020H
00A1 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 482
00A4 120000      R     LCALL   apply_settings
00A7 EF                MOV     A,R7
00A8 B42008            CJNE    A,#020H,?C0088
                                           ; SOURCE LINE # 483
00AB 7F20              MOV     R7,#020H
00AD 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 484
00B0 020000      R     LJMP    ?C0076
00B3         ?C0088:
                                           ; SOURCE LINE # 485
                                           ; SOURCE LINE # 486
00B3 7F30              MOV     R7,#030H
00B5 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 487
00B8         ?C0089:
                                           ; SOURCE LINE # 488
00B8 020000      R     LJMP    ?C0076
                                           ; SOURCE LINE # 490
00BB         ?C0090:
                                           ; SOURCE LINE # 491
00BB 7F20              MOV     R7,#020H
00BD 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 492
00C0 120000      R     LCALL   update_RTC
00C3 EF                MOV     A,R7
00C4 B42008            CJNE    A,#020H,?C0091
                                           ; SOURCE LINE # 493
00C7 7F20              MOV     R7,#020H
00C9 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 494
00CC 020000      R     LJMP    ?C0076
00CF         ?C0091:
                                           ; SOURCE LINE # 495
                                           ; SOURCE LINE # 496
00CF 7F30              MOV     R7,#030H
00D1 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 497
00D4         ?C0092:
                                           ; SOURCE LINE # 498
00D4 020000      R     LJMP    ?C0076
                                           ; SOURCE LINE # 500
00D7         ?C0093:
                                           ; SOURCE LINE # 501
00D7 120000      E     LCALL   reset_pointers
                                           ; SOURCE LINE # 502
00DA 7F20              MOV     R7,#020H
00DC 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 503
00DF 020000      R     LJMP    ?C0076
                                           ; SOURCE LINE # 505
00E2         ?C0094:
                                           ; SOURCE LINE # 506
C51 COMPILER V9.51   USB_HANDLER                                                           06/06/2014 10:37:31 PAGE 34  

00E2 7F30              MOV     R7,#030H
00E4 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 507
00E7 020000      R     LJMP    ?C0076
                                           ; SOURCE LINE # 509
00EA         ?C0081:
                                           ; SOURCE LINE # 511
00EA 020000      R     LJMP    ?C0076
00ED         ?C0080:
                                           ; SOURCE LINE # 513
                                           ; SOURCE LINE # 514
00ED 7F30              MOV     R7,#030H
00EF 120000      R     LCALL   _send_reply
                                           ; SOURCE LINE # 515
00F2         ?C0095:
                                           ; SOURCE LINE # 517
00F2 020000      R     LJMP    ?C0076
00F5         ?C0077:
                                           ; SOURCE LINE # 519
00F5 120000      R     LCALL   USB_Close
                                           ; SOURCE LINE # 522
00F8         ?C0096:
00F8 22                RET     
             ; FUNCTION Run_USB (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2044    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =    141    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
